{% extends 'finance_base.html' %}

{% block title %}TransaÃ§Ãµes Â· NEXUSRDR{% endblock %}

{% block extra_styles %}
<style>
/* ===== NOVO LAYOUT MODERNO ===== */

/* Segmented control (abas) */
.segment-control {
    display: inline-flex;
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 4px;
    gap: 4px;
}

.segment-btn {
    padding: 10px 20px;
    border: none;
    background: transparent;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-secondary);
    transition: all 0.2s ease;
    cursor: pointer;
}

.segment-btn.active {
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.segment-btn:not(.active):hover {
    background: rgba(59, 130, 246, 0.1);
    color: var(--text-primary);
}

/* Transaction item (lista estilo app) */
.tx-item {
    display: flex;
    align-items: center;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 16px;
    margin-bottom: 12px;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    cursor: pointer;
    border: 1px solid transparent;
}

.tx-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    border-color: rgba(59, 130, 246, 0.2);
}

.tx-item:active {
    transform: scale(0.98);
}

.tx-icon {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    margin-right: 14px;
    flex-shrink: 0;
}

.tx-icon.income { background: rgba(16, 185, 129, 0.15); }
.tx-icon.expense { background: rgba(239, 68, 68, 0.15); }

.tx-info { flex: 1; min-width: 0; }
.tx-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; }
.tx-subtitle { font-size: 0.8rem; color: var(--text-secondary); }

.tx-amount { text-align: right; margin-left: 12px; }
.tx-amount-value { font-weight: 700; font-size: 1rem; }
.tx-amount-value.income { color: #10b981; }
.tx-amount-value.expense { color: #ef4444; }
.tx-amount-date { font-size: 0.75rem; color: var(--text-secondary); }

/* Lista scrollÃ¡vel */
.tx-list {
    max-height: calc(100vh - 300px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

/* BotÃµes de aÃ§Ã£o mobile */
.tx-actions {
    display: none;
    gap: 6px;
    margin-left: 8px;
    flex-shrink: 0;
}

.tx-action-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.15s ease;
    cursor: pointer;
}

.tx-action-btn.edit {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
}

.tx-action-btn.delete {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
}

.tx-action-btn:active {
    transform: scale(0.9);
}

/* Mobile */
@media (max-width: 768px) {
    #transactionsViewToggle { display: none !important; }
    .tx-item { 
        padding: 12px; 
        margin-bottom: 8px;
        flex-wrap: wrap;
    }
    .tx-icon { width: 40px; height: 40px; font-size: 1.1rem; }
    .tx-title { font-size: 0.9rem; }
    .tx-amount-value { font-size: 0.9rem; }
    .tx-list { 
        max-height: none;
        padding-bottom: calc(160px + env(safe-area-inset-bottom));
    }
    .tx-actions {
        display: flex;
    }
    .tx-item:hover {
        transform: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" id="transactionsPageRoot">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">TransaÃ§Ãµes</h1>
            <small class="text-muted" id="transactionCount">Carregando...</small>
        </div>
        <div class="d-none d-md-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="window.transactionsPage.showAddTransaction('income')">
                <i class="bi bi-plus-circle me-1"></i>Entrada
            </button>
            <button class="btn btn-danger btn-sm" onclick="window.transactionsPage.showAddTransaction('expense')">
                <i class="bi bi-dash-circle me-1"></i>Despesa
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="segment-control mb-4">
        <button class="segment-btn active" id="tabIncomeTransactions" onclick="filterTransactionsByType('income')">
            <i class="bi bi-arrow-up-circle me-1"></i>Entradas
        </button>
        <button class="segment-btn" id="tabExpenseTransactions" onclick="filterTransactionsByType('expense')">
            <i class="bi bi-arrow-down-circle me-1"></i>SaÃ­das
        </button>
    </div>

    <!-- Filtros -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-end">
                <div class="col-6 col-md-3">
                    <select class="form-select form-select-sm" id="filterType" onchange="applyFilters()">
                        <option value="">Todos tipos</option>
                        <option value="income">Entradas</option>
                        <option value="expense">Despesas</option>
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <select class="form-select form-select-sm" id="filterCategory" onchange="applyFilters()">
                        <option value="">Todas categorias</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <input type="date" class="form-control form-control-sm" id="filterStartDate" onchange="applyFilters()">
                </div>
                <div class="col-6 col-md-2">
                    <input type="date" class="form-control form-control-sm" id="filterEndDate" onchange="applyFilters()">
                </div>
                <div class="col-12 col-md-2">
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                        <i class="bi bi-x-circle me-1"></i>Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingTransactions" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Carregando...</p>
    </div>

    <!-- Lista de TransaÃ§Ãµes (mobile-first) -->
    <div id="txListContainer" class="tx-list d-none"></div>

    <!-- Table View (desktop) -->
    <div id="tableViewContainer" class="d-none">
        <div class="card">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <span>HistÃ³rico</span>
                <div class="btn-group btn-group-sm" id="transactionsViewToggle">
                    <input type="radio" class="btn-check" name="viewMode" id="tableView" checked>
                    <label class="btn btn-outline-primary btn-sm" for="tableView"><i class="bi bi-table"></i></label>
                    <input type="radio" class="btn-check" name="viewMode" id="cardView">
                    <label class="btn btn-outline-primary btn-sm" for="cardView"><i class="bi bi-grid"></i></label>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>DescriÃ§Ã£o</th>
                            <th>Categoria</th>
                            <th>ObservaÃ§Ãµes</th>
                            <th class="text-end">Valor</th>
                            <th width="100">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Card View -->
    <div id="cardViewContainer" class="d-none">
        <div class="row" id="transactionsCardContainer"></div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5 d-none">
        <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
        <h6 class="text-muted mt-3">Nenhuma transaÃ§Ã£o</h6>
        <p class="text-muted small">Adicione sua primeira transaÃ§Ã£o</p>
    </div>

    <!-- Pagination -->
    <div id="paginationContainer" class="d-flex justify-content-center mt-3 d-none">
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item" id="prevPage">
                    <button class="page-link" onclick="loadPage(currentPage - 1)"><i class="bi bi-chevron-left"></i></button>
                </li>
                <li class="page-item active">
                    <span class="page-link" id="currentPageInfo">1</span>
                </li>
                <li class="page-item" id="nextPage">
                    <button class="page-link" onclick="loadPage(currentPage + 1)"><i class="bi bi-chevron-right"></i></button>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Modal Escopo de EdiÃ§Ã£o -->
<div class="modal fade" id="editScopeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar parcelas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Esta transaÃ§Ã£o faz parte de uma sÃ©rie de parcelas.</p>
                <p class="mb-0">Deseja editar somente esta parcela ou todas as parcelas da sÃ©rie?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-primary" id="editScopeSingleBtn">
                    <i class="bi bi-1-circle me-1"></i>SÃ³ esta parcela
                </button>
                <button type="button" class="btn btn-primary" id="editScopeSeriesBtn">
                    <i class="bi bi-collection me-1"></i>Todas as parcelas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar TransaÃ§Ã£o -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTransactionTitle">Nova TransaÃ§Ã£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addTransactionForm">
                <div class="modal-body">
                    <input type="hidden" id="transactionType">
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">DescriÃ§Ã£o *</label>
                        <input type="text" class="form-control" id="description" required placeholder="Ex: AlmoÃ§o, Pagamento salÃ¡rio...">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Valor (R$) *</label>
                                <input type="text" class="form-control" id="amount" inputmode="decimal" required placeholder="0,00" autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="transactionDate" class="form-label">Data *</label>
                                <input type="date" class="form-control" id="transactionDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category" class="form-label">Categoria</label>
                        <div class="input-group">
                            <select class="form-select" id="category">
                                <option value="">Selecione uma categoria</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="openCategoriesManager({ typeElId: 'transactionType', selectElId: 'category' });">
                                <i class="bi bi-plus"></i>
                                Nova categoria
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="subcategoryText" class="form-label">Subcategoria</label>
                        <input type="text" class="form-control" id="subcategoryText" placeholder="Digite a subcategoria" autocomplete="off">
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">ObservaÃ§Ãµes</label>
                        <input type="text" class="form-control" id="notes" placeholder="InformaÃ§Ãµes adicionais (opcional)">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveButton">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        Salvar TransaÃ§Ã£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables
window.transactionsPage = window.transactionsPage || {};
let currentPage = 1;
let totalPages = 1;
let currentEditingId = null;
let allCategories = [];
let pendingCategoryId = null;
let pendingCategoryLabel = null;
let currentEditScope = 'single';
let __editScopeResolve = null;

// Edit scope modal helper
function _chooseEditScope() {
    const scopeEl = document.getElementById('editScopeModal');
    if (!scopeEl) return Promise.resolve('single');
    const modal = bootstrap.Modal.getOrCreateInstance(scopeEl);
    return new Promise((resolve) => {
        __editScopeResolve = resolve;
        modal.show();
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    setupAmountMask();
    loadAllCategories();
    // Set default filter to 'income' (Entradas)
    document.getElementById('filterType').value = 'income';

    try {
        if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
            const table = document.getElementById('tableView');
            if (table) table.checked = true;
            switchToTableView();
        }
    } catch (e) {}

    loadTransactions();
    
    // View mode switch
    document.getElementById('tableView').addEventListener('change', switchToTableView);
    document.getElementById('cardView').addEventListener('change', switchToCardView);
    
    // Edit scope modal buttons
    const scopeEl = document.getElementById('editScopeModal');
    const singleBtn = document.getElementById('editScopeSingleBtn');
    const seriesBtn = document.getElementById('editScopeSeriesBtn');
    if (scopeEl && singleBtn && seriesBtn) {
        singleBtn.addEventListener('click', () => {
            bootstrap.Modal.getInstance(scopeEl)?.hide();
            if (__editScopeResolve) __editScopeResolve('single');
            __editScopeResolve = null;
        });
        seriesBtn.addEventListener('click', () => {
            bootstrap.Modal.getInstance(scopeEl)?.hide();
            if (__editScopeResolve) __editScopeResolve('series');
            __editScopeResolve = null;
        });
        scopeEl.addEventListener('hidden.bs.modal', () => {
            if (__editScopeResolve) __editScopeResolve(null);
            __editScopeResolve = null;
        });
    }
});

// Load categories for filters
async function loadAllCategories() {
    try {
        const response = await fetch(`{{ url_for("gerenciamento_financeiro.api_categories") }}?_ts=${Date.now()}`, { cache: 'no-store', credentials: 'include' });
        const data = await response.json();
        allCategories = data.categories || [];
        
        const select = document.getElementById('filterCategory');
        select.innerHTML = '<option value="">Todas</option>';
        
        allCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = `${cat.icon || 'ðŸ’°'} ${cat.name}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

// Load transactions
async function loadTransactions(page = 1) {
    currentPage = page;
    
    showElement('loadingTransactions');
    hideElement('tableViewContainer');
    hideElement('cardViewContainer');
    hideElement('emptyState');
    hideElement('paginationContainer');
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 20
        });
        
        // Add filters
        const type = document.getElementById('filterType').value;
        const category = document.getElementById('filterCategory').value;
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        if (type) params.append('type', type);
        if (category) params.append('category_id', category);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        
        params.append('_ts', Date.now());
        const response = await fetch(`{{ url_for("gerenciamento_financeiro.api_transactions") }}?${params}`, { cache: 'no-store', credentials: 'include' });
        const data = await response.json();
        
        hideElement('loadingTransactions');
        
        if (data.transactions && data.transactions.length > 0) {
            displayTransactions(data.transactions);
            updatePagination(data.pagination);
            document.getElementById('transactionCount').textContent = `${data.pagination.total} transaÃ§Ãµes encontradas`;
        } else {
            showElement('emptyState');
            document.getElementById('transactionCount').textContent = '0 transaÃ§Ãµes encontradas';
        }
        
    } catch (error) {
        console.error('Erro ao carregar transaÃ§Ãµes:', error);
        hideElement('loadingTransactions');
        showElement('emptyState');
        showToast('Erro ao carregar transaÃ§Ãµes', 'error');
    }
}

// Display transactions
function displayTransactions(transactions) {
    // Mobile: usar lista estilo app
    const isMobile = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
    
    if (isMobile) {
        displayMobileList(transactions);
        return;
    }
    
    // Desktop: tabela ou cards
    const isTableView = document.getElementById('tableView').checked;
    if (isTableView) {
        displayTableView(transactions);
    } else {
        displayCardView(transactions);
    }
}

// Table view
function displayTableView(transactions) {
    const tbody = document.getElementById('transactionsTableBody');
    
    tbody.innerHTML = transactions.map(t => {
        const categoryIcon = t.category?.icon || (t.type === 'income' ? 'ðŸ’°' : 'ðŸ’¸');
        const categoryColor = t.category?.color || '#6366f1';
        const categoryName = t.category?.name || 'Sem categoria';
        const parentCategoryName = t.category?.name || '';
        const subText = t.subcategory_text || '';
        
        return `
        <tr>
            <td class="d-none d-md-table-cell">
                <div class="fw-semibold">${new Date(t.transaction_date).toLocaleDateString('pt-BR')}</div>
            </td>
            <td>
                <div class="fw-semibold">${t.description}</div>
                <small class="text-muted d-md-none">
                    ${new Date(t.transaction_date).toLocaleDateString('pt-BR')}
                    ${parentCategoryName ? ' Â· ' + parentCategoryName : ''}
                </small>
                ${t.is_fixed ? '<small class="badge bg-info ms-2">Fixo</small>' : ''}
            </td>
            <td class="d-none d-lg-table-cell">
                <span class="badge rounded-pill" style="background-color: ${categoryColor}20; color: ${categoryColor};">
                    ${categoryIcon} ${categoryName}
                </span>
                ${subText ? `<span class="badge bg-secondary ms-2">ðŸ“Œ ${subText}</span>` : ''}
            </td>
            <td class="d-none d-md-table-cell">
                <small class="text-muted">${t.notes || '-'}</small>
            </td>
            <td class="text-end">
                <span class="fw-bold text-${t.type === 'income' ? 'success' : 'danger'}">
                    ${t.type === 'income' ? '+' : '-'}R$ ${Number(t.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                </span>
            </td>
            <td class="d-none d-md-table-cell">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm" onclick="window.transactionsPage.editTransaction(${t.id})" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="window.transactionsPage.deleteTransaction(${t.id})" title="Excluir">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
    
    showElement('tableViewContainer');
}

// Card view
function displayCardView(transactions) {
    const container = document.getElementById('transactionsCardContainer');
    
    container.innerHTML = transactions.map(t => {
        const categoryIcon = t.category?.icon || (t.type === 'income' ? 'ðŸ’°' : 'ðŸ’¸');
        const categoryColor = t.category?.color || '#6366f1';
        const categoryName = t.category?.name || 'Sem categoria';
        const parentCategoryName = t.category?.name || '';
        const subText = t.subcategory_text || '';
        
        return `
        <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div style="flex: 1;">
                            <h6 class="card-title mb-1">${t.description}</h6>
                            <small class="text-muted">${parentCategoryName ? parentCategoryName : ''}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="window.transactionsPage.editTransaction(${t.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="window.transactionsPage.deleteTransaction(${t.id})" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <span class="badge rounded-pill" style="background-color: ${categoryColor}20; color: ${categoryColor}; font-size: 0.95rem; padding: 0.5rem 0.75rem;">
                            ${categoryIcon} ${categoryName}
                        </span>
                        ${subText ? `<span class="badge bg-secondary ms-2">ðŸ“Œ ${subText}</span>` : ''}
                    </div>
                    
                    <div class="mb-2">
                        <span class="fw-bold text-${t.type === 'income' ? 'success' : 'danger'}" style="font-size: 1.1rem;">
                            ${t.type === 'income' ? '+' : '-'}R$ ${Number(t.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            ${new Date(t.transaction_date).toLocaleDateString('pt-BR')}
                        </small>
                    </div>
                    
                    ${t.notes ? `<small class="text-muted d-block mt-2">${t.notes}</small>` : ''}
                    ${t.is_fixed ? '<small class="badge bg-info mt-2">Recorrente</small>' : ''}
                </div>
            </div>
        </div>
        `;
    }).join('');
    
    showElement('cardViewContainer');
}

// View switching
function switchToTableView() {
    if (document.getElementById('transactionsTableBody').children.length > 0) {
        hideElement('cardViewContainer');
        showElement('tableViewContainer');
    }
}

function switchToCardView() {
    if (document.getElementById('transactionsCardContainer').children.length > 0) {
        hideElement('tableViewContainer');
        showElement('cardViewContainer');
    }
}

// Pagination
function updatePagination(pagination) {
    totalPages = pagination.pages;
    
    if (totalPages <= 1) {
        hideElement('paginationContainer');
        return;
    }
    
    document.getElementById('currentPageInfo').textContent = `PÃ¡gina ${pagination.page} de ${totalPages}`;
    
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (pagination.has_prev) {
        prevBtn.classList.remove('disabled');
    } else {
        prevBtn.classList.add('disabled');
    }
    
    if (pagination.has_next) {
        nextBtn.classList.remove('disabled');
    } else {
        nextBtn.classList.add('disabled');
    }
    
    showElement('paginationContainer');
}

function loadPage(page) {
    if (page >= 1 && page <= totalPages) {
        loadTransactions(page);
    }
}

// Filters
function applyFilters() {
    loadTransactions(1);
}

function clearFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    loadTransactions(1);
}

// Helper functions
function showElement(id) {
    document.getElementById(id).classList.remove('d-none');
    document.getElementById(id).style.display = 'block';
}

function hideElement(id) {
    document.getElementById(id).classList.add('d-none');
    document.getElementById(id).style.display = 'none';
}

function parseBRL(value) {
    const s = String(value ?? '').trim();
    if (!s) return 0;
    const cleaned = s.replace(/[^0-9,.-]/g, '');
    if (!cleaned) return 0;
    if (cleaned.includes(',')) {
        const parts = cleaned.split(',');
        const dec = (parts.pop() || '').replace(/\./g, '').replace(/[^0-9]/g, '');
        const intPart = parts.join('').replace(/\./g, '').replace(/[^0-9-]/g, '');
        const numStr = `${intPart || '0'}.${dec}`;
        const n = parseFloat(numStr);
        return Number.isFinite(n) ? n : 0;
    }
    const numStr = cleaned.replace(/\./g, '');
    const n = parseFloat(numStr);
    return Number.isFinite(n) ? n : 0;
}

function setupAmountMask() {
    const el = document.getElementById('amount');
    if (!el) return;
    if (el.dataset.masked === '1') return;
    el.dataset.masked = '1';

    const handler = () => {
        const digits = el.value.replace(/\D/g, '');
        if (!digits) {
            el.value = '';
            return;
        }
        const n = Number(digits) / 100;
        el.value = n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        try { el.setSelectionRange(el.value.length, el.value.length); } catch (e) {}
    };

    el.addEventListener('input', handler);
    el.addEventListener('blur', handler);
}

function setCategoryValue(categoryId) {
    const select = document.getElementById('category');
    if (!select) return;

    if (!categoryId) {
        select.value = '';
        pendingCategoryId = null;
        pendingCategoryLabel = null;
        return;
    }

    const target = String(categoryId);
    const exists = Array.from(select.options).some(opt => String(opt.value) === target);
    if (exists) {
        select.value = target;
        pendingCategoryId = null;
        pendingCategoryLabel = null;
    } else {
        if (pendingCategoryLabel) {
            const option = document.createElement('option');
            option.value = target;
            option.textContent = pendingCategoryLabel;
            select.appendChild(option);
            select.value = target;
            pendingCategoryId = null;
            pendingCategoryLabel = null;
        } else {
            pendingCategoryId = target;
        }
    }
}

// Include transaction modal functions from dashboard
// (Same functions: showAddTransaction, loadCategories, editTransaction, deleteTransaction, form submit handler)

// Show add transaction modal
window.transactionsPage.showAddTransaction = function(type, options = {}) {
    const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    const title = document.getElementById('addTransactionTitle');
    const typeInput = document.getElementById('transactionType');
    const saveButton = document.getElementById('saveButton');
    
    // Reset form
    document.getElementById('addTransactionForm').reset();
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    setupAmountMask();
    if (!options.keepEditingId) {
        currentEditingId = null;
    }
    
    // Configure for type
    typeInput.value = type;
    
    if (type === 'income') {
        title.innerHTML = '<i class="bi bi-plus-circle text-success me-2"></i>Nova Entrada';
        saveButton.className = 'btn btn-success';
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Entrada';
    } else {
        title.innerHTML = '<i class="bi bi-dash-circle text-danger me-2"></i>Nova Despesa';
        saveButton.className = 'btn btn-danger';
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Despesa';
    }
    
    // Load categories
    loadCategories(type);
    
    modal.show();
}

// Load categories for transaction
async function loadCategories(type) {
    try {
        const response = await fetch(`{{ url_for("gerenciamento_financeiro.api_categories") }}?type=${type}&_ts=${Date.now()}`, { cache: 'no-store', credentials: 'include' });
        const data = await response.json();
        
        const select = document.getElementById('category');
        select.innerHTML = '<option value="">Selecione uma categoria</option>';
        
        if (data.categories && Array.isArray(data.categories)) {
            data.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.icon || 'ðŸ’°'} ${cat.name}`;
                select.appendChild(option);
            });
        }

        if (pendingCategoryId) {
            setCategoryValue(pendingCategoryId);
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
        showToast('Erro ao carregar categorias', 'error');
    }
}

// Handle form submission
document.getElementById('addTransactionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const button = document.getElementById('saveButton');
    const spinner = button.querySelector('.spinner-border');
    
    button.disabled = true;
    spinner.classList.remove('d-none');
    
    const formData = {
        type: document.getElementById('transactionType').value,
        description: document.getElementById('description').value,
        amount: parseBRL(document.getElementById('amount').value),
        transaction_date: document.getElementById('transactionDate').value,
        category_id: document.getElementById('category').value || null,
        subcategory_text: document.getElementById('subcategoryText') ? (document.getElementById('subcategoryText').value || '').trim() || null : null,
        notes: document.getElementById('notes').value || null,
        apply_scope: currentEditScope
    };
    
    try {
        let url = '{{ url_for("gerenciamento_financeiro.api_transactions") }}';
        let method = 'POST';
        
        if (currentEditingId) {
            url += `/${currentEditingId}`;
            method = 'PUT';
        }
        
        const response = await fetch(`${url}?_ts=${Date.now()}`, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            cache: 'no-store',
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
            showToast(
                currentEditingId 
                    ? 'TransaÃ§Ã£o atualizada com sucesso! ðŸŽ‰'
                    : `${formData.type === 'income' ? 'Entrada' : 'Despesa'} registrada com sucesso! ðŸŽ‰`, 
                'success'
            );
            loadTransactions(currentPage); // Reload current page
        } else {
            showToast(result.error || 'Erro ao salvar transaÃ§Ã£o', 'error');
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
        showToast('Erro ao salvar transaÃ§Ã£o', 'error');
    } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
    }
});

// Edit transaction
window.transactionsPage.editTransaction = async function(id) {
    try {
        showLoading('Carregando transaÃ§Ã£o...');
        // Fetch transaction data
        const response = await fetch(`{{ url_for("gerenciamento_financeiro.api_transactions") }}/${id}?_ts=${Date.now()}`, { cache: 'no-store', credentials: 'include' });
        const data = await response.json();
        const transaction = data.transaction;
        
        if (!transaction) {
            hideLoading();
            showToast('TransaÃ§Ã£o nÃ£o encontrada', 'error');
            return;
        }
        
        // Hide loading before showing scope modal
        hideLoading();
        
        // Check if this is an installment (part of a series)
        const isInstallment = transaction.is_fixed || transaction.is_recurring;
        if (isInstallment) {
            const scope = await _chooseEditScope();
            if (!scope) return;
            currentEditScope = scope;
        } else {
            currentEditScope = 'single';
        }
        
        // Set editing mode FIRST
        currentEditingId = id;
        
        // Prepare category selection
        pendingCategoryId = transaction.category?.id || transaction.category_id || null;
        pendingCategoryLabel = transaction.category
            ? `${transaction.category.icon || 'ðŸ’°'} ${transaction.category.name}`
            : null;
        
        // Get modal elements
        const modalEl = document.getElementById('addTransactionModal');
        const title = document.getElementById('addTransactionTitle');
        const typeInput = document.getElementById('transactionType');
        const saveButton = document.getElementById('saveButton');
        
        // Configure modal for EDIT mode (not "Nova")
        typeInput.value = transaction.type;
        title.innerHTML = `<i class="bi bi-pencil me-2"></i>Editar ${transaction.type === 'income' ? 'Entrada' : 'Despesa'}`;
        
        if (transaction.type === 'income') {
            saveButton.className = 'btn btn-success';
        } else {
            saveButton.className = 'btn btn-danger';
        }
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Atualizar TransaÃ§Ã£o';
        
        // Fill form fields with transaction data
        document.getElementById('description').value = transaction.description || '';
        document.getElementById('amount').value = (typeof transaction.amount === 'number')
            ? transaction.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            : String(transaction.amount || '');
        document.getElementById('transactionDate').value = transaction.transaction_date;
        document.getElementById('notes').value = transaction.notes || '';
        
        // Setup mask
        setupAmountMask();
        
        // Load categories (async) - will apply pendingCategoryId when done
        loadCategories(transaction.type);
        
        // Also try to set category immediately if options already exist
        setCategoryValue(pendingCategoryId);
        
        // Hide loading and show modal
        hideLoading();
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        
    } catch (error) {
        console.error('Erro ao carregar transaÃ§Ã£o:', error);
        showToast('Erro ao carregar transaÃ§Ã£o', 'error');
        hideLoading();
    }
}

// Delete transaction
window.transactionsPage.deleteTransaction = async function(id) {
    try {
        let tx = null;
        try {
            const r = await fetch(`{{ url_for("gerenciamento_financeiro.api_transactions") }}/${id}?_ts=${Date.now()}`, { cache: 'no-store', credentials: 'include' });
            const d = await r.json();
            if (r.ok && d && d.transaction) tx = d.transaction;
        } catch (e) {
            // ignore
        }

        const isRecurring = !!(tx && (tx.recurring_transaction_id || tx.is_fixed || tx.is_recurring));
        let applyScope = 'single';

        if (isRecurring && typeof window._chooseDeleteScope === 'function') {
            const scope = await window._chooseDeleteScope();
            if (!scope) return;
            applyScope = scope;
        }

        const body = (applyScope === 'series')
            ? 'Esta transaÃ§Ã£o Ã© recorrente. Deseja excluir TODAS as ocorrÃªncias desta recorrÃªncia?'
            : 'Deseja realmente excluir esta transaÃ§Ã£o?';

        const ok = (window._openConfirmModal)
            ? await window._openConfirmModal({
                title: 'Excluir transaÃ§Ã£o',
                body,
                confirmText: 'Excluir',
                confirmClass: 'btn-danger',
            })
            : window.confirm(body);
        if (!ok) return;

        showLoading();

        const url = (applyScope === 'series')
            ? `{{ url_for("gerenciamento_financeiro.api_transactions") }}/${id}?apply_scope=series`
            : `{{ url_for("gerenciamento_financeiro.api_transactions") }}/${id}`;

        const response = await fetch(`${url}${url.includes('?') ? '&' : '?'}_ts=${Date.now()}`, { method: 'DELETE', cache: 'no-store', credentials: 'include' });
        const result = await response.json();

        if (response.ok) {
            showToast(applyScope === 'series' ? 'RecorrÃªncia excluÃ­da com sucesso!' : 'TransaÃ§Ã£o excluÃ­da com sucesso!', 'success');
            loadTransactions(currentPage);
        } else {
            showToast(result.error || 'Erro ao excluir transaÃ§Ã£o', 'error');
        }
    } catch (error) {
        console.error('Erro ao excluir:', error);
        showToast('Erro ao excluir transaÃ§Ã£o', 'error');
    } finally {
        hideLoading();
    }
}

// Filtro de tipo de transaÃ§Ã£o (Entradas, SaÃ­das)
function filterTransactionsByType(type) {
    // Atualizar seleÃ§Ã£o do filtro de tipo
    const filterType = document.getElementById('filterType');
    if (filterType) {
        filterType.value = type;
    }
    
    // Atualizar estilos das abas (segmented control)
    const tabIncome = document.getElementById('tabIncomeTransactions');
    const tabExpense = document.getElementById('tabExpenseTransactions');
    
    if (tabIncome && tabExpense) {
        tabIncome.classList.remove('active');
        tabExpense.classList.remove('active');
        
        if (type === 'income') {
            tabIncome.classList.add('active');
        } else if (type === 'expense') {
            tabExpense.classList.add('active');
        }
    }
    
    // Aplicar filtros
    applyFilters();
}

// Renderizar lista mobile (tx-list)
function displayMobileList(transactions) {
    const container = document.getElementById('txListContainer');
    if (!container) return;
    
    container.innerHTML = transactions.map(t => {
        const icon = t.subcategory?.icon || t.category?.icon || (t.type === 'income' ? 'ðŸ’°' : 'ðŸ’¸');
        const categoryName = t.subcategory?.name || t.category?.name || 'Sem categoria';
        
        return `
        <div class="tx-item">
            <div class="tx-icon ${t.type}">${icon}</div>
            <div class="tx-info">
                <div class="tx-title">${t.description}</div>
                <div class="tx-subtitle">${categoryName}</div>
            </div>
            <div class="tx-amount">
                <div class="tx-amount-value ${t.type}">${t.type === 'income' ? '+' : '-'}R$ ${Number(t.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="tx-amount-date">${new Date(t.transaction_date).toLocaleDateString('pt-BR')}</div>
            </div>
            <div class="tx-actions">
                <button class="tx-action-btn edit" onclick="event.stopPropagation(); window.transactionsPage.editTransaction(${t.id})" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="tx-action-btn delete" onclick="event.stopPropagation(); window.transactionsPage.deleteTransaction(${t.id})" title="Excluir">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        `;
    }).join('');
    
    showElement('txListContainer');
}
</script>
{% endblock %}