{% extends 'finance_base.html' %}

{% block title %}Transa√ß√µes ¬∑ NEXUSRDR{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
            <div>
                <h1 class="h2 mb-1">Transa√ß√µes</h1>
                <p class="text-muted mb-0">Gerencie seu hist√≥rico financeiro completo</p>
            </div>
            <div class="d-flex gap-2 mt-3 mt-md-0">
                <button class="btn btn-success" onclick="window.transactionsPage.showAddTransaction('income')">
                    <i class="bi bi-plus-circle me-1"></i> Nova Entrada
                </button>
                <button class="btn btn-danger" onclick="window.transactionsPage.showAddTransaction('expense')">
                    <i class="bi bi-dash-circle me-1"></i> Nova Despesa
                </button>
            </div>
        </div>
        
        <!-- Abas: Entradas e Sa√≠das -->
        <div class="d-flex align-items-center gap-2 mb-3" style="border-bottom: 2px solid var(--border-color); padding-bottom: 0;">
            <button class="btn px-4 py-2 fw-semibold transactions-tab active" 
                    id="tabIncomeTransactions" 
                    onclick="filterTransactionsByType('income')"
                    style="border: none; border-bottom: 3px solid #10b981; border-radius: 0; background: transparent; color: #10b981; margin-bottom: -2px;">
                <i class="bi bi-arrow-up-circle me-1"></i>Entradas
            </button>
            <button class="btn px-4 py-2 fw-semibold transactions-tab" 
                    id="tabExpenseTransactions" 
                    onclick="filterTransactionsByType('expense')"
                    style="border: none; border-bottom: 3px solid transparent; border-radius: 0; background: transparent; color: var(--text-secondary); margin-bottom: -2px;">
                <i class="bi bi-arrow-down-circle me-1"></i>Sa√≠das
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form id="filtersForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="filterType" class="form-label">Tipo</label>
                        <select class="form-select" id="filterType" onchange="applyFilters()">
                            <option value="">Todos</option>
                            <option value="income">Entradas</option>
                            <option value="expense">Despesas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterCategory" class="form-label">Categoria</label>
                        <select class="form-select" id="filterCategory" onchange="applyFilters()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterStartDate" class="form-label">Data In√≠cio</label>
                        <input type="date" class="form-control" id="filterStartDate" onchange="applyFilters()">
                    </div>
                    <div class="col-md-2">
                        <label for="filterEndDate" class="form-label">Data Fim</label>
                        <input type="date" class="form-control" id="filterEndDate" onchange="applyFilters()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Lista de Transa√ß√µes -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-title mb-1">Hist√≥rico de Transa√ß√µes</h6>
                    <small class="text-muted" id="transactionCount">Carregando...</small>
                </div>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="viewMode" id="tableView" checked>
                    <label class="btn btn-outline-primary btn-sm" for="tableView">
                        <i class="bi bi-table"></i>
                    </label>
                    <input type="radio" class="btn-check" name="viewMode" id="cardView">
                    <label class="btn btn-outline-primary btn-sm" for="cardView">
                        <i class="bi bi-grid-3x3"></i>
                    </label>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Loading -->
                <div id="loadingTransactions" class="text-center py-5">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-2 text-muted">Carregando transa√ß√µes...</p>
                </div>
                
                <!-- Table View -->
                <div id="tableViewContainer" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="d-none d-md-table-cell">Data</th>
                                    <th>Descri√ß√£o</th>
                                    <th class="d-none d-lg-table-cell">Categoria</th>
                                    <th class="d-none d-md-table-cell">Observa√ß√µes</th>
                                    <th class="text-end">Valor</th>
                                    <th width="100" class="d-none d-md-table-cell">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- Transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Card View -->
                <div id="cardViewContainer" class="d-none p-3">
                    <div class="row" id="transactionsCardContainer">
                        <!-- Cards will be loaded here -->
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5 d-none">
                    <i class="bi bi-receipt text-muted" style="font-size: 3rem;"></i>
                    <h6 class="text-muted mt-3">Nenhuma transa√ß√£o encontrada</h6>
                    <p class="text-muted mb-3">Ajuste os filtros ou adicione uma nova transa√ß√£o</p>
                    <button class="btn btn-primary" onclick="window.transactionsPage.showAddTransaction('income')">
                        <i class="bi bi-plus me-1"></i> Nova Transa√ß√£o
                    </button>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="card-footer bg-transparent" id="paginationContainer" style="display: none;">
                <nav>
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <li class="page-item" id="prevPage">
                            <button class="page-link" onclick="loadPage(currentPage - 1)">
                                <i class="bi bi-chevron-left"></i> Anterior
                            </button>
                        </li>
                        <li class="page-item active">
                            <span class="page-link" id="currentPageInfo">P√°gina 1</span>
                        </li>
                        <li class="page-item" id="nextPage">
                            <button class="page-link" onclick="loadPage(currentPage + 1)">
                                Pr√≥ximo <i class="bi bi-chevron-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Search/Filter Quick Actions Mobile -->
<div class="d-md-none quick-actions">
    <button class="btn btn-primary" onclick="document.getElementById('filterType').focus()">
        <i class="bi bi-funnel"></i> Filtros
    </button>
    <button class="btn btn-success" onclick="window.transactionsPage.showAddTransaction('income')">
        <i class="bi bi-plus-circle"></i> Entrada
    </button>
    <button class="btn btn-danger" onclick="window.transactionsPage.showAddTransaction('expense')">
        <i class="bi bi-dash-circle"></i> Despesa
    </button>
</div>

<!-- Modal Escolha de Escopo de Edi√ß√£o -->
<div class="modal fade" id="editScopeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Editar parcelas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Esta transa√ß√£o faz parte de uma s√©rie de parcelas.</p>
                <p class="mb-0">Deseja editar somente esta parcela ou todas as parcelas da s√©rie?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-primary" id="editScopeSingleBtn">
                    <i class="bi bi-1-circle me-1"></i>S√≥ esta parcela
                </button>
                <button type="button" class="btn btn-primary" id="editScopeSeriesBtn">
                    <i class="bi bi-collection me-1"></i>Todas as parcelas
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include the add transaction modal from dashboard -->
<!-- Modal Adicionar Transa√ß√£o -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTransactionTitle">Nova Transa√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addTransactionForm">
                <div class="modal-body">
                    <input type="hidden" id="transactionType">
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Descri√ß√£o *</label>
                        <input type="text" class="form-control" id="description" required placeholder="Ex: Almo√ßo, Pagamento sal√°rio...">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Valor (R$) *</label>
                                <input type="text" class="form-control" id="amount" inputmode="decimal" required placeholder="0,00" autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="transactionDate" class="form-label">Data *</label>
                                <input type="date" class="form-control" id="transactionDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category" class="form-label">Categoria</label>
                        <div class="input-group">
                            <select class="form-select" id="category">
                                <option value="">Selecione uma categoria</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="openCategoriesManager({ typeElId: 'transactionType', selectElId: 'category' });">
                                <i class="bi bi-plus"></i>
                                Nova categoria
                            </button>
                        </div>
                    </div>

                    <div class="mb-3" id="subcategoryField" style="display: none;">
                        <label for="subcategory" class="form-label">Subcategoria</label>
                        <div class="input-group">
                            <select class="form-select" id="subcategory">
                                <option value="">Selecione uma subcategoria</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="openSubcategoriesManager({ categorySelectId: 'category', subcategorySelectId: 'subcategory' });">
                                <i class="bi bi-plus"></i>
                                Nova subcategoria
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Observa√ß√µes</label>
                        <input type="text" class="form-control" id="notes" placeholder="Informa√ß√µes adicionais (opcional)">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveButton">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        Salvar Transa√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables
window.transactionsPage = window.transactionsPage || {};
let currentPage = 1;
let totalPages = 1;
let currentEditingId = null;
let allCategories = [];
let pendingCategoryId = null;
let pendingCategoryLabel = null;
let currentEditScope = 'single';
let __editScopeResolve = null;

// Edit scope modal helper
function _chooseEditScope() {
    const scopeEl = document.getElementById('editScopeModal');
    if (!scopeEl) return Promise.resolve('single');
    const modal = bootstrap.Modal.getOrCreateInstance(scopeEl);
    return new Promise((resolve) => {
        __editScopeResolve = resolve;
        modal.show();
    });
}

// Load subcategories for modal
async function loadSubcategoriesModal(categoryId) {
    const subField = document.getElementById('subcategoryField');
    const subSelect = document.getElementById('subcategory');
    if (!categoryId) {
        subField.style.display = 'none';
        subSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        return;
    }
    try {
        const r = await fetch(`{{ url_for('gerenciamento_financeiro.api_subcategories') }}?category_id=${categoryId}`);
        const d = await r.json();
        if (!r.ok || !d.subcategories || d.subcategories.length === 0) {
            subField.style.display = 'none';
            subSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
            return;
        }
        subField.style.display = 'block';
        subSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        d.subcategories.forEach(s => {
            const o = document.createElement('option');
            o.value = s.id;
            o.textContent = `${s.icon || 'üìå'} ${s.name}`;
            subSelect.appendChild(o);
        });
    } catch (e) {
        console.error('Erro ao carregar subcategorias:', e);
        subField.style.display = 'none';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    setupAmountMask();
    loadAllCategories();
    // Set default filter to 'income' (Entradas)
    document.getElementById('filterType').value = 'income';
    loadTransactions();
    
    // View mode switch
    document.getElementById('tableView').addEventListener('change', switchToTableView);
    document.getElementById('cardView').addEventListener('change', switchToCardView);
    
    // Category change listener for subcategories
    const catSelect = document.getElementById('category');
    if (catSelect) {
        catSelect.addEventListener('change', (e) => {
            loadSubcategoriesModal(e.target.value);
        });
    }
    
    // Edit scope modal buttons
    const scopeEl = document.getElementById('editScopeModal');
    const singleBtn = document.getElementById('editScopeSingleBtn');
    const seriesBtn = document.getElementById('editScopeSeriesBtn');
    if (scopeEl && singleBtn && seriesBtn) {
        singleBtn.addEventListener('click', () => {
            bootstrap.Modal.getInstance(scopeEl)?.hide();
            if (__editScopeResolve) __editScopeResolve('single');
            __editScopeResolve = null;
        });
        seriesBtn.addEventListener('click', () => {
            bootstrap.Modal.getInstance(scopeEl)?.hide();
            if (__editScopeResolve) __editScopeResolve('series');
            __editScopeResolve = null;
        });
        scopeEl.addEventListener('hidden.bs.modal', () => {
            if (__editScopeResolve) __editScopeResolve(null);
            __editScopeResolve = null;
        });
    }
});

// Load categories for filters
async function loadAllCategories() {
    try {
        const response = await fetch('{{ url_for("gerenciamento_financeiro.api_categories") }}');
        const data = await response.json();
        allCategories = data.categories || [];
        
        const select = document.getElementById('filterCategory');
        select.innerHTML = '<option value="">Todas</option>';
        
        allCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = `${cat.icon || 'üí∞'} ${cat.name}`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

// Load transactions
async function loadTransactions(page = 1) {
    currentPage = page;
    
    showElement('loadingTransactions');
    hideElement('tableViewContainer');
    hideElement('cardViewContainer');
    hideElement('emptyState');
    hideElement('paginationContainer');
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 20
        });
        
        // Add filters
        const type = document.getElementById('filterType').value;
        const category = document.getElementById('filterCategory').value;
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        
        if (type) params.append('type', type);
        if (category) params.append('category_id', category);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        
        const response = await fetch(`{{ url_for("gerenciamento_financeiro.api_transactions") }}?${params}`);
        const data = await response.json();
        
        hideElement('loadingTransactions');
        
        if (data.transactions && data.transactions.length > 0) {
            displayTransactions(data.transactions);
            updatePagination(data.pagination);
            document.getElementById('transactionCount').textContent = `${data.pagination.total} transa√ß√µes encontradas`;
        } else {
            showElement('emptyState');
            document.getElementById('transactionCount').textContent = '0 transa√ß√µes encontradas';
        }
        
    } catch (error) {
        console.error('Erro ao carregar transa√ß√µes:', error);
        hideElement('loadingTransactions');
        showElement('emptyState');
        showToast('Erro ao carregar transa√ß√µes', 'error');
    }
}

// Display transactions
function displayTransactions(transactions) {
    const isTableView = document.getElementById('tableView').checked;
    
    if (isTableView) {
        displayTableView(transactions);
    } else {
        displayCardView(transactions);
    }
}

// Table view
function displayTableView(transactions) {
    const tbody = document.getElementById('transactionsTableBody');
    
    tbody.innerHTML = transactions.map(t => {
        const categoryIcon = t.subcategory?.icon || t.category?.icon || (t.type === 'income' ? 'üí∞' : 'üí∏');
        const categoryColor = t.subcategory?.color || t.category?.color || '#6366f1';
        const categoryName = t.subcategory?.name || t.category?.name || 'Sem categoria';
        const parentCategoryName = t.category?.name || '';
        
        return `
        <tr>
            <td class="d-none d-md-table-cell">
                <div class="fw-semibold">${new Date(t.transaction_date).toLocaleDateString('pt-BR')}</div>
            </td>
            <td>
                <div class="fw-semibold">${t.description}</div>
                <small class="text-muted d-md-none">
                    ${new Date(t.transaction_date).toLocaleDateString('pt-BR')}
                    ${parentCategoryName ? ' ¬∑ ' + parentCategoryName : ''}
                </small>
                ${t.is_fixed ? '<small class="badge bg-info ms-2">Fixo</small>' : ''}
            </td>
            <td class="d-none d-lg-table-cell">
                <span class="badge rounded-pill" style="background-color: ${categoryColor}20; color: ${categoryColor};">
                    ${categoryIcon} ${categoryName}
                </span>
            </td>
            <td class="d-none d-md-table-cell">
                <small class="text-muted">${t.notes || '-'}</small>
            </td>
            <td class="text-end">
                <span class="fw-bold text-${t.type === 'income' ? 'success' : 'danger'}">
                    ${t.type === 'income' ? '+' : '-'}R$ ${Number(t.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                </span>
            </td>
            <td class="d-none d-md-table-cell">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm" onclick="window.transactionsPage.editTransaction(${t.id})" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="window.transactionsPage.deleteTransaction(${t.id})" title="Excluir">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
    
    showElement('tableViewContainer');
}

// Card view
function displayCardView(transactions) {
    const container = document.getElementById('transactionsCardContainer');
    
    container.innerHTML = transactions.map(t => {
        const categoryIcon = t.subcategory?.icon || t.category?.icon || (t.type === 'income' ? 'üí∞' : 'üí∏');
        const categoryColor = t.subcategory?.color || t.category?.color || '#6366f1';
        const categoryName = t.subcategory?.name || t.category?.name || 'Sem categoria';
        const parentCategoryName = t.category?.name || '';
        
        return `
        <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div style="flex: 1;">
                            <h6 class="card-title mb-1">${t.description}</h6>
                            <small class="text-muted">${parentCategoryName ? parentCategoryName : ''}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="window.transactionsPage.editTransaction(${t.id})" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="window.transactionsPage.deleteTransaction(${t.id})" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <span class="badge rounded-pill" style="background-color: ${categoryColor}20; color: ${categoryColor}; font-size: 0.95rem; padding: 0.5rem 0.75rem;">
                            ${categoryIcon} ${categoryName}
                        </span>
                    </div>
                    
                    <div class="mb-2">
                        <span class="fw-bold text-${t.type === 'income' ? 'success' : 'danger'}" style="font-size: 1.1rem;">
                            ${t.type === 'income' ? '+' : '-'}R$ ${Number(t.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            ${new Date(t.transaction_date).toLocaleDateString('pt-BR')}
                        </small>
                    </div>
                    
                    ${t.notes ? `<small class="text-muted d-block mt-2">${t.notes}</small>` : ''}
                    ${t.is_fixed ? '<small class="badge bg-info mt-2">Recorrente</small>' : ''}
                </div>
            </div>
        </div>
        `;
    }).join('');
    
    showElement('cardViewContainer');
}

// View switching
function switchToTableView() {
    if (document.getElementById('transactionsTableBody').children.length > 0) {
        hideElement('cardViewContainer');
        showElement('tableViewContainer');
    }
}

function switchToCardView() {
    if (document.getElementById('transactionsCardContainer').children.length > 0) {
        hideElement('tableViewContainer');
        showElement('cardViewContainer');
    }
}

// Pagination
function updatePagination(pagination) {
    totalPages = pagination.pages;
    
    if (totalPages <= 1) {
        hideElement('paginationContainer');
        return;
    }
    
    document.getElementById('currentPageInfo').textContent = `P√°gina ${pagination.page} de ${totalPages}`;
    
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (pagination.has_prev) {
        prevBtn.classList.remove('disabled');
    } else {
        prevBtn.classList.add('disabled');
    }
    
    if (pagination.has_next) {
        nextBtn.classList.remove('disabled');
    } else {
        nextBtn.classList.add('disabled');
    }
    
    showElement('paginationContainer');
}

function loadPage(page) {
    if (page >= 1 && page <= totalPages) {
        loadTransactions(page);
    }
}

// Filters
function applyFilters() {
    loadTransactions(1);
}

function clearFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    loadTransactions(1);
}

// Helper functions
function showElement(id) {
    document.getElementById(id).classList.remove('d-none');
    document.getElementById(id).style.display = 'block';
}

function hideElement(id) {
    document.getElementById(id).classList.add('d-none');
    document.getElementById(id).style.display = 'none';
}

function parseBRL(value) {
    const s = String(value ?? '').trim();
    if (!s) return 0;
    const cleaned = s.replace(/[^0-9,.-]/g, '');
    if (!cleaned) return 0;
    if (cleaned.includes(',')) {
        const parts = cleaned.split(',');
        const dec = (parts.pop() || '').replace(/\./g, '').replace(/[^0-9]/g, '');
        const intPart = parts.join('').replace(/\./g, '').replace(/[^0-9-]/g, '');
        const numStr = `${intPart || '0'}.${dec}`;
        const n = parseFloat(numStr);
        return Number.isFinite(n) ? n : 0;
    }
    const numStr = cleaned.replace(/\./g, '');
    const n = parseFloat(numStr);
    return Number.isFinite(n) ? n : 0;
}

function setupAmountMask() {
    const el = document.getElementById('amount');
    if (!el) return;
    if (el.dataset.masked === '1') return;
    el.dataset.masked = '1';

    const handler = () => {
        const digits = el.value.replace(/\D/g, '');
        if (!digits) {
            el.value = '';
            return;
        }
        const n = Number(digits) / 100;
        el.value = n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        try { el.setSelectionRange(el.value.length, el.value.length); } catch (e) {}
    };

    el.addEventListener('input', handler);
    el.addEventListener('blur', handler);
}

function setCategoryValue(categoryId) {
    const select = document.getElementById('category');
    if (!select) return;

    if (!categoryId) {
        select.value = '';
        pendingCategoryId = null;
        pendingCategoryLabel = null;
        return;
    }

    const target = String(categoryId);
    const exists = Array.from(select.options).some(opt => String(opt.value) === target);
    if (exists) {
        select.value = target;
        pendingCategoryId = null;
        pendingCategoryLabel = null;
    } else {
        if (pendingCategoryLabel) {
            const option = document.createElement('option');
            option.value = target;
            option.textContent = pendingCategoryLabel;
            select.appendChild(option);
            select.value = target;
            pendingCategoryId = null;
            pendingCategoryLabel = null;
        } else {
            pendingCategoryId = target;
        }
    }
}

// Include transaction modal functions from dashboard
// (Same functions: showAddTransaction, loadCategories, editTransaction, deleteTransaction, form submit handler)

// Show add transaction modal
window.transactionsPage.showAddTransaction = function(type, options = {}) {
    const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    const title = document.getElementById('addTransactionTitle');
    const typeInput = document.getElementById('transactionType');
    const saveButton = document.getElementById('saveButton');
    
    // Reset form
    document.getElementById('addTransactionForm').reset();
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    setupAmountMask();
    if (!options.keepEditingId) {
        currentEditingId = null;
    }
    
    // Configure for type
    typeInput.value = type;
    
    if (type === 'income') {
        title.innerHTML = '<i class="bi bi-plus-circle text-success me-2"></i>Nova Entrada';
        saveButton.className = 'btn btn-success';
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Entrada';
    } else {
        title.innerHTML = '<i class="bi bi-dash-circle text-danger me-2"></i>Nova Despesa';
        saveButton.className = 'btn btn-danger';
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Despesa';
    }
    
    // Load categories
    loadCategories(type);
    
    // Setup subcategory listener
    const catSelect = document.getElementById('category');
    if (catSelect) {
        catSelect.removeEventListener('change', loadSubcategoriesModal);
        catSelect.addEventListener('change', (e) => {
            loadSubcategoriesModal(e.target.value);
        });
    }
    
    modal.show();
}

// Load categories for transaction
async function loadCategories(type) {
    try {
        const response = await fetch(`{{ url_for("gerenciamento_financeiro.api_categories") }}?type=${type}`);
        const data = await response.json();
        
        const select = document.getElementById('category');
        select.innerHTML = '<option value="">Selecione uma categoria</option>';
        
        if (data.categories && Array.isArray(data.categories)) {
            data.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.icon || 'üí∞'} ${cat.name}`;
                select.appendChild(option);
            });
        }

        if (pendingCategoryId) {
            setCategoryValue(pendingCategoryId);
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
        showToast('Erro ao carregar categorias', 'error');
    }
}

// Handle form submission
document.getElementById('addTransactionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const button = document.getElementById('saveButton');
    const spinner = button.querySelector('.spinner-border');
    
    button.disabled = true;
    spinner.classList.remove('d-none');
    
    const formData = {
        type: document.getElementById('transactionType').value,
        description: document.getElementById('description').value,
        amount: parseBRL(document.getElementById('amount').value),
        transaction_date: document.getElementById('transactionDate').value,
        category_id: document.getElementById('category').value || null,
        subcategory_id: document.getElementById('subcategory').value || null,
        notes: document.getElementById('notes').value || null,
        apply_scope: currentEditScope
    };
    
    try {
        let url = '{{ url_for("gerenciamento_financeiro.api_transactions") }}';
        let method = 'POST';
        
        if (currentEditingId) {
            url += `/${currentEditingId}`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
            showToast(
                currentEditingId 
                    ? 'Transa√ß√£o atualizada com sucesso! üéâ'
                    : `${formData.type === 'income' ? 'Entrada' : 'Despesa'} registrada com sucesso! üéâ`, 
                'success'
            );
            loadTransactions(currentPage); // Reload current page
        } else {
            showToast(result.error || 'Erro ao salvar transa√ß√£o', 'error');
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
        showToast('Erro ao salvar transa√ß√£o', 'error');
    } finally {
        button.disabled = false;
        spinner.classList.add('d-none');
    }
});

// Edit transaction
window.transactionsPage.editTransaction = async function(id) {
    try {
        showLoading('Carregando transa√ß√£o...');
        // Fetch transaction data
        const response = await fetch(`{{ url_for("gerenciamento_financeiro.api_transactions") }}/${id}`);
        const data = await response.json();
        const transaction = data.transaction;
        
        if (!transaction) {
            hideLoading();
            showToast('Transa√ß√£o n√£o encontrada', 'error');
            return;
        }
        
        // Hide loading before showing scope modal
        hideLoading();
        
        // Check if this is an installment (part of a series)
        const isInstallment = transaction.is_fixed || transaction.is_recurring;
        if (isInstallment) {
            const scope = await _chooseEditScope();
            if (!scope) return;
            currentEditScope = scope;
        } else {
            currentEditScope = 'single';
        }
        
        // Set editing mode FIRST
        currentEditingId = id;
        
        // Prepare category selection
        pendingCategoryId = transaction.category?.id || transaction.category_id || null;
        pendingCategoryLabel = transaction.category
            ? `${transaction.category.icon || 'üí∞'} ${transaction.category.name}`
            : null;
        
        // Get modal elements
        const modalEl = document.getElementById('addTransactionModal');
        const title = document.getElementById('addTransactionTitle');
        const typeInput = document.getElementById('transactionType');
        const saveButton = document.getElementById('saveButton');
        
        // Configure modal for EDIT mode (not "Nova")
        typeInput.value = transaction.type;
        title.innerHTML = `<i class="bi bi-pencil me-2"></i>Editar ${transaction.type === 'income' ? 'Entrada' : 'Despesa'}`;
        
        if (transaction.type === 'income') {
            saveButton.className = 'btn btn-success';
        } else {
            saveButton.className = 'btn btn-danger';
        }
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Atualizar Transa√ß√£o';
        
        // Fill form fields with transaction data
        document.getElementById('description').value = transaction.description || '';
        document.getElementById('amount').value = (typeof transaction.amount === 'number')
            ? transaction.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            : String(transaction.amount || '');
        document.getElementById('transactionDate').value = transaction.transaction_date;
        document.getElementById('notes').value = transaction.notes || '';
        
        // Setup mask
        setupAmountMask();
        
        // Load categories (async) - will apply pendingCategoryId when done
        loadCategories(transaction.type);
        
        // Also try to set category immediately if options already exist
        setCategoryValue(pendingCategoryId);
        
        // Hide loading and show modal
        hideLoading();
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        
    } catch (error) {
        console.error('Erro ao carregar transa√ß√£o:', error);
        showToast('Erro ao carregar transa√ß√£o', 'error');
        hideLoading();
    }
}

// Delete transaction
window.transactionsPage.deleteTransaction = async function(id) {
    try {
        let tx = null;
        try {
            const r = await fetch(`{{ url_for("gerenciamento_financeiro.api_transactions") }}/${id}`);
            const d = await r.json();
            if (r.ok && d && d.transaction) tx = d.transaction;
        } catch (e) {
            // ignore
        }

        const isRecurring = !!(tx && (tx.recurring_transaction_id || tx.is_fixed || tx.is_recurring));
        let applyScope = 'single';

        if (isRecurring && typeof window._chooseDeleteScope === 'function') {
            const scope = await window._chooseDeleteScope();
            if (!scope) return;
            applyScope = scope;
        }

        const body = (applyScope === 'series')
            ? 'Esta transa√ß√£o √© recorrente. Deseja excluir TODAS as ocorr√™ncias desta recorr√™ncia?'
            : 'Deseja realmente excluir esta transa√ß√£o?';

        const ok = (window._openConfirmModal)
            ? await window._openConfirmModal({
                title: 'Excluir transa√ß√£o',
                body,
                confirmText: 'Excluir',
                confirmClass: 'btn-danger',
            })
            : window.confirm(body);
        if (!ok) return;

        showLoading();

        const url = (applyScope === 'series')
            ? `{{ url_for("gerenciamento_financeiro.api_transactions") }}/${id}?apply_scope=series`
            : `{{ url_for("gerenciamento_financeiro.api_transactions") }}/${id}`;

        const response = await fetch(url, { method: 'DELETE' });
        const result = await response.json();

        if (response.ok) {
            showToast(applyScope === 'series' ? 'Recorr√™ncia exclu√≠da com sucesso!' : 'Transa√ß√£o exclu√≠da com sucesso!', 'success');
            loadTransactions(currentPage);
        } else {
            showToast(result.error || 'Erro ao excluir transa√ß√£o', 'error');
        }
    } catch (error) {
        console.error('Erro ao excluir:', error);
        showToast('Erro ao excluir transa√ß√£o', 'error');
    } finally {
        hideLoading();
    }
}

// Filtro de tipo de transa√ß√£o (Entradas, Sa√≠das)
function filterTransactionsByType(type) {
    // Atualizar sele√ß√£o do filtro de tipo
    const filterType = document.getElementById('filterType');
    if (filterType) {
        filterType.value = type;
    }
    
    // Atualizar estilos das abas
    const tabIncome = document.getElementById('tabIncomeTransactions');
    const tabExpense = document.getElementById('tabExpenseTransactions');
    
    if (tabIncome && tabExpense) {
        // Remover estilo ativo de todas
        [tabIncome, tabExpense].forEach(tab => {
            tab.style.borderBottomColor = 'transparent';
            tab.style.color = 'var(--text-secondary)';
        });
        
        // Aplicar estilo ativo √† aba selecionada
        if (type === 'income') {
            tabIncome.style.borderBottomColor = '#10b981';
            tabIncome.style.color = '#10b981';
        } else if (type === 'expense') {
            tabExpense.style.borderBottomColor = '#ef4444';
            tabExpense.style.color = '#ef4444';
        }
    }
    
    // Aplicar filtros
    applyFilters();
}