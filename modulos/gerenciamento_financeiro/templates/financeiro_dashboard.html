{% extends 'finance_base.html' %}

{% block title %}Dashboard Financeiro ¬∑ NEXUSRDR{% endblock %}

{% block extra_scripts %}
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Header Dashboard -->
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4">
            <div class="flex-grow-1">
                <h1 class="h3 h2-md mb-1">Dashboard Financeiro</h1>
                <p class="text-muted mb-0 small">
                    <i class="bi bi-person-circle me-1"></i>
                    {{ user.email.split('@')[0] if user }} ¬∑ 
                    <i class="bi bi-calendar me-1"></i>
                    {{ now.strftime('%B %Y') if now }}
                </p>
                <p class="mb-0 mt-2">
                    <span class="badge rounded-pill" style="font-size: 0.75rem; padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #3b82f6, #1e40af);">
                        <i class="bi bi-folder-fill me-1"></i>
                        <span id="currentWorkspaceName">{{ active_workspace.name if active_workspace else 'Meu Workspace' }}</span>
                    </span>
                </p>
            </div>

            <div class="d-flex flex-column align-items-stretch align-items-md-end gap-2 mt-3 mt-md-0">
                <!-- Quick Actions -->
                <div class="d-flex flex-wrap justify-content-start justify-content-md-end gap-2">
                <button class="btn btn-success" onclick="showAddTransaction('income')">
                    <i class="bi bi-plus-circle me-1"></i> Nova Entrada
                </button>
                <button class="btn btn-danger" onclick="showAddTransaction('expense')">
                    <i class="bi bi-dash-circle me-1"></i> Nova Despesa
                </button>
                <button class="btn btn-warning" onclick="showMonthlyHistory()">
                    <i class="bi bi-calendar-check me-1"></i> Hist√≥rico
                </button>
                <button class="btn btn-primary" id="chartsBtn" onclick="showChartsModal()">
                    <i class="bi bi-bar-chart-line me-1"></i> Gr√°ficos
                </button>
                <button class="btn btn-info" id="closeMonthBtn" onclick="closeMonthConfirm()">
                    <i class="bi bi-lock me-1"></i> Fechar M√™s
                </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Status -->
    <div class="col-12">
        <div class="row g-3 g-md-4 mb-4">
            <!-- Saldo Total -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card value-card h-100">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-1 opacity-75" style="font-size: 0.85rem;">Saldo Atual</h6>
                                <h3 class="card-title mb-1" style="font-size: 1.5rem;">R$ {{ "{:,.2f}".format(balance or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <small class="opacity-75" style="font-size: 0.75rem;">
                                    <i class="bi bi-arrow-up me-1"></i>
                                    Atualizado agora
                                </small>
                            </div>
                            <div class="opacity-50 d-none d-sm-block">
                                <i class="bi bi-wallet2" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Entradas do M√™s -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card income-card h-100" style="animation: slideInUp 0.5s ease-out 0.1s both;">
                    <div class="card-body text-white p-3 p-md-4">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="flex-grow-1" style="position: relative; z-index: 2;">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; backdrop-filter: blur(10px);">
                                        <i class="bi bi-arrow-up-circle" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-0 opacity-90 fw-semibold" style="font-size: 0.8rem; letter-spacing: 0.5px; text-transform: uppercase;">Entradas</h6>
                                </div>
                                <h3 class="card-title mb-2 fw-bold" style="font-size: 1.75rem; line-height: 1.2;">+R$ {{ "{:,.2f}".format(monthly_income or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge" style="background: rgba(255, 255, 255, 0.25); font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                        <i class="bi bi-graph-up-arrow me-1"></i>{{ income_count }} transa√ß√µes
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gastos do M√™s -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card expense-card h-100" style="animation: slideInUp 0.5s ease-out 0.2s both;">
                    <div class="card-body text-white p-3 p-md-4">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="flex-grow-1" style="position: relative; z-index: 2;">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; backdrop-filter: blur(10px);">
                                        <i class="bi bi-arrow-down-circle" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-0 opacity-90 fw-semibold" style="font-size: 0.8rem; letter-spacing: 0.5px; text-transform: uppercase;">Despesas</h6>
                                </div>
                                <h3 class="card-title mb-2 fw-bold" style="font-size: 1.75rem; line-height: 1.2;">-R$ {{ "{:,.2f}".format(monthly_expense or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge" style="background: rgba(255, 255, 255, 0.25); font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                        <i class="bi bi-graph-down-arrow me-1"></i>{{ expense_count }} transa√ß√µes
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Taxa de Economia -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card h-100 border-info border-2">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-1 text-info" style="font-size: 0.85rem;">Taxa de Economia</h6>
                                <h4 class="card-title mb-1 text-info" style="font-size: 1.35rem;">{{ "{:.1f}".format(savings_rate or 0) }}%</h4>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    R$ {{ "{:,.2f}".format(savings or 0).replace(",", "X").replace(".", ",").replace("X", ".") }} economizado
                                </small>
                            </div>
                            <div class="text-info opacity-25">
                                <i class="bi bi-piggy-bank" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transa√ß√µes Recentes -->
    <div class="col-12">
        <div class="card" style="border: none; background: transparent; box-shadow: none;">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center" style="background: transparent; border: none; padding: 0 0 1.5rem 0;">
                <div class="mb-2 mb-md-0">
                    <h4 class="mb-1 fw-bold" style="font-size: 1.5rem;">
                        <i class="bi bi-clock-history me-2" style="color: #3b82f6;"></i>Transa√ß√µes Recentes
                    </h4>
                    <small class="text-muted">√öltimas movimenta√ß√µes da conta</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="abrirModalTransacoes()" style="border-radius: 10px;">
                        <i class="bi bi-list-ul me-1"></i> Ver Todas
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                {% if recent_transactions %}
                    <div id="recentTransactionsTbody" class="d-flex flex-column gap-2">
                        {% for t in recent_transactions %}
                        <div data-transaction-id="{{ t.id }}" 
                             class="transaction-card" 
                             onclick="showTransactionDetails({{ t.id }})"
                             style="animation: slideInUp 0.4s ease-out {{ loop.index0 * 0.05 }}s both;">
                            <div class="card h-100" style="border-radius: 16px; {% if t.is_fixed %}border: 3px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);{% else %}border: 1px solid var(--border-color);{% endif %} cursor: pointer; transition: all 0.3s ease; {% if t.is_recurring %}background: linear-gradient(135deg, rgba(59, 130, 246, 0.03), rgba(99, 102, 241, 0.02));{% endif %}{% if t.is_fixed %}background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.03));{% endif %}">
                                <div class="card-body p-3 p-md-4">
                                    <div class="d-flex align-items-start gap-3">
                                        <!-- √çcone da Categoria -->
                                        <div class="flex-shrink-0">
                                            <div class="d-flex align-items-center justify-content-center" 
                                                 style="width: 52px; height: 52px; border-radius: 14px; background: {% if t.type == 'income' %}linear-gradient(135deg, rgba(17, 153, 142, 0.15), rgba(56, 239, 125, 0.1)){% else %}linear-gradient(135deg, rgba(238, 9, 121, 0.15), rgba(255, 106, 0, 0.1)){% endif %}; border: 2px solid {% if t.type == 'income' %}rgba(17, 153, 142, 0.2){% else %}rgba(238, 9, 121, 0.2){% endif %};">
                                                {% if t.category %}
                                                    <span style="font-size: 1.5rem;">{{ t.category.icon }}</span>
                                                {% else %}
                                                    <i class="bi bi-{% if t.type == 'income' %}arrow-up-circle{% else %}arrow-down-circle{% endif %}" style="font-size: 1.5rem; color: {% if t.type == 'income' %}#11998e{% else %}#ee0979{% endif %};"></i>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Conte√∫do Principal -->
                                        <div class="flex-grow-1 min-w-0">
                                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2">
                                                <div class="flex-grow-1">
                                                    <!-- Descri√ß√£o e Data -->
                                                    <h6 class="mb-1 fw-semibold" style="font-size: 1rem; line-height: 1.3;">{{ t.description }}</h6>
                                                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                                        <small class="text-muted d-flex align-items-center">
                                                            <i class="bi bi-calendar3 me-1"></i>
                                                            {{ t.transaction_date.strftime('%d/%m/%Y') }}
                                                        </small>
                                                        {% if t.category %}
                                                            <span class="badge rounded-pill" style="background-color: {{ t.category.color }}20; color: {{ t.category.color }}; font-size: 0.7rem; padding: 0.35rem 0.65rem;">
                                                                {{ t.category.icon }} {{ t.category.name }}
                                                            </span>
                                                        {% endif %}
                                                        {% if t.is_fixed %}
                                                            <span class="badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                                                <i class="bi bi-pin-angle-fill me-1"></i>Fixo
                                                            </span>
                                                        {% endif %}
                                                        {% if t.is_recurring %}
                                                            <span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                                                <i class="bi bi-arrow-repeat me-1"></i>Recorrente
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                <!-- Valor e A√ß√µes -->
                                                <div class="d-flex flex-column align-items-end gap-2">
                                                    <div class="fw-bold" style="font-size: 1.25rem; color: {% if t.type == 'income' %}#11998e{% else %}#ee0979{% endif %};">
                                                        {{ '+' if t.type == 'income' else '-' }}R$ {{ "{:,.2f}".format(t.amount).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                                    </div>
                                                    <div class="btn-group btn-group-sm transaction-actions" style="opacity: 0.7; transition: opacity 0.3s ease;">
                                                        <button class="btn btn-sm" onclick="editTransaction({{ t.id }}); event.stopPropagation();" title="Editar" style="border: 1px solid var(--border-color); border-radius: 8px 0 0 8px; padding: 0.4rem 0.7rem;">
                                                            <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                                                        </button>
                                                        <button class="btn btn-sm" onclick="deleteTransaction({{ t.id }}); event.stopPropagation();" title="Excluir" style="border: 1px solid var(--border-color); border-left: none; border-radius: 0 8px 8px 0; padding: 0.4rem 0.7rem;">
                                                            <i class="bi bi-trash" style="font-size: 0.9rem; color: #ef4444;"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="card" style="border-radius: 16px; border: 2px dashed var(--border-color);">
                        <div class="card-body text-center py-5">
                            <div class="mb-3" style="font-size: 4rem; opacity: 0.3;">
                                <i class="bi bi-inbox"></i>
                            </div>
                            <h5 class="mb-2">Nenhuma transa√ß√£o registrada</h5>
                            <p class="text-muted mb-4">Comece adicionando sua primeira transa√ß√£o e acompanhe suas finan√ßas</p>
                            <button class="btn btn-primary" onclick="showAddTransaction('income')" style="border-radius: 10px; padding: 0.6rem 1.5rem;">
                                <i class="bi bi-plus-circle me-2"></i>Primeira Transa√ß√£o
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Mobile -->
 

<!-- Modal Adicionar Transa√ß√£o -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTransactionTitle">Nova Transa√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addTransactionForm">
                <div class="modal-body">
                    <input type="hidden" id="transactionType">
                    
                    <div class="mb-3">
                        <label for="category" class="form-label">Categoria *</label>
                        <select class="form-select" id="category" required>
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="descriptionField" style="display: none;">
                        <label for="description" class="form-label">Nome da Despesa *</label>
                        <input type="text" class="form-control" id="description" placeholder="Ex: Almo√ßo, Gasolina, Conta de √°gua...">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Valor (R$) *</label>
                                <input type="number" class="form-control" id="amount" step="0.01" min="0" required placeholder="0,00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="transactionDate" class="form-label" id="dateLabel">Dt de entrada do dinheiro na conta *</label>
                                <input type="date" class="form-control" id="transactionDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isFixed">
                        <label class="form-check-label" for="isFixed">
                            Marcar como fixo
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveButton">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        Salvar Transa√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Hist√≥rico Mensal -->
<div class="modal fade" id="monthlyHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-check me-2"></i>Hist√≥rico de Transa√ß√µes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="historyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions-pane" type="button" role="tab">
                            <i class="bi bi-list-ul me-1"></i>Transa√ß√µes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts-pane" type="button" role="tab" onclick="loadCharts()">
                            <i class="bi bi-bar-chart-line me-1"></i>Gr√°ficos
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="historyTabContent">
                    <!-- Aba Transa√ß√µes -->
                    <div class="tab-pane fade show active" id="transactions-pane" role="tabpanel">
                        <!-- Filtros -->
                        <div class="card mb-3" style="border-radius: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(99, 102, 241, 0.03));">
                            <div class="card-body p-3">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label small mb-1">M√™s</label>
                                        <select class="form-select" id="historyFilterMonth" onchange="loadMonthlyHistory()">
                                            <option value="">Todos os meses</option>
                                            <option value="1">Janeiro</option>
                                            <option value="2">Fevereiro</option>
                                            <option value="3">Mar√ßo</option>
                                            <option value="4">Abril</option>
                                            <option value="5">Maio</option>
                                            <option value="6">Junho</option>
                                            <option value="7">Julho</option>
                                            <option value="8">Agosto</option>
                                            <option value="9">Setembro</option>
                                            <option value="10">Outubro</option>
                                            <option value="11">Novembro</option>
                                            <option value="12">Dezembro</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small mb-1">Ano</label>
                                        <select class="form-select" id="historyFilterYear" onchange="loadMonthlyHistory()">
                                            <option value="">Todos os anos</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-primary w-100" onclick="document.getElementById('historyFilterMonth').value=''; document.getElementById('historyFilterYear').value=''; loadMonthlyHistory();">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Limpar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conte√∫do do hist√≥rico -->
                        <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Gr√°ficos -->
                    <div class="tab-pane fade" id="charts-pane" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Despesas por Categoria</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="categoryChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Evolu√ß√£o Mensal</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="monthlyChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Comparativo Entradas vs Despesas</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="comparisonChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gr√°ficos -->
<div class="modal fade" id="chartsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-bar-chart-line me-2"></i>Gr√°ficos Financeiros
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Despesas por Categoria</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="categoryChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Evolu√ß√£o Mensal</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="monthlyChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Comparativo Entradas vs Despesas</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="comparisonChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Fechamento -->
<div class="modal fade" id="closeMonthModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Fechamento de M√™s
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voc√™ est√° prestes a fechar o m√™s atual. Esta a√ß√£o:</p>
                <ul>
                    <li>‚úÖ Registrar√° todos os totais do m√™s</li>
                    <li>‚úÖ Criar√° um novo m√™s</li>
                    <li>‚úÖ Carregar√° automaticamente as despesas fixas</li>
                </ul>
                <p class="text-muted mb-0"><small>Esta a√ß√£o n√£o pode ser desfeita. Deseja continuar?</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="executeCloseMonth()">
                    <i class="bi bi-lock me-1"></i>Fechar M√™s
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Boas-vindas (Primeiro Acesso) -->
<div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-hand-wave me-2"></i>Bem-vindo ao Sistema Financeiro!
                </h5>
            </div>
            <div class="modal-body">
                <div id="welcomeContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Workspaces -->
<div class="modal fade" id="workspacesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder me-2"></i>Gerenciar Workspaces
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Abas -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="my-workspaces-tab" data-bs-toggle="tab" data-bs-target="#my-workspaces" type="button" role="tab" onclick="loadWorkspacesInModal()">
                            <i class="bi bi-folder me-1"></i>Meus Workspaces
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="new-workspace-tab" data-bs-toggle="tab" data-bs-target="#new-workspace" type="button" role="tab">
                            <i class="bi bi-plus-circle me-1"></i>Novo Workspace
                        </button>
                    </li>
                </ul>

                <!-- Conte√∫do das Abas -->
                <div class="tab-content">
                    <!-- Aba: Meus Workspaces -->
                    <div class="tab-pane fade show active" id="my-workspaces" role="tabpanel">
                        <div id="workspacesListContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba: Novo Workspace -->
                    <div class="tab-pane fade" id="new-workspace" role="tabpanel">
                        <div class="mb-3">
                            <label for="newWsName" class="form-label">Nome do Workspace *</label>
                            <input type="text" class="form-control" id="newWsName" placeholder="Ex: Fam√≠lia, Neg√≥cio...">
                        </div>
                        <div class="mb-3">
                            <label for="newWsDesc" class="form-label">Descri√ß√£o (opcional)</label>
                            <input type="text" class="form-control" id="newWsDesc" placeholder="Descri√ß√£o do workspace">
                        </div>
                        <div class="mb-3">
                            <label for="newWsColor" class="form-label">Cor</label>
                            <div class="d-flex gap-2">
                                <input type="color" class="form-control" id="newWsColor" value="#3b82f6" style="width: 60px;">
                                <input type="text" class="form-control" id="newWsColorText" value="#3b82f6" readonly>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="createWorkspaceFromModal()">
                            <i class="bi bi-check me-1"></i>Criar Workspace
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Compartilhamentos Completo -->
<div class="modal fade" id="shareSystemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-share me-2"></i>Gerenciar Compartilhamentos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Abas -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-invites-tab" data-bs-toggle="tab" data-bs-target="#pending-invites" type="button" role="tab" onclick="loadPendingInvites()">
                            <i class="bi bi-envelope me-1"></i>Convites Recebidos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="new-share-tab" data-bs-toggle="tab" data-bs-target="#new-share" type="button" role="tab">
                            <i class="bi bi-plus-circle me-1"></i>Novo Compartilhamento
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="list-shares-tab" data-bs-toggle="tab" data-bs-target="#list-shares" type="button" role="tab" onclick="loadShares()">
                            <i class="bi bi-list-ul me-1"></i>Meus Compartilhamentos
                        </button>
                    </li>
                </ul>

                <!-- Conte√∫do das Abas -->
                <div class="tab-content">
                    <!-- Aba: Convites Recebidos -->
                    <div class="tab-pane fade" id="pending-invites" role="tabpanel">
                        <div id="pendingInvitesContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba: Novo Compartilhamento -->
                    <div class="tab-pane fade show active" id="new-share" role="tabpanel">
                <div class="mb-3">
                    <label for="shareEmail" class="form-label">Email do usu√°rio *</label>
                    <input type="email" class="form-control" id="shareEmail" placeholder="usuario@exemplo.com" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Tipo de Compartilhamento *</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="shareType" id="shareTypeFamily" value="family" checked>
                        <label class="btn btn-outline-primary" for="shareTypeFamily">
                            <i class="bi bi-people me-2"></i>Membro da Fam√≠lia
                        </label>
                        
                        <input type="radio" class="btn-check" name="shareType" id="shareTypeAccountant" value="accountant">
                        <label class="btn btn-outline-primary" for="shareTypeAccountant">
                            <i class="bi bi-briefcase me-2"></i>Contador/Consultor
                        </label>
                    </div>
                </div>

                <div id="familyOptions" class="mb-3">
                    <label for="familyRole" class="form-label">Papel na Fam√≠lia *</label>
                    <select class="form-select" id="familyRole">
                        <option value="">Selecione o papel</option>
                        <option value="spouse">C√¥njuge</option>
                        <option value="child">Filho(a)</option>
                        <option value="parent">Pai/M√£e</option>
                        <option value="other">Outro</option>
                    </select>
                </div>

                <div id="accountantOptions" class="mb-3" style="display: none;">
                    <label for="accessLevel" class="form-label">N√≠vel de Acesso *</label>
                    <select class="form-select" id="accessLevel">
                        <option value="viewer">Visualizador (apenas leitura)</option>
                        <option value="editor" selected>Editor (pode editar)</option>
                        <option value="admin">Administrador (controle total)</option>
                    </select>
                </div>

                        <div id="shareInfo" class="alert alert-info d-none">
                            <small id="shareInfoText"></small>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-primary" onclick="executeShare()">
                                <i class="bi bi-check me-1"></i>Enviar Convite
                            </button>
                        </div>
                    </div>

                    <!-- Aba: Lista de Compartilhamentos -->
                    <div class="tab-pane fade" id="list-shares" role="tabpanel">
                        <div id="sharesListContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_styles %}
<style>
    /* Hover effect para cards de workspace */
    .hover-card {
        transition: all 0.3s ease !important;
    }
    
    .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Responsividade mobile */
    @media (max-width: 768px) {
        .hover-card .btn-group {
            flex-direction: column;
        }
        
        .hover-card .btn-group .btn {
            margin-bottom: 0.25rem;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script defer>
let currentEditingId = null;

document.addEventListener('DOMContentLoaded', () => {
    const d = document.getElementById('transactionDate');
    if (d) d.value = new Date().toISOString().split('T')[0];
    const f = document.getElementById('addTransactionForm');
    if (f) f.addEventListener('submit', saveTransaction);
});

function showAddTransaction(type) {
    const m = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    const t = document.getElementById('addTransactionTitle');
    const ti = document.getElementById('transactionType');
    const sb = document.getElementById('saveButton');
    document.getElementById('addTransactionForm').reset();
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    currentEditingId = null;
    ti.value = type;
    if (type === 'income') {
        t.innerHTML = '<i class="bi bi-plus-circle text-success me-2"></i>Nova Entrada';
        sb.className = 'btn btn-success';
        sb.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Entrada';
    } else {
        t.innerHTML = '<i class="bi bi-dash-circle text-danger me-2"></i>Nova Despesa';
        sb.className = 'btn btn-danger';
        sb.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Despesa';
    }
    loadCategories(type);
    m.show();
}

async function loadCategories(type) {
    try {
        const r = await fetch(`{{ url_for('gerenciamento_financeiro.api_categories') }}?type=${type}`);
        const d = await r.json();
        const s = document.getElementById('category');
        s.innerHTML = '<option value="">Selecione uma categoria</option>';
        if (d.categories) d.categories.forEach(c => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = `${c.icon || 'üí∞'} ${c.name}`;
            s.appendChild(o);
        });
    } catch (e) {
        console.error('Erro:', e);
    }
}

async function saveTransaction(e) {
    e.preventDefault();
    const btn = document.getElementById('saveButton');
    const sp = btn.querySelector('.spinner-border');
    btn.disabled = true;
    sp.classList.remove('d-none');
    
    const fd = {
        type: document.getElementById('transactionType').value,
        description: document.getElementById('description').value || document.getElementById('category').options[document.getElementById('category').selectedIndex].text,
        amount: parseFloat(document.getElementById('amount').value),
        transaction_date: document.getElementById('transactionDate').value,
        category_id: document.getElementById('category').value,
        frequency: 'once',
        is_recurring: false,
        is_fixed: document.getElementById('isFixed').checked
    };
    
    try {
        let url = '/gerenciamento-financeiro/api/transactions';
        const editingId = currentEditingId;
        if (editingId) url += `/${editingId}`;
        
        const r = await fetch(url, {
            method: editingId ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fd)
        });
        
        const res = await r.json();
        if (r.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
            showToast(editingId ? 'Atualizado!' : 'Salvo!', 'success');
            document.getElementById('addTransactionForm').reset();
            currentEditingId = null;
            if (editingId) {
                upsertTransactionRow(res);
            } else {
                addTransactionToTable(res);
            }
        } else {
            showToast(res.error || 'Erro', 'error');
        }
    } catch (e) {
        showToast('Erro', 'error');
    } finally {
        btn.disabled = false;
        sp.classList.add('d-none');
    }
}

function _formatBRL(value) {
    const n = Number(value || 0);
    return n.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function _getRecentContainer() {
    return document.getElementById('recentTransactionsTbody');
}

function _buildTransactionCard(t) {
    const date = new Date(t.transaction_date);
    const formattedDate = date.toLocaleDateString('pt-BR');
    
    const categoryIcon = t.category?.icon || (t.type === 'income' ? 'üíµ' : 'üí∏');
    const categoryName = t.category?.name || '';
    const categoryColor = t.category?.color || (t.type === 'income' ? '#11998e' : '#ee0979');
    
    const iconBg = t.type === 'income' 
        ? 'linear-gradient(135deg, rgba(17, 153, 142, 0.15), rgba(56, 239, 125, 0.1))'
        : 'linear-gradient(135deg, rgba(238, 9, 121, 0.15), rgba(255, 106, 0, 0.1))';
    const iconBorder = t.type === 'income' ? 'rgba(17, 153, 142, 0.2)' : 'rgba(238, 9, 121, 0.2)';
    const iconFallback = t.type === 'income' ? 'arrow-up-circle' : 'arrow-down-circle';
    const iconColor = t.type === 'income' ? '#11998e' : '#ee0979';
    
    const categoryBadge = t.category 
        ? `<span class="badge rounded-pill" style="background-color: ${categoryColor}20; color: ${categoryColor}; font-size: 0.7rem; padding: 0.35rem 0.65rem;">
                ${categoryIcon} ${categoryName}
           </span>`
        : '';
    
    const fixedBadge = t.is_fixed
        ? `<span class="badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                <i class="bi bi-pin-angle-fill me-1"></i>Fixo
           </span>`
        : '';
    
    const recurringBadge = t.is_recurring
        ? `<span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                <i class="bi bi-arrow-repeat me-1"></i>Recorrente
           </span>`
        : '';
    
    const amountColor = t.type === 'income' ? '#11998e' : '#ee0979';
    const amountSign = t.type === 'income' ? '+' : '-';
    
    const recurringBg = t.is_recurring ? 'background: linear-gradient(135deg, rgba(59, 130, 246, 0.03), rgba(99, 102, 241, 0.02));' : '';
    const fixedHighlight = t.is_fixed
        ? 'border: 3px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2); background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.03));'
        : 'border: 1px solid var(--border-color);';
    
    return `
        <div class="card h-100" style="border-radius: 16px; ${fixedHighlight} cursor: pointer; transition: all 0.3s ease; ${recurringBg}">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex align-items-start gap-3">
                    <!-- √çcone da Categoria -->
                    <div class="flex-shrink-0">
                        <div class="d-flex align-items-center justify-content-center" 
                             style="width: 52px; height: 52px; border-radius: 14px; background: ${iconBg}; border: 2px solid ${iconBorder};">
                            ${t.category 
                                ? `<span style="font-size: 1.5rem;">${categoryIcon}</span>`
                                : `<i class="bi bi-${iconFallback}" style="font-size: 1.5rem; color: ${iconColor};"></i>`
                            }
                        </div>
                    </div>

                    <!-- Conte√∫do Principal -->
                    <div class="flex-grow-1 min-w-0">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2">
                            <div class="flex-grow-1">
                                <!-- Descri√ß√£o e Data -->
                                <h6 class="mb-1 fw-semibold" style="font-size: 1rem; line-height: 1.3;">${t.description || 'Sem descri√ß√£o'}</h6>
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                    <small class="text-muted d-flex align-items-center">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        ${formattedDate}
                                    </small>
                                    ${categoryBadge}
                                    ${fixedBadge}
                                    ${recurringBadge}
                                </div>
                            </div>

                            <!-- Valor e A√ß√µes -->
                            <div class="d-flex flex-column align-items-end gap-2">
                                <div class="fw-bold" style="font-size: 1.25rem; color: ${amountColor};">
                                    ${amountSign}R$ ${_formatBRL(t.amount)}
                                </div>
                                <div class="btn-group btn-group-sm transaction-actions" style="opacity: 0.7; transition: opacity 0.3s ease;">
                                    <button class="btn btn-sm" onclick="editTransaction(${t.id}); event.stopPropagation();" title="Editar" style="border: 1px solid var(--border-color); border-radius: 8px 0 0 8px; padding: 0.4rem 0.7rem;">
                                        <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                                    </button>
                                    <button class="btn btn-sm" onclick="deleteTransaction(${t.id}); event.stopPropagation();" title="Excluir" style="border: 1px solid var(--border-color); border-left: none; border-radius: 0 8px 8px 0; padding: 0.4rem 0.7rem;">
                                        <i class="bi bi-trash" style="font-size: 0.9rem; color: #ef4444;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function upsertTransactionRow(t) {
    const existing = document.querySelector(`[data-transaction-id="${t.id}"]`);
    if (!existing) {
        addTransactionToTable(t);
        return;
    }

    existing.setAttribute('onclick', `showTransactionDetails(${t.id})`);
    existing.innerHTML = _buildTransactionCard(t);
}

function addTransactionToTable(t) {
    const container = _getRecentContainer();
    if (!container) return;

    const cardWrapper = document.createElement('div');
    cardWrapper.setAttribute('data-transaction-id', t.id);
    cardWrapper.className = 'transaction-card';
    cardWrapper.setAttribute('onclick', `showTransactionDetails(${t.id})`);
    cardWrapper.style.animation = 'slideInUp 0.4s ease-out both';
    cardWrapper.innerHTML = _buildTransactionCard(t);
    
    container.insertBefore(cardWrapper, container.firstChild);
}

async function editTransaction(id) {
    try {
        const r = await fetch('/gerenciamento-financeiro/api/transactions?page=1&per_page=1000');
        const d = await r.json();
        const t = d.transactions?.find(x => x.id === id);
        if (!t) return;
        currentEditingId = id;
        showAddTransaction(t.type);
        setTimeout(() => {
            document.getElementById('amount').value = t.amount;
            document.getElementById('transactionDate').value = t.transaction_date;
            document.getElementById('category').value = t.category?.id || '';
            document.getElementById('description').value = t.description || '';
        }, 200);
    } catch (e) {
        console.error('Erro:', e);
    }
}

async function deleteTransaction(id) {
    if (!confirm('Excluir?')) return;
    try {
        const r = await fetch(`/gerenciamento-financeiro/api/transactions/${id}`, { method: 'DELETE' });
        if (r.ok) {
            showToast('Exclu√≠do!', 'success');
            const row = document.querySelector(`[data-transaction-id="${id}"]`);
            if (row) {
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
        }
    } catch (e) {
        console.error('Erro:', e);
    }
}

async function showMonthlyHistory() {
    const modal = new bootstrap.Modal(document.getElementById('monthlyHistoryModal'));
    modal.show();
    await loadMonthlyHistory();
}

async function loadMonthlyHistory() {
    const container = document.getElementById('historyContent');
    const filterMonth = document.getElementById('historyFilterMonth')?.value;
    const filterYear = document.getElementById('historyFilterYear')?.value;
    
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/transactions?page=1&per_page=1000');
        const data = await response.json();
        
        let transactions = data.transactions || [];
        
        // Filtrar por m√™s/ano se especificado
        if (filterMonth || filterYear) {
            transactions = transactions.filter(t => {
                const date = new Date(t.transaction_date);
                const matchMonth = !filterMonth || (date.getMonth() + 1) == filterMonth;
                const matchYear = !filterYear || date.getFullYear() == filterYear;
                return matchMonth && matchYear;
            });
        }
        
        if (!transactions.length) {
            container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">Nenhuma transa√ß√£o encontrada</p></div>';
            return;
        }
        
        // Agrupar por m√™s
        const grouped = {};
        transactions.forEach(t => {
            const date = new Date(t.transaction_date);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(t);
        });
        
        let html = '';
        Object.keys(grouped).sort().reverse().forEach(key => {
            const [year, month] = key.split('-');
            const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            const items = grouped[key];
            
            const totalIncome = items.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = items.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;
            
            html += `
                <div class="card mb-3" style="border-radius: 12px;">
                    <div class="card-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 12px 12px 0 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-capitalize"><i class="bi bi-calendar-month me-2"></i>${monthName}</h6>
                            <span class="badge bg-light text-dark">${items.length} transa√ß√µes</span>
                        </div>
                        <div class="row mt-2 text-center">
                            <div class="col-4">
                                <small class="d-block opacity-75">Entradas</small>
                                <strong>+R$ ${_formatBRL(totalIncome)}</strong>
                            </div>
                            <div class="col-4">
                                <small class="d-block opacity-75">Sa√≠das</small>
                                <strong>-R$ ${_formatBRL(totalExpense)}</strong>
                            </div>
                            <div class="col-4">
                                <small class="d-block opacity-75">Saldo</small>
                                <strong class="${balance >= 0 ? 'text-success' : 'text-danger'}">R$ ${_formatBRL(Math.abs(balance))}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        ${items.map(t => {
                            const date = new Date(t.transaction_date);
                            const categoryIcon = t.category?.icon || (t.type === 'income' ? 'üíµ' : 'üí∏');
                            const amountColor = t.type === 'income' ? '#11998e' : '#ee0979';
                            const amountSign = t.type === 'income' ? '+' : '-';
                            return `
                                <div class="d-flex align-items-center justify-content-between p-2 border-bottom" style="cursor: pointer;" onclick="showTransactionDetails(${t.id})">
                                    <div class="d-flex align-items-center gap-2">
                                        <span style="font-size: 1.5rem;">${categoryIcon}</span>
                                        <div>
                                            <div class="fw-semibold">${t.description}</div>
                                            <small class="text-muted">${date.toLocaleDateString('pt-BR')}</small>
                                        </div>
                                    </div>
                                    <div class="fw-bold" style="color: ${amountColor};">${amountSign}R$ ${_formatBRL(t.amount)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar hist√≥rico</div>';
    }
}

async function closeMonthConfirm() {
    if (!confirm('Deseja fechar o m√™s atual?\n\nIsso ir√°:\n- Finalizar o per√≠odo atual\n- Criar lan√ßamentos fixos no pr√≥ximo m√™s\n- Gerar relat√≥rio mensal')) {
        return;
    }
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/monthly-closure/close-month', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(`M√™s fechado! ${result.closure.fixed_expenses_copied} despesas fixas copiadas para o pr√≥ximo m√™s`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(result.error || 'Erro ao fechar m√™s', 'error');
        }
    } catch (error) {
        showToast('Erro ao fechar m√™s', 'error');
    }
}

// Abrir modal de gr√°ficos
async function showChartsModal() {
    const modal = new bootstrap.Modal(document.getElementById('chartsModal'));
    modal.show();
    await loadCharts();
}

// Carregar gr√°ficos
let categoryChartInstance = null;
let monthlyChartInstance = null;
let comparisonChartInstance = null;

async function loadCharts() {
    try {
        const response = await fetch('/gerenciamento-financeiro/api/transactions?page=1&per_page=1000');
        const data = await response.json();
        const transactions = data.transactions || [];
        
        // Destruir gr√°ficos existentes
        if (categoryChartInstance) categoryChartInstance.destroy();
        if (monthlyChartInstance) monthlyChartInstance.destroy();
        if (comparisonChartInstance) comparisonChartInstance.destroy();
        
        // 1. Gr√°fico de Pizza - Despesas por Categoria
        const expensesByCategory = {};
        transactions.filter(t => t.type === 'expense').forEach(t => {
            const catName = t.category?.name || 'Sem categoria';
            expensesByCategory[catName] = (expensesByCategory[catName] || 0) + t.amount;
        });
        
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            categoryChartInstance = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{
                        data: Object.values(expensesByCategory),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6',
                            '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#6366f1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = _formatBRL(context.parsed);
                                    return `${label}: R$ ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 2. Gr√°fico de Linha - Evolu√ß√£o Mensal
        const monthlyData = {};
        transactions.forEach(t => {
            const date = new Date(t.transaction_date);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!monthlyData[key]) {
                monthlyData[key] = { income: 0, expense: 0 };
            }
            if (t.type === 'income') {
                monthlyData[key].income += t.amount;
            } else {
                monthlyData[key].expense += t.amount;
            }
        });
        
        const sortedMonths = Object.keys(monthlyData).sort();
        const monthlyCtx = document.getElementById('monthlyChart');
        if (monthlyCtx) {
            monthlyChartInstance = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [
                        {
                            label: 'Entradas',
                            data: sortedMonths.map(m => monthlyData[m].income),
                            borderColor: '#11998e',
                            backgroundColor: 'rgba(17, 153, 142, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Despesas',
                            data: sortedMonths.map(m => monthlyData[m].expense),
                            borderColor: '#ee0979',
                            backgroundColor: 'rgba(238, 9, 121, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: R$ ${_formatBRL(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + _formatBRL(value)
                            }
                        }
                    }
                }
            });
        }
        
        // 3. Gr√°fico de Barras - Comparativo
        const comparisonCtx = document.getElementById('comparisonChart');
        if (comparisonCtx) {
            comparisonChartInstance = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [
                        {
                            label: 'Entradas',
                            data: sortedMonths.map(m => monthlyData[m].income),
                            backgroundColor: '#11998e'
                        },
                        {
                            label: 'Despesas',
                            data: sortedMonths.map(m => monthlyData[m].expense),
                            backgroundColor: '#ee0979'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: R$ ${_formatBRL(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + _formatBRL(value)
                            }
                        }
                    }
                }
            });
        }
        
    } catch (error) {
        console.error('Erro ao carregar gr√°ficos:', error);
        showToast('Erro ao carregar gr√°ficos', 'error');
    }
}

// Verificar virada de m√™s autom√°tica ao carregar p√°gina
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/gerenciamento-financeiro/api/monthly-closure/check-auto-close', {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.auto_closed) {
                showToast(`Novo m√™s iniciado! ${result.fixed_expenses_copied} despesas fixas foram lan√ßadas automaticamente`, 'info');
            }
        }
    } catch (error) {
        console.log('Auto-close check failed:', error);
    }
})

function showShareModal() {
    showToast('Funcionalidade em desenvolvimento', 'info');
}

function loadPendingInvites() {}
function acceptInvite() {}
function rejectInvite() {}
function loadShares() {}
function updateShareTypeOptions() {}
function executeShare() {}
function acceptInviteAndClose() {}
function createOwnWorkspaceAndClose() {}
function checkFirstAccess() {}
</script>
{% endblock %}
