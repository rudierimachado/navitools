{% extends 'finance_base.html' %}
{% block title %}Dashboard Financeiro ¬∑ NEXUSRDR{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Header Dashboard -->
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4">
            <div class="flex-grow-1">
                <h1 class="h3 h2-md mb-1">Dashboard Financeiro</h1>
                <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                    <span class="badge rounded-pill" style="font-size: 0.75rem; padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #3b82f6, #1e40af);">
                        <i class="bi bi-folder-fill me-1"></i>
                        <span id="currentWorkspaceName">{{ active_workspace.name if active_workspace else 'Meu Workspace' }}</span>
                    </span>
                    <!-- Filtro de M√™s/Ano -->
                    <div class="d-flex align-items-center gap-1" style="background: var(--bg-secondary); border-radius: 8px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color);">
                        <i class="bi bi-calendar3 text-primary" style="font-size: 0.85rem;"></i>
                        <select id="filterMonth" class="form-select form-select-sm border-0 bg-transparent" style="width: auto; padding: 0.2rem 1.5rem 0.2rem 0.3rem; font-size: 0.8rem;" onchange="applyGlobalFilter()">
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Mar√ßo</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <select id="filterYear" class="form-select form-select-sm border-0 bg-transparent" style="width: auto; padding: 0.2rem 1.5rem 0.2rem 0.3rem; font-size: 0.8rem;" onchange="applyGlobalFilter()">
                        </select>
                    </div>

<div class="modal fade" id="editScopeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar parcelas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Deseja editar somente esta parcela ou todas as parcelas?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-primary" id="editScopeSingleBtn">S√≥ esta parcela</button>
                <button type="button" class="btn btn-primary" id="editScopeSeriesBtn">Todas as parcelas</button>
            </div>
        </div>
    </div>
</div>
                </div>
            </div>

            <div class="d-flex flex-column align-items-stretch align-items-md-end gap-2 mt-3 mt-md-0">
                <div class="d-none d-md-flex flex-wrap justify-content-start justify-content-md-end gap-2">
                <button class="btn btn-success" onclick="showAddTransaction('income')">
                    <i class="bi bi-plus-circle me-1"></i> Nova Entrada
                </button>
                <button class="btn btn-danger" onclick="showAddTransaction('expense')">
                    <i class="bi bi-dash-circle me-1"></i> Nova Despesa
                </button>
                <button class="btn btn-warning" onclick="showMonthlyHistory()">
                    <i class="bi bi-calendar-check me-1"></i> Hist√≥rico
                </button>
                <button class="btn btn-primary" id="chartsBtn" onclick="showChartsModal()">
                    <i class="bi bi-bar-chart-line me-1"></i> Gr√°ficos
                </button>
                <button class="btn btn-info" id="closeMonthBtn" onclick="closeMonthConfirm()">
                    <i class="bi bi-lock me-1"></i> Fechar M√™s
                </button>
                <button class="btn btn-dark" onclick="showAiRecommendationsModal()">
                    <i class="bi bi-stars me-1"></i> Recomenda√ß√£o de IA
                </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aiRecommendationsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Recomenda√ß√£o de IA</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="aiRecommendationPreset" class="form-label">Tipo de recomenda√ß√£o</label>
                        <select id="aiRecommendationPreset" class="form-select">
                            <option value="general" selected>Recomenda√ß√£o geral (autom√°tica)</option>
                            <option value="vacation">Planejar f√©rias</option>
                            <option value="debt">Quitar d√≠vidas / organizar parcelas</option>
                            <option value="cut_expenses">Cortar gastos</option>
                            <option value="increase_income">Aumentar renda</option>
                            <option value="emergency_fund">Montar reserva de emerg√™ncia</option>
                        </select>
                        <div class="form-text">A IA usa automaticamente os dados do seu workspace (per√≠odo selecionado) + o tipo escolhido.</div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-12 col-md-6">
                            <label for="aiRecommendationPeriod" class="form-label">Per√≠odo</label>
                            <select id="aiRecommendationPeriod" class="form-select">
                                <option value="30" selected>√öltimos 30 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                                <option value="365">√öltimos 12 meses</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="aiRecommendationFocus" class="form-label">Foco (do sistema)</label>
                            <select id="aiRecommendationFocus" class="form-select">
                                <option value="overall" selected>Vis√£o geral</option>
                                <option value="category">Categoria espec√≠fica</option>
                            </select>
                        </div>
                        <div class="col-12" id="aiRecommendationCategoryWrap" style="display:none;">
                            <label for="aiRecommendationCategory" class="form-label">Categoria</label>
                            <select id="aiRecommendationCategory" class="form-select">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>

                    <div id="aiRecommendationError" class="alert alert-warning" style="display:none;"></div>

                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <span id="aiRecommendationCached" class="badge bg-secondary" style="display:none;">cache</span>
                        </div>
                        <button id="aiRecommendationBtn" type="button" class="btn btn-primary" onclick="requestAiRecommendations()">
                            <span id="aiRecommendationSpinner" class="spinner-border spinner-border-sm me-2" role="status" style="display:none;"></span>
                            Gerar recomenda√ß√£o
                        </button>
                    </div>

                    <pre id="aiRecommendationOutput" class="p-3" style="background: #0b1220; color: #e5e7eb; border-radius: 12px; white-space: pre-wrap; word-break: break-word; min-height: 180px;"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta de Convites Pendentes -->
    <div class="col-12" id="pendingInvitesAlert" style="display: none;">
        <div class="alert alert-warning alert-dismissible fade show d-flex align-items-center" role="alert">
            <i class="bi bi-envelope-exclamation fs-4 me-3"></i>
            <div class="flex-grow-1">
                <strong>Voc√™ tem convites pendentes!</strong>
                <span id="pendingInvitesText">Algu√©m quer compartilhar um workspace com voc√™.</span>
            </div>
            <button class="btn btn-warning btn-sm me-2" onclick="showPendingInvitesModal()">
                <i class="bi bi-eye me-1"></i>Ver Convites
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <!-- Cards de Status -->
    <div class="col-12">
        <div class="row g-3 g-md-4 mb-4">
            <!-- Saldo Total -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card value-card h-100">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-1 opacity-75" style="font-size: 0.85rem;">Saldo Atual</h6>
                                <h3 class="card-title mb-1" style="font-size: 1.5rem;">R$ {{ "{:,.2f}".format(balance or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <small class="opacity-75" style="font-size: 0.75rem;">
                                    <i class="bi bi-arrow-up me-1"></i>
                                    Atualizado agora
                                </small>
                            </div>
                            <div class="opacity-50 d-none d-sm-block">
                                <i class="bi bi-wallet2" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Entradas do M√™s -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card income-card h-100" style="animation: slideInUp 0.5s ease-out 0.1s both;">
                    <div class="card-body text-white p-3 p-md-4">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="flex-grow-1" style="position: relative; z-index: 2;">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; backdrop-filter: blur(10px);">
                                        <i class="bi bi-arrow-up-circle" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-0 opacity-90 fw-semibold" style="font-size: 0.8rem; letter-spacing: 0.5px; text-transform: uppercase;">Entradas</h6>
                                </div>
                                <h3 id="totalIncome" class="card-title mb-2 fw-bold" style="font-size: 1.75rem; line-height: 1.2;">+R$ {{ "{:,.2f}".format(monthly_income or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge" style="background: rgba(255, 255, 255, 0.25); font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                        <i class="bi bi-graph-up-arrow me-1"></i>{{ income_count }} transa√ß√µes
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gastos do M√™s -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card expense-card h-100" style="animation: slideInUp 0.5s ease-out 0.2s both;">
                    <div class="card-body text-white p-3 p-md-4">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="flex-grow-1" style="position: relative; z-index: 2;">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; backdrop-filter: blur(10px);">
                                        <i class="bi bi-arrow-down-circle" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-0 opacity-90 fw-semibold" style="font-size: 0.8rem; letter-spacing: 0.5px; text-transform: uppercase;">Despesas</h6>
                                </div>
                                <h3 id="totalExpense" class="card-title mb-2 fw-bold" style="font-size: 1.75rem; line-height: 1.2;">-R$ {{ "{:,.2f}".format(monthly_expense or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge" style="background: rgba(255, 255, 255, 0.25); font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                        <i class="bi bi-graph-down-arrow me-1"></i>{{ expense_count }} transa√ß√µes
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Taxa de Economia -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card h-100 border-info border-2">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-1 text-info" style="font-size: 0.85rem;">Taxa de Economia</h6>
                                <h4 class="card-title mb-1 text-info" style="font-size: 1.35rem;">{{ "{:.1f}".format(savings_rate or 0) }}%</h4>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    R$ {{ "{:,.2f}".format(savings or 0).replace(",", "X").replace(".", ",").replace("X", ".") }} economizado
                                </small>
                            </div>
                            <div class="text-info opacity-25">
                                <i class="bi bi-piggy-bank" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transa√ß√µes Recentes -->
    <div class="col-12">
        <div class="card" style="border: none; background: transparent; box-shadow: none;">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center" style="background: transparent; border: none; padding: 0 0 1rem 0;">
                <div class="mb-2 mb-md-0">
                    <h4 class="mb-1 fw-bold" style="font-size: 1.5rem;">
                        <i class="bi bi-clock-history me-2" style="color: #3b82f6;"></i>Transa√ß√µes
                    </h4>
                </div>
            </div>
            
            <!-- Abas modernas -->
            <div class="d-flex align-items-center gap-2 mb-3" style="border-bottom: 2px solid var(--border-color); padding-bottom: 0;">
                <button class="btn px-4 py-2 fw-semibold transactions-tab active" 
                        id="tabMesAtual" 
                        onclick="switchTransactionsTab('mesAtual')"
                        style="border: none; border-bottom: 3px solid #3b82f6; border-radius: 0; background: transparent; color: #3b82f6; margin-bottom: -2px;">
                    <i class="bi bi-calendar-month me-1"></i>M√™s Atual
                </button>
                <button class="btn px-4 py-2 fw-semibold transactions-tab" 
                        id="tabTodas" 
                        onclick="switchTransactionsTab('todas')"
                        style="border: none; border-bottom: 3px solid transparent; border-radius: 0; background: transparent; color: var(--text-secondary); margin-bottom: -2px;">
                    <i class="bi bi-list-ul me-1"></i>Todas
                </button>
                <div class="ms-auto">
                    <span id="transactionsCount" class="badge bg-primary rounded-pill" style="font-size: 0.75rem;">{{ (recent_transactions|length) }} este m√™s</span>
                </div>
            </div>
            
            <div class="card-body p-0">
                {% if recent_transactions %}
                    <div id="recentTransactionsTbody" class="d-flex flex-column gap-2">
                        {% for t in recent_transactions %}
                        <div data-transaction-id="{{ t.id }}" 
                             class="transaction-card" 
                             onclick="showTransactionDetails({{ t.id }})"
                             style="animation: slideInUp 0.4s ease-out {{ loop.index0 * 0.05 }}s both;">
                            <div class="card h-100" style="border-radius: 16px; {% if t.is_fixed %}border: 3px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);{% else %}border: 1px solid var(--border-color);{% endif %} cursor: pointer; transition: all 0.3s ease; {% if t.is_recurring %}background: linear-gradient(135deg, rgba(59, 130, 246, 0.03), rgba(99, 102, 241, 0.02));{% endif %}{% if t.is_fixed %}background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.03));{% endif %}">
                                <div class="card-body p-3 p-md-4">
                                    <div class="d-flex align-items-start gap-3">
                                        <!-- √çcone da Categoria -->
                                        <div class="flex-shrink-0">
                                            <div class="d-flex align-items-center justify-content-center" 
                                                 style="width: 52px; height: 52px; border-radius: 14px; background: {% if t.type == 'income' %}linear-gradient(135deg, rgba(17, 153, 142, 0.15), rgba(56, 239, 125, 0.1)){% else %}linear-gradient(135deg, rgba(238, 9, 121, 0.15), rgba(255, 106, 0, 0.1)){% endif %}; border: 2px solid {% if t.type == 'income' %}rgba(17, 153, 142, 0.2){% else %}rgba(238, 9, 121, 0.2){% endif %};">
                                                {% if t.category %}
                                                    <span style="font-size: 1.5rem;">{{ t.category.icon }}</span>
                                                {% else %}
                                                    <i class="bi bi-{% if t.type == 'income' %}arrow-up-circle{% else %}arrow-down-circle{% endif %}" style="font-size: 1.5rem; color: {% if t.type == 'income' %}#11998e{% else %}#ee0979{% endif %};"></i>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Conte√∫do Principal -->
                                        <div class="flex-grow-1 min-w-0">
                                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2">
                                                <div class="flex-grow-1">
                                                    <!-- Descri√ß√£o e Data -->
                                                    <h6 class="mb-1 fw-semibold" style="font-size: 1rem; line-height: 1.3;">{{ t.description }}</h6>
                                                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                                        <small class="text-muted d-flex align-items-center">
                                                            <i class="bi bi-calendar3 me-1"></i>
                                                            {{ t.transaction_date.strftime('%d/%m/%Y') }}
                                                        </small>
                                                        {% if t.notes %}
                                                            <small class="text-muted d-flex align-items-center">
                                                                <i class="bi bi-person-badge me-1"></i>
                                                                {{ t.notes }}
                                                            </small>
                                                        {% endif %}
                                                        {% if t.category %}
                                                            <span class="badge rounded-pill" style="background-color: {{ t.category.color }}20; color: {{ t.category.color }}; font-size: 0.7rem; padding: 0.35rem 0.65rem;">
                                                                {{ t.category.icon }} {{ t.category.name }}
                                                            </span>
                                                        {% endif %}
                                                        {% if t.is_fixed %}
                                                            <span class="badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                                                <i class="bi bi-pin-angle-fill me-1"></i>Fixo
                                                            </span>
                                                        {% endif %}
                                                        {% if t.is_recurring %}
                                                            <span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                                                <i class="bi bi-arrow-repeat me-1"></i>Recorrente
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </div>

                                                <!-- Valor e A√ß√µes -->
                                                <div class="d-flex flex-column align-items-end gap-2">
                                                    <div class="fw-bold" style="font-size: 1.25rem; color: {% if t.type == 'income' %}#11998e{% else %}#ee0979{% endif %};">
                                                        {{ '+' if t.type == 'income' else '-' }}R$ {{ "{:,.2f}".format(t.amount).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                                    </div>
                                                    <div class="btn-group btn-group-sm transaction-actions" style="opacity: 0.7; transition: opacity 0.3s ease;">
                                                        <button class="btn btn-sm" onclick="editTransaction({{ t.id }}); event.stopPropagation();" title="Editar" style="border: 1px solid var(--border-color); border-radius: 8px 0 0 8px; padding: 0.4rem 0.7rem;">
                                                            <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                                                        </button>
                                                        <button class="btn btn-sm" onclick="deleteTransaction({{ t.id }}); event.stopPropagation();" title="Excluir" style="border: 1px solid var(--border-color); border-left: none; border-radius: 0 8px 8px 0; padding: 0.4rem 0.7rem;">
                                                            <i class="bi bi-trash" style="font-size: 0.9rem; color: #ef4444;"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="card" style="border-radius: 16px; border: 2px dashed var(--border-color);">
                        <div class="card-body text-center py-5">
                            <div class="mb-3" style="font-size: 4rem; opacity: 0.3;">
                                <i class="bi bi-inbox"></i>
                            </div>
                            <h5 class="mb-2">Nenhuma transa√ß√£o registrada</h5>
                            <p class="text-muted mb-4">Comece adicionando sua primeira transa√ß√£o e acompanhe suas finan√ßas</p>
                            <button class="btn btn-primary" onclick="showAddTransaction('income')" style="border-radius: 10px; padding: 0.6rem 1.5rem;">
                                <i class="bi bi-plus-circle me-2"></i>Primeira Transa√ß√£o
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Mobile -->
 

<!-- Modal Adicionar Transa√ß√£o -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTransactionTitle">Nova Transa√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addTransactionForm">
                <div class="modal-body">
                    <input type="hidden" id="transactionType">
                    
                    <div class="mb-3">
                        <label for="category" class="form-label">Categoria *</label>
                        <select class="form-select" id="category" required>
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="descriptionField" style="display: none;">
                        <label for="description" class="form-label">Nome da Despesa *</label>
                        <input type="text" class="form-control" id="description" placeholder="Ex: Almo√ßo, Gasolina, Conta de √°gua...">
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Observa√ß√£o</label>
                        <input type="text" class="form-control" id="notes" placeholder="Ex: Sal√°rio do Jo√£o, gasto da Maria... (opcional)">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Valor (R$) *</label>
                                <input type="text" class="form-control" id="amount" inputmode="decimal" required placeholder="0,00" autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="transactionDate" class="form-label" id="dateLabel">Data *</label>
                                <input type="date" class="form-control" id="transactionDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isFixed" onchange="toggleFixedDuration()">
                        <label class="form-check-label" for="isFixed">
                            Marcar como fixo (recorrente)
                        </label>
                    </div>
                    
                    <div class="mb-3" id="fixedDurationContainer" style="display: none;">
                        <label class="form-label" id="fixedDurationLabel">Por quantos meses? *</label>

                        <div class="d-flex gap-2 align-items-center flex-wrap">
                            <div class="input-group" style="width: 180px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="stepFixedMonths(-1)">-</button>
                                <input type="number" class="form-control text-center" id="fixedMonths" min="1" max="120" value="12">
                                <button class="btn btn-outline-secondary" type="button" onclick="stepFixedMonths(1)">+</button>
                            </div>

                            <div class="d-flex gap-1 flex-wrap">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="setFixedMonths(6)">6</button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="setFixedMonths(12)">12</button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="setFixedMonths(24)">24</button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="setFixedMonths(36)">36</button>
                            </div>
                        </div>

                        <small class="text-muted" id="fixedDurationHint">Ser√° criada uma transa√ß√£o para cada m√™s.</small>
                        
                        <!-- Preview de Parcelas -->
                        <div id="installmentsPreview" class="mt-3 p-3 rounded" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.05)); border: 1px solid rgba(59, 130, 246, 0.2); display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong class="text-primary"><i class="bi bi-eye me-1"></i>Preview das Parcelas</strong>
                                <span class="badge bg-primary" id="previewTotalBadge">Total: R$ 0,00</span>
                            </div>
                            <div id="previewInstallmentsList" style="max-height: 150px; overflow-y: auto; font-size: 0.85rem;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveButton">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        Salvar Transa√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Hist√≥rico Mensal -->
<div class="modal fade" id="monthlyHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-check me-2"></i>Hist√≥rico de Transa√ß√µes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="historyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions-pane" type="button" role="tab">
                            <i class="bi bi-list-ul me-1"></i>Transa√ß√µes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts-pane" type="button" role="tab" onclick="loadCharts()">
                            <i class="bi bi-bar-chart-line me-1"></i>Gr√°ficos
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="historyTabContent">
                    <!-- Aba Transa√ß√µes -->
                    <div class="tab-pane fade show active" id="transactions-pane" role="tabpanel">
                        <!-- Filtros -->
                        <div class="card mb-3" style="border-radius: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(99, 102, 241, 0.03));">
                            <div class="card-body p-3">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label small mb-1">M√™s</label>
                                        <select class="form-select" id="historyFilterMonth" onchange="loadMonthlyHistory()">
                                            <option value="">Todos os meses</option>
                                            <option value="1">Janeiro</option>
                                            <option value="2">Fevereiro</option>
                                            <option value="3">Mar√ßo</option>
                                            <option value="4">Abril</option>
                                            <option value="5">Maio</option>
                                            <option value="6">Junho</option>
                                            <option value="7">Julho</option>
                                            <option value="8">Agosto</option>
                                            <option value="9">Setembro</option>
                                            <option value="10">Outubro</option>
                                            <option value="11">Novembro</option>
                                            <option value="12">Dezembro</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small mb-1">Ano</label>
                                        <select class="form-select" id="historyFilterYear" onchange="loadMonthlyHistory()">
                                            <option value="">Todos os anos</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-primary w-100" onclick="document.getElementById('historyFilterMonth').value=''; document.getElementById('historyFilterYear').value=''; loadMonthlyHistory();">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Limpar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conte√∫do do hist√≥rico -->
                        <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Gr√°ficos -->
                    <div class="tab-pane fade" id="charts-pane" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Despesas por Categoria</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="categoryChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Evolu√ß√£o Mensal</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="monthlyChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Comparativo Entradas vs Despesas</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="comparisonChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gr√°ficos -->
<div class="modal fade" id="chartsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-bar-chart-line me-2"></i>Gr√°ficos Financeiros
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Despesas por Categoria</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="categoryChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Evolu√ß√£o Mensal</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="monthlyChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Comparativo Entradas vs Despesas</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="comparisonChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Fechamento -->
<div class="modal fade" id="closeMonthModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Fechamento de M√™s
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voc√™ est√° prestes a fechar o m√™s atual. Esta a√ß√£o:</p>
                <ul>
                    <li>‚úÖ Registrar√° todos os totais do m√™s</li>
                    <li>‚úÖ Criar√° um novo m√™s</li>
                    <li>‚úÖ Carregar√° automaticamente as despesas fixas</li>
                </ul>
                <p class="text-muted mb-0"><small>Esta a√ß√£o n√£o pode ser desfeita. Deseja continuar?</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="executeCloseMonth()">
                    <i class="bi bi-lock me-1"></i>Fechar M√™s
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Boas-vindas (Primeiro Acesso) -->
<div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-hand-wave me-2"></i>Bem-vindo ao Sistema Financeiro!
                </h5>
            </div>
            <div class="modal-body">
                <div id="welcomeContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Workspaces -->
<div class="modal fade" id="workspacesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-folder me-2"></i>Gerenciar Workspaces
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Abas -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="my-workspaces-tab" data-bs-toggle="tab" data-bs-target="#my-workspaces" type="button" role="tab" onclick="loadWorkspacesInModal()">
                            <i class="bi bi-folder me-1"></i>Meus Workspaces
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="new-workspace-tab" data-bs-toggle="tab" data-bs-target="#new-workspace" type="button" role="tab">
                            <i class="bi bi-plus-circle me-1"></i>Novo Workspace
                        </button>
                    </li>
                </ul>

                <!-- Conte√∫do das Abas -->
                <div class="tab-content">
                    <!-- Aba: Meus Workspaces -->
                    <div class="tab-pane fade show active" id="my-workspaces" role="tabpanel">
                        <div id="workspacesListContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba: Novo Workspace -->
                    <div class="tab-pane fade" id="new-workspace" role="tabpanel">
                        <div class="mb-3">
                            <label for="newWsName" class="form-label">Nome do Workspace *</label>
                            <input type="text" class="form-control" id="newWsName" placeholder="Ex: Fam√≠lia, Neg√≥cio...">
                        </div>
                        <div class="mb-3">
                            <label for="newWsDesc" class="form-label">Descri√ß√£o (opcional)</label>
                            <input type="text" class="form-control" id="newWsDesc" placeholder="Descri√ß√£o do workspace">
                        </div>
                        <div class="mb-3">
                            <label for="newWsColor" class="form-label">Cor</label>
                            <div class="d-flex gap-2">
                                <input type="color" class="form-control" id="newWsColor" value="#3b82f6" style="width: 60px;">
                                <input type="text" class="form-control" id="newWsColorText" value="#3b82f6" readonly>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="createWorkspaceFromModal()">
                            <i class="bi bi-check me-1"></i>Criar Workspace
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Compartilhar Workspace -->
<div class="modal fade" id="shareWorkspaceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-share me-2"></i>Compartilhar Workspace
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareWorkspaceSelect" class="form-label">Workspace a compartilhar *</label>
                    <select class="form-select" id="shareWorkspaceSelect">
                        <option value="">Carregando workspaces...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="inviteEmail" class="form-label">Email do usu√°rio *</label>
                    <input type="email" class="form-control" id="inviteEmail" placeholder="usuario@exemplo.com">
                </div>
                
                <div class="mb-3">
                    <label for="inviteRole" class="form-label">Fun√ß√£o no Workspace *</label>
                    <select class="form-select" id="inviteRole">
                        <option value="viewer">üëÅÔ∏è Visualizador - Apenas visualiza transa√ß√µes</option>
                        <option value="editor" selected>‚úèÔ∏è Editor - Pode criar e editar transa√ß√µes</option>
                        <option value="owner">üëë Co-propriet√°rio - Controle total</option>
                    </select>
                    <div class="form-text">
                        A pessoa receber√° um email com o convite e poder√° aceitar ou recusar.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="sendInvite()">
                    <i class="bi bi-send me-1"></i>Enviar Convite
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Convites Pendentes -->
<div class="modal fade" id="pendingInvitesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-envelope-open me-2"></i>Convites Pendentes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pendingInvitesList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_styles %}
<style>
    /* Hover effect para cards de workspace */
    .hover-card {
        transition: all 0.3s ease !important;
    }
    
    .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Responsividade mobile */
    @media (max-width: 768px) {
        .hover-card .btn-group {
            flex-direction: column;
        }
        
        .hover-card .btn-group .btn {
            margin-bottom: 0.25rem;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script defer>
let __editScopeResolve = null;
let currentEditScope = 'single';

document.addEventListener('DOMContentLoaded', () => {
    const scopeEl = document.getElementById('editScopeModal');
    const singleBtn = document.getElementById('editScopeSingleBtn');
    const seriesBtn = document.getElementById('editScopeSeriesBtn');
    if (scopeEl && singleBtn && seriesBtn) {
        singleBtn.addEventListener('click', () => {
            if (__editScopeResolve) __editScopeResolve('single');
            __editScopeResolve = null;
            try { bootstrap.Modal.getInstance(scopeEl)?.hide(); } catch (e) {}
        });
        seriesBtn.addEventListener('click', () => {
            if (__editScopeResolve) __editScopeResolve('series');
            __editScopeResolve = null;
            try { bootstrap.Modal.getInstance(scopeEl)?.hide(); } catch (e) {}
        });
        scopeEl.addEventListener('hidden.bs.modal', () => {
            if (__editScopeResolve) {
                __editScopeResolve(null);
                __editScopeResolve = null;
            }
        });
    }
});

function _chooseEditScope() {
    const scopeEl = document.getElementById('editScopeModal');
    if (!scopeEl) return Promise.resolve('single');
    const modal = bootstrap.Modal.getOrCreateInstance(scopeEl);
    return new Promise((resolve) => {
        __editScopeResolve = resolve;
        modal.show();
    });
}

function _parseBRL(value) {
    const s = String(value ?? '').trim();
    if (!s) return 0;
    const cleaned = s.replace(/[^0-9,.-]/g, '');
    if (!cleaned) return 0;
    if (cleaned.includes(',')) {
        const parts = cleaned.split(',');
        const dec = (parts.pop() || '').replace(/\./g, '').replace(/[^0-9]/g, '');
        const intPart = parts.join('').replace(/\./g, '').replace(/[^0-9-]/g, '');
        const numStr = `${intPart || '0'}.${dec}`;
        const n = parseFloat(numStr);
        return Number.isFinite(n) ? n : 0;
    }
    const numStr = cleaned.replace(/\./g, '');
    const n = parseFloat(numStr);
    return Number.isFinite(n) ? n : 0;
}

function _formatBRLInputFromDigits(digits) {
    const d = String(digits || '').replace(/\D/g, '');
    if (!d) return '';
    const n = Number(d) / 100;
    if (!Number.isFinite(n)) return '';
    return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function _setupAmountMask() {
    const el = document.getElementById('amount');
    if (!el) return;
    if (el.dataset.masked === '1') return;
    el.dataset.masked = '1';

    const handler = () => {
        const digits = el.value.replace(/\D/g, '');
        const formatted = _formatBRLInputFromDigits(digits);
        el.value = formatted;
        try { el.setSelectionRange(el.value.length, el.value.length); } catch (e) {}
    };

    el.addEventListener('input', handler);
    el.addEventListener('blur', handler);
}

window.showAiRecommendationsModal = function() {
    const modalEl = document.getElementById('aiRecommendationsModal');
    if (!modalEl) return;
    const output = document.getElementById('aiRecommendationOutput');
    if (output) output.textContent = '';
    const cached = document.getElementById('aiRecommendationCached');
    if (cached) cached.style.display = 'none';
    const err = document.getElementById('aiRecommendationError');
    if (err) {
        err.style.display = 'none';
        err.textContent = '';
    }
    const preset = document.getElementById('aiRecommendationPreset');
    if (preset) preset.value = 'general';

    const period = document.getElementById('aiRecommendationPeriod');
    if (period) period.value = '30';

    const focus = document.getElementById('aiRecommendationFocus');
    if (focus) focus.value = 'overall';

    const focusWrap = document.getElementById('aiRecommendationCategoryWrap');
    if (focusWrap) focusWrap.style.display = 'none';

    try {
        if (focus && !focus.__ai_bound) {
            focus.__ai_bound = true;
            focus.addEventListener('change', () => {
                const wrap = document.getElementById('aiRecommendationCategoryWrap');
                const category = document.getElementById('aiRecommendationCategory');
                if (!wrap) return;
                if (focus.value === 'category') {
                    wrap.style.display = '';
                    if (category && (!category.options || category.options.length <= 1)) {
                        window._aiLoadCategories && window._aiLoadCategories();
                    }
                } else {
                    wrap.style.display = 'none';
                }
            });
        }
    } catch (e) {}

    if (window._aiLoadCategories) {
        window._aiLoadCategories();
    }
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
};

window._aiLoadCategories = async function() {
    const select = document.getElementById('aiRecommendationCategory');
    if (!select) return;

    select.innerHTML = '<option value="">Carregando...</option>';

    try {
        const all = [];
        for (const t of ['expense', 'income']) {
            const r = await fetch(`{{ url_for('gerenciamento_financeiro.api_categories') }}?type=${t}`);
            const d = await r.json().catch(() => ({}));
            if (d && d.categories && Array.isArray(d.categories)) {
                d.categories.forEach(c => {
                    all.push({
                        id: c.id,
                        name: c.name,
                        type: t,
                        icon: c.icon || ''
                    });
                });
            }
        }

        all.sort((a, b) => (a.name || '').localeCompare((b.name || ''), 'pt-BR'));

        select.innerHTML = '<option value="">Selecione...</option>';
        all.forEach(c => {
            const opt = document.createElement('option');
            opt.value = String(c.id);
            opt.textContent = `${c.icon ? c.icon + ' ' : ''}${c.name} (${c.type === 'expense' ? 'despesa' : 'entrada'})`;
            opt.setAttribute('data-name', c.name || '');
            opt.setAttribute('data-type', c.type || '');
            select.appendChild(opt);
        });
    } catch (e) {
        select.innerHTML = '<option value="">Falha ao carregar categorias</option>';
    }
};

window.requestAiRecommendations = async function() {
    const btn = document.getElementById('aiRecommendationBtn');
    const spinner = document.getElementById('aiRecommendationSpinner');
    const output = document.getElementById('aiRecommendationOutput');
    const cached = document.getElementById('aiRecommendationCached');
    const err = document.getElementById('aiRecommendationError');

    if (output) output.textContent = '';
    if (cached) cached.style.display = 'none';
    if (err) {
        err.style.display = 'none';
        err.textContent = '';
    }

    const presetEl = document.getElementById('aiRecommendationPreset');
    const preset = presetEl ? (presetEl.value || 'general') : 'general';

    const periodEl = document.getElementById('aiRecommendationPeriod');
    const periodDays = periodEl ? (periodEl.value || '90') : '90';

    const focusEl = document.getElementById('aiRecommendationFocus');
    const focus = focusEl ? (focusEl.value || 'overall') : 'overall';

    const categoryEl = document.getElementById('aiRecommendationCategory');
    const selectedCategoryOpt = (categoryEl && categoryEl.selectedOptions && categoryEl.selectedOptions[0]) ? categoryEl.selectedOptions[0] : null;
    const selectedCategoryName = selectedCategoryOpt ? (selectedCategoryOpt.getAttribute('data-name') || '') : '';
    const selectedCategoryType = selectedCategoryOpt ? (selectedCategoryOpt.getAttribute('data-type') || '') : '';

    const presetContextMap = {
        general: 'Gere uma recomenda√ß√£o completa e autom√°tica para melhorar a sa√∫de financeira com base nos dados do workspace.',
        vacation: 'Gere um plano para preparar e organizar finan√ßas para f√©rias (antecipar despesas, metas, cortes e cronograma).',
        debt: 'Gere um plano para quitar d√≠vidas/parcelas e organizar pagamentos, priorizando juros e fluxo de caixa.',
        cut_expenses: 'Gere um plano para cortar gastos: identificar categorias que mais pesam e sugerir cortes pr√°ticos.',
        increase_income: 'Gere um plano para aumentar renda: ideias, metas e como reinvestir/organizar o or√ßamento.',
        emergency_fund: 'Gere um plano para montar reserva de emerg√™ncia com metas, prazos e percentual da renda.'
    };

    let ctx = presetContextMap[preset] || presetContextMap.general;
    ctx += `\n\nPer√≠odo selecionado: √∫ltimos ${periodDays} dias.`;
    if (focus === 'category') {
        if (!selectedCategoryName) {
            ctx += '\nFoco: categoria espec√≠fica (n√£o selecionada). Sugira quais categorias seriam mais relevantes e pe√ßa para selecionar uma.';
        } else {
            ctx += `\nFoco: categoria ${selectedCategoryName} (${selectedCategoryType === 'expense' ? 'despesa' : 'entrada'}).`;
            ctx += '\nAnalise essa categoria e sugira a√ß√µes espec√≠ficas.';
        }
    } else {
        ctx += '\nFoco: vis√£o geral do workspace.';
    }

    try {
        if (btn) btn.disabled = true;
        if (spinner) spinner.style.display = 'inline-block';

        const resp = await fetch('{{ url_for("gerenciamento_financeiro.api_ai_recommendations") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                workspace_id: {{ active_workspace.id if active_workspace else 'null' }},
                period_days: Number(periodDays),
                focus: focus,
                category_id: (focus === 'category' && categoryEl && categoryEl.value) ? Number(categoryEl.value) : null,
                context: ctx
            })
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
            let msg = (data && data.error) ? data.error : 'Erro ao gerar recomenda√ß√£o.';
            if (data && data.details) {
                try {
                    const detailsStr = (typeof data.details === 'string') ? data.details : JSON.stringify(data.details);
                    msg = msg + ' - ' + detailsStr;
                } catch (e) {}
            }
            if (err) {
                err.style.display = 'block';
                err.textContent = msg;
            }
            window.showToast(msg, 'warning');
            return;
        }

        if (cached && data && data.cached) {
            cached.style.display = 'inline-block';
        }
        if (output) {
            output.textContent = data && data.recommendation ? data.recommendation : '';
        }
    } catch (e) {
        const msg = 'Falha ao gerar recomenda√ß√£o de IA.';
        if (err) {
            err.style.display = 'block';
            err.textContent = msg;
        }
        window.showToast(msg, 'error');
    } finally {
        if (btn) btn.disabled = false;
        if (spinner) spinner.style.display = 'none';
    }
};

let currentEditingId = null;

document.addEventListener('DOMContentLoaded', () => {
    const d = document.getElementById('transactionDate');
    if (d) d.value = new Date().toISOString().split('T')[0];
    const f = document.getElementById('addTransactionForm');
    if (f) f.addEventListener('submit', saveTransaction);
    setupPreviewListeners();
});

// Vari√°veis para controle das abas de transa√ß√µes
let currentTransactionsTab = 'mesAtual';
let allTransactionsCache = null;

// Vari√°veis para filtro global de m√™s/ano
let globalFilterMonth = ({{ selected_month|default(None)|tojson }}) || (new Date().getMonth() + 1);
let globalFilterYear = ({{ selected_year|default(None)|tojson }}) || (new Date().getFullYear());

// Inicializar filtro de m√™s/ano
function initGlobalFilter() {
    const monthSelect = document.getElementById('filterMonth');
    const yearSelect = document.getElementById('filterYear');
    
    if (!monthSelect || !yearSelect) return;
    
    // Selecionar m√™s atual
    monthSelect.value = globalFilterMonth;
    
    // Preencher anos (ano atual - 2 at√© ano atual + 1)
    const currentYear = new Date().getFullYear();
    yearSelect.innerHTML = '';
    for (let y = currentYear - 2; y <= currentYear + 1; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y === globalFilterYear) opt.selected = true;
        yearSelect.appendChild(opt);
    }
}

// Aplicar filtro global (server-driven: recarrega a p√°gina)
function applyGlobalFilter() {
    const monthSelect = document.getElementById('filterMonth');
    const yearSelect = document.getElementById('filterYear');

    if (monthSelect && yearSelect) {
        globalFilterMonth = parseInt(monthSelect.value);
        globalFilterYear = parseInt(yearSelect.value);
    }

    const baseUrl = '{{ url_for("gerenciamento_financeiro.home") }}';
    window.location.href = `${baseUrl}?month=${encodeURIComponent(globalFilterMonth)}&year=${encodeURIComponent(globalFilterYear)}`;
}

// Carregar cards de resumo (receitas/despesas) filtrados por m√™s/ano
async function loadSummaryCards() {
    try {
        const url = `/gerenciamento-financeiro/api/transactions?limit=1000&year=${globalFilterYear}&month=${globalFilterMonth}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) return;
        
        const transactions = data.transactions || [];
        
        let totalIncome = 0;
        let totalExpense = 0;
        
        transactions.forEach(t => {
            if (t.type === 'income') {
                totalIncome += t.amount;
            } else {
                totalExpense += t.amount;
            }
        });
        
        const balance = totalIncome - totalExpense;
        
        // Atualizar cards
        const incomeEl = document.getElementById('totalIncome');
        const expenseEl = document.getElementById('totalExpense');
        const balanceEl = document.getElementById('totalBalance');
        
        const formatBRL = (v) => v.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        if (incomeEl) incomeEl.textContent = `+R$ ${formatBRL(totalIncome)}`;
        if (expenseEl) expenseEl.textContent = `-R$ ${formatBRL(totalExpense)}`;
        if (balanceEl) {
            balanceEl.textContent = `${balance >= 0 ? '+' : '-'}R$ ${formatBRL(Math.abs(balance))}`;
            balanceEl.style.color = balance >= 0 ? '#11998e' : '#ee0979';
        }
        
    } catch (error) {
        console.error('Erro ao carregar resumo:', error);
    }
}

// Inicializar filtro ao carregar p√°gina
document.addEventListener('DOMContentLoaded', () => {
    initGlobalFilter();
});

async function switchTransactionsTab(tab) {
    currentTransactionsTab = tab;
    
    // Atualizar estilos das abas
    const tabMesAtual = document.getElementById('tabMesAtual');
    const tabTodas = document.getElementById('tabTodas');
    
    if (tab === 'mesAtual') {
        tabMesAtual.style.borderBottomColor = '#3b82f6';
        tabMesAtual.style.color = '#3b82f6';
        tabTodas.style.borderBottomColor = 'transparent';
        tabTodas.style.color = 'var(--text-secondary)';
    } else {
        tabTodas.style.borderBottomColor = '#3b82f6';
        tabTodas.style.color = '#3b82f6';
        tabMesAtual.style.borderBottomColor = 'transparent';
        tabMesAtual.style.color = 'var(--text-secondary)';
    }
    
    // M√™s Atual: volta pro server-render (evita misturar com lista "Todas")
    if (tab === 'mesAtual') {
        const baseUrl = '{{ url_for("gerenciamento_financeiro.home") }}';
        window.location.href = `${baseUrl}?month=${encodeURIComponent(globalFilterMonth)}&year=${encodeURIComponent(globalFilterYear)}`;
        return;
    }

    // Todas: carrega via API
    await loadTransactionsForTab(tab);
}

async function loadTransactionsForTab(tab) {
    const container = document.getElementById('recentTransactionsTbody');
    if (!container) return;

    if (tab !== 'todas') {
        return;
    }
    
    // Mostrar loading
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    `;
    
    try {
        let url = '/gerenciamento-financeiro/api/transactions?limit=100';
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) {
            container.innerHTML = '<div class="alert alert-danger">Erro ao carregar transa√ß√µes.</div>';
            return;
        }
        
        const transactions = data.transactions || [];
        
        // Atualizar contador
        const countBadge = document.getElementById('transactionsCount');
        if (countBadge) {
            countBadge.textContent = `${transactions.length} ${tab === 'mesAtual' ? 'este m√™s' : 'total'}`;
        }
        
        if (transactions.length === 0) {
            container.innerHTML = `
                <div class="card" style="border-radius: 16px; border: 2px dashed var(--border-color);">
                    <div class="card-body text-center py-4">
                        <i class="bi bi-inbox" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        <p class="text-muted mt-2 mb-0">${tab === 'mesAtual' ? 'Nenhuma transa√ß√£o este m√™s' : 'Nenhuma transa√ß√£o encontrada'}</p>
                    </div>
                </div>
            `;
            return;
        }
        
        // Renderizar transa√ß√µes
        let html = '';
        transactions.forEach((t, index) => {
            const date = new Date(t.transaction_date);
            const formattedDate = date.toLocaleDateString('pt-BR');
            const categoryIcon = t.category?.icon || (t.type === 'income' ? 'üíµ' : 'üí∏');
            const categoryName = t.category?.name || '';
            const categoryColor = t.category?.color || (t.type === 'income' ? '#11998e' : '#ee0979');
            
            const iconBg = t.type === 'income' 
                ? 'linear-gradient(135deg, rgba(17, 153, 142, 0.15), rgba(56, 239, 125, 0.1))'
                : 'linear-gradient(135deg, rgba(238, 9, 121, 0.15), rgba(255, 106, 0, 0.1))';
            const iconBorder = t.type === 'income' ? 'rgba(17, 153, 142, 0.2)' : 'rgba(238, 9, 121, 0.2)';
            const valueColor = t.type === 'income' ? '#11998e' : '#ee0979';
            const sign = t.type === 'income' ? '+' : '-';
            
            const fixedBorder = t.is_fixed ? 'border: 3px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);' : 'border: 1px solid var(--border-color);';
            const fixedBg = t.is_fixed ? 'background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.03));' : '';
            
            const fixedBadge = t.is_fixed ? '<span class="badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 0.65rem; padding: 0.25rem 0.5rem; border-radius: 6px;"><i class="bi bi-pin-angle-fill me-1"></i>Fixo</span>' : '';
            const recurringBadge = t.is_recurring ? '<span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-size: 0.65rem; padding: 0.25rem 0.5rem; border-radius: 6px;"><i class="bi bi-arrow-repeat me-1"></i>Recorrente</span>' : '';
            
            const amount = Number(t.amount || 0).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            html += `
                <div data-transaction-id="${t.id}" class="transaction-card" onclick="showTransactionDetails(${t.id})" style="animation: slideInUp 0.3s ease-out ${index * 0.03}s both;">
                    <div class="card h-100" style="border-radius: 16px; ${fixedBorder} cursor: pointer; transition: all 0.3s ease; ${fixedBg}">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center gap-3">
                                <div class="flex-shrink-0">
                                    <div class="d-flex align-items-center justify-content-center" style="width: 44px; height: 44px; border-radius: 12px; background: ${iconBg}; border: 2px solid ${iconBorder};">
                                        <span style="font-size: 1.2rem;">${categoryIcon}</span>
                                    </div>
                                </div>
                                <div class="flex-grow-1 min-w-0">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1" style="min-width: 0;">
                                            <h6 class="mb-0 fw-semibold text-truncate" style="font-size: 0.95rem;">${t.description || 'Sem descri√ß√£o'}</h6>
                                            <div class="d-flex flex-wrap align-items-center gap-1 mt-1">
                                                <small class="text-muted"><i class="bi bi-calendar3 me-1"></i>${formattedDate}</small>
                                                ${categoryName ? `<span class="badge rounded-pill" style="background-color: ${categoryColor}20; color: ${categoryColor}; font-size: 0.6rem; padding: 0.2rem 0.5rem;">${categoryName}</span>` : ''}
                                                ${fixedBadge}
                                                ${recurringBadge}
                                            </div>
                                        </div>
                                        <div class="text-end ms-2">
                                            <div class="fw-bold" style="font-size: 1.1rem; color: ${valueColor}; white-space: nowrap;">${sign}R$ ${amount}</div>
                                            <div class="btn-group btn-group-sm mt-1">
                                                <button class="btn btn-sm px-2 py-1" onclick="editTransaction(${t.id}); event.stopPropagation();" title="Editar" style="border: 1px solid var(--border-color); border-radius: 6px 0 0 6px;">
                                                    <i class="bi bi-pencil" style="font-size: 0.75rem;"></i>
                                                </button>
                                                <button class="btn btn-sm px-2 py-1" onclick="deleteTransaction(${t.id}); event.stopPropagation();" title="Excluir" style="border: 1px solid var(--border-color); border-left: none; border-radius: 0 6px 6px 0;">
                                                    <i class="bi bi-trash" style="font-size: 0.75rem; color: #ef4444;"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Erro ao carregar transa√ß√µes:', error);
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar transa√ß√µes.</div>';
    }
}


function toggleFixedDuration() {
    const isFixed = document.getElementById('isFixed').checked;
    const container = document.getElementById('fixedDurationContainer');
    if (container) {
        container.style.display = isFixed ? 'block' : 'none';
    }

    if (isFixed) {
        updateFixedDurationUI();
    }
}

function _normalizeFixedMonths(value) {
    const input = document.getElementById('fixedMonths');
    const min = Number(input?.min || 1);
    const max = Number(input?.max || 120);
    const n = parseInt(value, 10);
    if (Number.isNaN(n)) return Math.max(min, Math.min(12, max));
    return Math.max(min, Math.min(n, max));
}

function setFixedMonths(value) {
    const input = document.getElementById('fixedMonths');
    if (!input) return;
    input.value = _normalizeFixedMonths(value);
}

function stepFixedMonths(delta) {
    const input = document.getElementById('fixedMonths');
    if (!input) return;
    const current = _normalizeFixedMonths(input.value);
    setFixedMonths(current + delta);
}

function updateFixedDurationUI() {
    const type = document.getElementById('transactionType')?.value;
    const label = document.getElementById('fixedDurationLabel');
    const hint = document.getElementById('fixedDurationHint');

    if (type === 'expense') {
        if (label) label.textContent = 'Qtd de parcelas *';
        if (hint) hint.textContent = 'Ser√° criada uma despesa para cada parcela (m√™s).';
    } else {
        if (label) label.textContent = 'Por quantos meses? *';
        if (hint) hint.textContent = 'Ser√° criada uma transa√ß√£o para cada m√™s.';
    }
    
    updateInstallmentsPreview();
}

function updateInstallmentsPreview() {
    const isFixed = document.getElementById('isFixed')?.checked;
    const preview = document.getElementById('installmentsPreview');
    const list = document.getElementById('previewInstallmentsList');
    const totalBadge = document.getElementById('previewTotalBadge');
    
    if (!preview || !list || !totalBadge) return;
    
    if (!isFixed) {
        preview.style.display = 'none';
        return;
    }
    
    const amount = _parseBRL(document.getElementById('amount')?.value || '0');
    const months = Math.min(120, Math.max(1, parseInt(document.getElementById('fixedMonths')?.value) || 12));
    const startDate = document.getElementById('transactionDate')?.value;
    const categorySelect = document.getElementById('category');
    const categoryName = categorySelect?.selectedIndex > 0 ? categorySelect.options[categorySelect.selectedIndex].text.replace(/^[^\s]+\s/, '') : '';
    const description = document.getElementById('description')?.value || categoryName || 'Despesa';
    
    if (!amount || amount <= 0) {
        preview.style.display = 'none';
        return;
    }
    
    preview.style.display = 'block';
    
    const total = amount * months;
    totalBadge.textContent = `Total: R$ ${_formatBRL(total)}`;
    
    let html = '<div class="row g-1">';
    const baseDate = startDate ? new Date(startDate + 'T12:00:00') : new Date();
    
    const maxShow = Math.min(months, 6);
    for (let i = 0; i < maxShow; i++) {
        const installmentDate = new Date(baseDate);
        installmentDate.setMonth(installmentDate.getMonth() + i);
        const dateStr = installmentDate.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
        const installmentDesc = `${description} ${i + 1}/${months}`;
        
        html += `
            <div class="col-6 col-md-4">
                <div class="d-flex align-items-center gap-1 p-1 rounded" style="background: rgba(255,255,255,0.5);">
                    <span class="badge bg-secondary" style="font-size: 0.7rem;">${i + 1}</span>
                    <div class="flex-grow-1 text-truncate" style="font-size: 0.75rem;">
                        <div class="text-truncate fw-medium">${installmentDesc}</div>
                        <small class="text-muted">${dateStr} ¬∑ R$ ${_formatBRL(amount)}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (months > maxShow) {
        html += `
            <div class="col-12 text-center text-muted" style="font-size: 0.75rem;">
                <i class="bi bi-three-dots"></i> e mais ${months - maxShow} parcelas
            </div>
        `;
    }
    
    html += '</div>';
    list.innerHTML = html;
}

function setupPreviewListeners() {
    const amountEl = document.getElementById('amount');
    const monthsEl = document.getElementById('fixedMonths');
    const dateEl = document.getElementById('transactionDate');
    const categoryEl = document.getElementById('category');
    const descEl = document.getElementById('description');
    
    const update = () => updateInstallmentsPreview();
    
    if (amountEl) amountEl.addEventListener('input', update);
    if (monthsEl) monthsEl.addEventListener('input', update);
    if (dateEl) dateEl.addEventListener('change', update);
    if (categoryEl) categoryEl.addEventListener('change', update);
    if (descEl) descEl.addEventListener('input', update);
}

function showAddTransaction(type) {
    const m = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    const t = document.getElementById('addTransactionTitle');
    const ti = document.getElementById('transactionType');
    const sb = document.getElementById('saveButton');
    const dateLabel = document.getElementById('dateLabel');
    document.getElementById('addTransactionForm').reset();
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    _setupAmountMask();
    
    // Reset fixed duration fields and preview
    const fixedContainer = document.getElementById('fixedDurationContainer');
    if (fixedContainer) fixedContainer.style.display = 'none';
    const preview = document.getElementById('installmentsPreview');
    if (preview) preview.style.display = 'none';
    
    currentEditingId = null;
    ti.value = type;
    if (type === 'income') {
        t.innerHTML = '<i class="bi bi-plus-circle text-success me-2"></i>Nova Entrada';
        sb.className = 'btn btn-success';
        sb.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Entrada';
        if (dateLabel) dateLabel.textContent = 'Dt de entrada do dinheiro na conta *';
    } else {
        t.innerHTML = '<i class="bi bi-dash-circle text-danger me-2"></i>Nova Despesa';
        sb.className = 'btn btn-danger';
        sb.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Despesa';
        if (dateLabel) dateLabel.textContent = 'Data de vencimento *';
    }

    updateFixedDurationUI();
    loadCategories(type);
    m.show();
}

async function loadCategories(type) {
    try {
        const r = await fetch(`{{ url_for('gerenciamento_financeiro.api_categories') }}?type=${type}`);
        const d = await r.json();
        const s = document.getElementById('category');
        s.innerHTML = '<option value="">Selecione uma categoria</option>';
        if (d.categories) d.categories.forEach(c => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = `${c.icon || 'üí∞'} ${c.name}`;
            s.appendChild(o);
        });
    } catch (e) {
        console.error('Erro:', e);
    }
}

async function saveTransaction(e) {
    e.preventDefault();
    const btn = document.getElementById('saveButton');
    const sp = btn.querySelector('.spinner-border');
    btn.disabled = true;
    sp.classList.remove('d-none');
    
    const isFixed = document.getElementById('isFixed').checked;
    const fixedMonths = Math.min(120, Math.max(1, parseInt(document.getElementById('fixedMonths')?.value) || 12));
    
    const fd = {
        type: document.getElementById('transactionType').value,
        description: document.getElementById('description').value || document.getElementById('category').options[document.getElementById('category').selectedIndex].text,
        notes: document.getElementById('notes') ? (document.getElementById('notes').value || null) : null,
        amount: _parseBRL(document.getElementById('amount').value),
        transaction_date: document.getElementById('transactionDate').value,
        category_id: document.getElementById('category').value,
        frequency: 'once',
        is_recurring: isFixed,
        is_fixed: isFixed,
        fixed_duration_type: isFixed ? 'months' : null,
        fixed_months: isFixed ? fixedMonths : null,
        apply_scope: currentEditScope
    };
    
    try {
        let url = '/gerenciamento-financeiro/api/transactions';
        const editingId = currentEditingId;
        if (editingId) url += `/${editingId}`;
        
        const r = await fetch(url, {
            method: editingId ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fd)
        });
        
        const res = await r.json();
        if (r.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
            document.getElementById('addTransactionForm').reset();
            currentEditingId = null;
            
            // Se foi cria√ß√£o de transa√ß√µes recorrentes, recarregar p√°gina
            if (res.created && res.created > 1) {
                showToast(res.message || `${res.created} transa√ß√µes criadas!`, 'success');
                setTimeout(() => location.reload(), 800);
            } else if (editingId) {
                if (currentEditScope === 'series' && res.updated_count && res.updated_count > 1) {
                    showToast(res.message || 'Atualizado!', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    showToast('Atualizado!', 'success');
                    upsertTransactionRow(res);
                }
            } else {
                showToast('Salvo!', 'success');
                addTransactionToTable(res);
            }
        } else {
            showToast(res.error || 'Erro', 'error');
        }
    } catch (e) {
        showToast('Erro', 'error');
    } finally {
        btn.disabled = false;
        sp.classList.add('d-none');
    }
}

function _formatBRL(value) {
    const n = Number(value || 0);
    return n.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function _getRecentContainer() {
    return document.getElementById('recentTransactionsTbody');
}

function _buildTransactionCard(t) {
    const date = new Date(t.transaction_date);
    const formattedDate = date.toLocaleDateString('pt-BR');
    
    const categoryIcon = t.category?.icon || (t.type === 'income' ? 'üíµ' : 'üí∏');
    const categoryName = t.category?.name || '';
    const categoryColor = t.category?.color || (t.type === 'income' ? '#11998e' : '#ee0979');
    
    const iconBg = t.type === 'income' 
        ? 'linear-gradient(135deg, rgba(17, 153, 142, 0.15), rgba(56, 239, 125, 0.1))'
        : 'linear-gradient(135deg, rgba(238, 9, 121, 0.15), rgba(255, 106, 0, 0.1))';
    const iconBorder = t.type === 'income' ? 'rgba(17, 153, 142, 0.2)' : 'rgba(238, 9, 121, 0.2)';
    const iconFallback = t.type === 'income' ? 'arrow-up-circle' : 'arrow-down-circle';
    const iconColor = t.type === 'income' ? '#11998e' : '#ee0979';
    
    const categoryBadge = t.category 
        ? `<span class="badge rounded-pill" style="background-color: ${categoryColor}20; color: ${categoryColor}; font-size: 0.7rem; padding: 0.35rem 0.65rem;">
                ${categoryIcon} ${categoryName}
           </span>`
        : '';
    
    const fixedBadge = t.is_fixed
        ? `<span class="badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                <i class="bi bi-pin-angle-fill me-1"></i>Fixo
           </span>`
        : '';
    
    const recurringBadge = t.is_recurring
        ? `<span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                <i class="bi bi-arrow-repeat me-1"></i>Recorrente
           </span>`
        : '';

    const notesLine = t.notes
        ? `<small class="text-muted d-flex align-items-center">
                <i class="bi bi-person-badge me-1"></i>
                ${String(t.notes)}
           </small>`
        : '';
    
    const amountColor = t.type === 'income' ? '#11998e' : '#ee0979';
    const amountSign = t.type === 'income' ? '+' : '-';
    
    const recurringBg = t.is_recurring ? 'background: linear-gradient(135deg, rgba(59, 130, 246, 0.03), rgba(99, 102, 241, 0.02));' : '';
    const fixedHighlight = t.is_fixed
        ? 'border: 3px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2); background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.03));'
        : 'border: 1px solid var(--border-color);';
    
    return `
        <div class="card h-100" style="border-radius: 16px; ${fixedHighlight} cursor: pointer; transition: all 0.3s ease; ${recurringBg}">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex align-items-start gap-3">
                    <!-- √çcone da Categoria -->
                    <div class="flex-shrink-0">
                        <div class="d-flex align-items-center justify-content-center" 
                             style="width: 52px; height: 52px; border-radius: 14px; background: ${iconBg}; border: 2px solid ${iconBorder};">
                            ${t.category 
                                ? `<span style="font-size: 1.5rem;">${categoryIcon}</span>`
                                : `<i class="bi bi-${iconFallback}" style="font-size: 1.5rem; color: ${iconColor};"></i>`
                            }
                        </div>
                    </div>

                    <!-- Conte√∫do Principal -->
                    <div class="flex-grow-1 min-w-0">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2">
                            <div class="flex-grow-1">
                                <!-- Descri√ß√£o e Data -->
                                <h6 class="mb-1 fw-semibold" style="font-size: 1rem; line-height: 1.3;">${t.description || 'Sem descri√ß√£o'}</h6>
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                    <small class="text-muted d-flex align-items-center">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        ${formattedDate}
                                    </small>
                                    ${notesLine}
                                    ${categoryBadge}
                                    ${fixedBadge}
                                    ${recurringBadge}
                                </div>
                            </div>

                            <!-- Valor e A√ß√µes -->
                            <div class="d-flex flex-column align-items-end gap-2">
                                <div class="fw-bold" style="font-size: 1.25rem; color: ${amountColor};">
                                    ${amountSign}R$ ${_formatBRL(t.amount)}
                                </div>
                                <div class="btn-group btn-group-sm transaction-actions" style="opacity: 0.7; transition: opacity 0.3s ease;">
                                    <button class="btn btn-sm" onclick="editTransaction(${t.id}); event.stopPropagation();" title="Editar" style="border: 1px solid var(--border-color); border-radius: 8px 0 0 8px; padding: 0.4rem 0.7rem;">
                                        <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                                    </button>
                                    <button class="btn btn-sm" onclick="deleteTransaction(${t.id}); event.stopPropagation();" title="Excluir" style="border: 1px solid var(--border-color); border-left: none; border-radius: 0 8px 8px 0; padding: 0.4rem 0.7rem;">
                                        <i class="bi bi-trash" style="font-size: 0.9rem; color: #ef4444;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function upsertTransactionRow(t) {
    const existing = document.querySelector(`[data-transaction-id="${t.id}"]`);
    if (!existing) {
        addTransactionToTable(t);
        return;
    }

    existing.setAttribute('onclick', `showTransactionDetails(${t.id})`);
    existing.innerHTML = _buildTransactionCard(t);
}

function addTransactionToTable(t) {
    const container = _getRecentContainer();
    if (!container) return;

    const cardWrapper = document.createElement('div');
    cardWrapper.setAttribute('data-transaction-id', t.id);
    cardWrapper.className = 'transaction-card';
    cardWrapper.setAttribute('onclick', `showTransactionDetails(${t.id})`);
    cardWrapper.style.animation = 'slideInUp 0.4s ease-out both';
    cardWrapper.innerHTML = _buildTransactionCard(t);
    
    container.insertBefore(cardWrapper, container.firstChild);
}

async function editTransaction(id) {
    try {
        showLoading('Carregando transa√ß√£o...');
        const r = await fetch('/gerenciamento-financeiro/api/transactions?page=1&per_page=1000');
        const d = await r.json();
        const t = d.transactions?.find(x => x.id === id);
        if (!t) {
            hideLoading();
            return;
        }
        
        // Esconder loading antes de mostrar modal de escolha
        hideLoading();
        
        const isInstallment = t.is_fixed || t.is_recurring;
        if (isInstallment) {
            const scope = await _chooseEditScope();
            if (!scope) return;
            currentEditScope = scope;
        } else {
            currentEditScope = 'single';
        }

        // Set editing mode FIRST
        currentEditingId = id;
        
        // Get modal elements
        const modalEl = document.getElementById('addTransactionModal');
        const title = document.getElementById('addTransactionTitle');
        const typeInput = document.getElementById('transactionType');
        const saveButton = document.getElementById('saveButton');
        
        // Configure modal for EDIT mode (not "Nova")
        typeInput.value = t.type;
        title.innerHTML = `<i class="bi bi-pencil me-2"></i>Editar ${t.type === 'income' ? 'Entrada' : 'Despesa'}`;
        
        if (t.type === 'income') {
            saveButton.className = 'btn btn-success';
        } else {
            saveButton.className = 'btn btn-danger';
        }
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Atualizar Transa√ß√£o';
        
        // Fill form fields
        _setupAmountMask();
        document.getElementById('description').value = t.description || '';
        document.getElementById('amount').value = (typeof t.amount === 'number') 
            ? t.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) 
            : String(t.amount || '');
        document.getElementById('transactionDate').value = t.transaction_date;
        const notesEl = document.getElementById('notes');
        if (notesEl) notesEl.value = t.notes || '';
        
        // Load categories and set current one
        await loadCategories(t.type);
        document.getElementById('category').value = t.category?.id || '';
        
        // Hide fixed duration section when editing
        const fixedSection = document.getElementById('fixedDurationSection');
        if (fixedSection) fixedSection.classList.add('d-none');
        
        // Hide loading and show modal
        hideLoading();
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        
    } catch (e) {
        console.error('Erro:', e);
        hideLoading();
    }
}

async function deleteTransaction(id) {
    const ok = await window._openConfirmModal({
        title: 'Excluir transa√ß√£o',
        body: 'Tem certeza que deseja excluir esta transa√ß√£o?',
        confirmText: 'Excluir',
        confirmClass: 'btn-danger'
    });
    if (!ok) return;
    try {
        showLoading('Excluindo...');
        const r = await fetch(`/gerenciamento-financeiro/api/transactions/${id}`, { method: 'DELETE' });
        hideLoading();
        if (r.ok) {
            showToast('Exclu√≠do!', 'success');
            const row = document.querySelector(`[data-transaction-id="${id}"]`);
            if (row) {
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
        }
    } catch (e) {
        console.error('Erro:', e);
        hideLoading();
    }
}

async function showMonthlyHistory() {
    const modal = new bootstrap.Modal(document.getElementById('monthlyHistoryModal'));
    modal.show();
    await loadMonthlyHistory();
}

async function loadMonthlyHistory() {
    const container = document.getElementById('historyContent');
    const filterMonth = document.getElementById('historyFilterMonth')?.value;
    const filterYear = document.getElementById('historyFilterYear')?.value;
    
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/transactions?page=1&per_page=1000');
        const data = await response.json();
        
        let transactions = data.transactions || [];
        
        // Filtrar por m√™s/ano se especificado
        if (filterMonth || filterYear) {
            transactions = transactions.filter(t => {
                const date = new Date(t.transaction_date);
                const matchMonth = !filterMonth || (date.getMonth() + 1) == filterMonth;
                const matchYear = !filterYear || date.getFullYear() == filterYear;
                return matchMonth && matchYear;
            });
        }
        
        if (!transactions.length) {
            container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">Nenhuma transa√ß√£o encontrada</p></div>';
            return;
        }
        
        // Agrupar por m√™s
        const grouped = {};
        transactions.forEach(t => {
            const date = new Date(t.transaction_date);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(t);
        });
        
        let html = '';
        Object.keys(grouped).sort().reverse().forEach(key => {
            const [year, month] = key.split('-');
            const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            const items = grouped[key];
            
            const totalIncome = items.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = items.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;
            
            html += `
                <div class="card mb-3" style="border-radius: 12px;">
                    <div class="card-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 12px 12px 0 0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-capitalize"><i class="bi bi-calendar-month me-2"></i>${monthName}</h6>
                            <span class="badge bg-light text-dark">${items.length} transa√ß√µes</span>
                        </div>
                        <div class="row mt-2 text-center">
                            <div class="col-4">
                                <small class="d-block opacity-75">Entradas</small>
                                <strong>+R$ ${_formatBRL(totalIncome)}</strong>
                            </div>
                            <div class="col-4">
                                <small class="d-block opacity-75">Sa√≠das</small>
                                <strong>-R$ ${_formatBRL(totalExpense)}</strong>
                            </div>
                            <div class="col-4">
                                <small class="d-block opacity-75">Saldo</small>
                                <strong class="${balance >= 0 ? 'text-success' : 'text-danger'}">R$ ${_formatBRL(Math.abs(balance))}</strong>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        ${items.map(t => {
                            const date = new Date(t.transaction_date);
                            const categoryIcon = t.category?.icon || (t.type === 'income' ? 'üíµ' : 'üí∏');
                            const amountColor = t.type === 'income' ? '#11998e' : '#ee0979';
                            const amountSign = t.type === 'income' ? '+' : '-';
                            return `
                                <div class="d-flex align-items-center justify-content-between p-2 border-bottom" style="cursor: pointer;" onclick="showTransactionDetails(${t.id})">
                                    <div class="d-flex align-items-center gap-2">
                                        <span style="font-size: 1.5rem;">${categoryIcon}</span>
                                        <div>
                                            <div class="fw-semibold">${t.description}</div>
                                            <small class="text-muted">${date.toLocaleDateString('pt-BR')}</small>
                                        </div>
                                    </div>
                                    <div class="fw-bold" style="color: ${amountColor};">${amountSign}R$ ${_formatBRL(t.amount)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar hist√≥rico</div>';
    }
}

async function closeMonthConfirm() {
    const ok = await window._openConfirmModal({
        title: 'Fechar m√™s',
        body: 'Deseja fechar o m√™s atual?\n\nIsso ir√°:\n- Finalizar o per√≠odo atual\n- Criar lan√ßamentos fixos no pr√≥ximo m√™s\n- Gerar relat√≥rio mensal',
        confirmText: 'Fechar m√™s',
        confirmClass: 'btn-warning',
    });
    if (!ok) return;
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/monthly-closure/close-month', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(`M√™s fechado! ${result.closure.fixed_expenses_copied} despesas fixas copiadas para o pr√≥ximo m√™s`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(result.error || 'Erro ao fechar m√™s', 'error');
        }
    } catch (error) {
        showToast('Erro ao fechar m√™s', 'error');
    }
}

// Abrir modal de gr√°ficos
async function showChartsModal() {
    const modal = new bootstrap.Modal(document.getElementById('chartsModal'));
    modal.show();
    await loadCharts();
}

// Carregar gr√°ficos
let categoryChartInstance = null;
let monthlyChartInstance = null;
let comparisonChartInstance = null;

async function loadCharts() {
    try {
        const response = await fetch('/gerenciamento-financeiro/api/transactions?page=1&per_page=1000');
        const data = await response.json();
        const transactions = data.transactions || [];
        
        // Destruir gr√°ficos existentes
        if (categoryChartInstance) categoryChartInstance.destroy();
        if (monthlyChartInstance) monthlyChartInstance.destroy();
        if (comparisonChartInstance) comparisonChartInstance.destroy();
        
        // 1. Gr√°fico de Pizza - Despesas por Categoria
        const expensesByCategory = {};
        transactions.filter(t => t.type === 'expense').forEach(t => {
            const catName = t.category?.name || 'Sem categoria';
            expensesByCategory[catName] = (expensesByCategory[catName] || 0) + t.amount;
        });
        
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            categoryChartInstance = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{
                        data: Object.values(expensesByCategory),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6',
                            '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#6366f1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = _formatBRL(context.parsed);
                                    return `${label}: R$ ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 2. Gr√°fico de Linha - Evolu√ß√£o Mensal
        const monthlyData = {};
        transactions.forEach(t => {
            const date = new Date(t.transaction_date);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!monthlyData[key]) {
                monthlyData[key] = { income: 0, expense: 0 };
            }
            if (t.type === 'income') {
                monthlyData[key].income += t.amount;
            } else {
                monthlyData[key].expense += t.amount;
            }
        });
        
        const sortedMonths = Object.keys(monthlyData).sort();
        const monthlyCtx = document.getElementById('monthlyChart');
        if (monthlyCtx) {
            monthlyChartInstance = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [
                        {
                            label: 'Entradas',
                            data: sortedMonths.map(m => monthlyData[m].income),
                            borderColor: '#11998e',
                            backgroundColor: 'rgba(17, 153, 142, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Despesas',
                            data: sortedMonths.map(m => monthlyData[m].expense),
                            borderColor: '#ee0979',
                            backgroundColor: 'rgba(238, 9, 121, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: R$ ${_formatBRL(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + _formatBRL(value)
                            }
                        }
                    }
                }
            });
        }
        
        // 3. Gr√°fico de Barras - Comparativo
        const comparisonCtx = document.getElementById('comparisonChart');
        if (comparisonCtx) {
            comparisonChartInstance = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [
                        {
                            label: 'Entradas',
                            data: sortedMonths.map(m => monthlyData[m].income),
                            backgroundColor: '#11998e'
                        },
                        {
                            label: 'Despesas',
                            data: sortedMonths.map(m => monthlyData[m].expense),
                            backgroundColor: '#ee0979'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: R$ ${_formatBRL(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + _formatBRL(value)
                            }
                        }
                    }
                }
            });
        }
        
    } catch (error) {
        console.error('Erro ao carregar gr√°ficos:', error);
        showToast('Erro ao carregar gr√°ficos', 'error');
    }
}

// Verificar virada de m√™s autom√°tica ao carregar p√°gina
document.addEventListener('DOMContentLoaded', async function() {
    // Verificar auto-close do m√™s
    try {
        const response = await fetch('/gerenciamento-financeiro/api/monthly-closure/check-auto-close', {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.auto_closed) {
                showToast(`Novo m√™s iniciado! ${result.fixed_expenses_copied} despesas fixas foram lan√ßadas automaticamente`, 'info');
            }
        }
    } catch (error) {
        console.log('Auto-close check failed:', error);
    }
    
    // Verificar convites pendentes
    checkPendingInvites();
});

// ============================================================================
// SISTEMA DE CONVITES
// ============================================================================

async function checkPendingInvites() {
    try {
        const response = await fetch('/gerenciamento-financeiro/api/invites/pending');
        if (response.ok) {
            const data = await response.json();
            if (data.count > 0) {
                document.getElementById('pendingInvitesAlert').style.display = 'block';
                document.getElementById('pendingInvitesText').textContent = 
                    data.count === 1 
                        ? `${data.invites[0].invited_by.split('@')[0]} quer compartilhar "${data.invites[0].workspace_name}" com voc√™.`
                        : `Voc√™ tem ${data.count} convites pendentes.`;
            }
        }
    } catch (error) {
        console.log('Erro ao verificar convites:', error);
    }
}

async function showShareModal() {
    const modal = new bootstrap.Modal(document.getElementById('shareWorkspaceModal'));
    modal.show();
    
    // Carregar workspaces do usu√°rio
    const select = document.getElementById('shareWorkspaceSelect');
    select.innerHTML = '<option value="">Carregando...</option>';
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/workspaces');
        const data = await response.json();
        
        let options = '<option value="">Selecione um workspace</option>';
        
        if (data.owned && data.owned.length > 0) {
            data.owned.forEach(ws => {
                options += `<option value="${ws.id}">${ws.name}</option>`;
            });
        }
        
        select.innerHTML = options;
        
        if (!data.owned || data.owned.length === 0) {
            select.innerHTML = '<option value="">Voc√™ n√£o possui workspaces</option>';
        }
    } catch (error) {
        select.innerHTML = '<option value="">Erro ao carregar</option>';
        console.error(error);
    }
}

async function sendInvite() {
    const workspaceId = document.getElementById('shareWorkspaceSelect').value;
    const email = document.getElementById('inviteEmail').value.trim();
    const role = document.getElementById('inviteRole').value;
    
    if (!workspaceId) {
        showToast('Selecione um workspace', 'warning');
        return;
    }
    
    if (!email) {
        showToast('Digite o email do usu√°rio', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/gerenciamento-financeiro/api/workspaces/${workspaceId}/invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, role })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(result.message, 'success');
            document.getElementById('inviteEmail').value = '';
            bootstrap.Modal.getInstance(document.getElementById('shareWorkspaceModal')).hide();
        } else {
            showToast(result.error || 'Erro ao enviar convite', 'error');
        }
    } catch (error) {
        showToast('Erro ao enviar convite', 'error');
        console.error(error);
    }
}

function showPendingInvitesModal() {
    const modal = new bootstrap.Modal(document.getElementById('pendingInvitesModal'));
    modal.show();
    loadPendingInvitesList();
}

async function loadPendingInvitesList() {
    const container = document.getElementById('pendingInvitesList');
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/invites/pending');
        const data = await response.json();
        
        if (!response.ok) {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        if (!data.invites || data.invites.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-envelope-open fs-1 text-muted d-block mb-2"></i>
                    <p class="text-muted">Nenhum convite pendente</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        data.invites.forEach(invite => {
            const roleLabel = invite.role === 'owner' ? 'Co-propriet√°rio' : 
                             invite.role === 'editor' ? 'Editor' : 'Visualizador';
            html += `
                <div class="card mb-3" style="border-left: 4px solid ${invite.workspace_color || '#3b82f6'};">
                    <div class="card-body">
                        <h6 class="card-title mb-1">
                            <i class="bi bi-folder-fill me-2" style="color: ${invite.workspace_color || '#3b82f6'}"></i>
                            ${invite.workspace_name}
                        </h6>
                        <p class="text-muted small mb-2">
                            <strong>${invite.invited_by.split('@')[0]}</strong> convidou voc√™ como <strong>${roleLabel}</strong>
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm flex-grow-1" onclick="acceptInvite(${invite.id})">
                                <i class="bi bi-check-lg me-1"></i>Aceitar
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="rejectInvite(${invite.id})">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar convites</div>';
        console.error(error);
    }
}

async function acceptInvite(inviteId) {
    try {
        const response = await fetch(`/gerenciamento-financeiro/api/invites/${inviteId}/accept`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(result.message, 'success');
            // Fechar modal e recarregar p√°gina para mostrar novo workspace
            bootstrap.Modal.getInstance(document.getElementById('pendingInvitesModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(result.error || 'Erro ao aceitar convite', 'error');
        }
    } catch (error) {
        showToast('Erro ao aceitar convite', 'error');
        console.error(error);
    }
}

async function rejectInvite(inviteId) {
    const ok = await window._openConfirmModal({
        title: 'Recusar convite',
        body: 'Tem certeza que deseja recusar este convite?'
        ,confirmText: 'Recusar'
        ,confirmClass: 'btn-danger'
    });
    if (!ok) return;
    
    try {
        const response = await fetch(`/gerenciamento-financeiro/api/invites/${inviteId}/reject`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Convite recusado', 'info');
            loadPendingInvitesList();
            checkPendingInvites();
        } else {
            showToast(result.error || 'Erro ao recusar convite', 'error');
        }
    } catch (error) {
        showToast('Erro ao recusar convite', 'error');
    }
}

// Fun√ß√µes stub para compatibilidade
function loadPendingInvites() { loadPendingInvitesList(); }
function loadShares() {}
function updateShareTypeOptions() {}
function executeShare() { sendInvite(); }
function acceptInviteAndClose() {}
function createOwnWorkspaceAndClose() {}
function checkFirstAccess() {}
</script>
{% endblock %}
