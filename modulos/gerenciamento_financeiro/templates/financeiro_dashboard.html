{% extends 'finance_base.html' %}

{% block title %}Dashboard Financeiro ¬∑ NEXUSRDR{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Header Dashboard -->
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4">
            <div class="flex-grow-1">
                <h1 class="h3 h2-md mb-1">Dashboard Financeiro</h1>
                <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                    <span class="badge rounded-pill" style="font-size: 0.75rem; padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #3b82f6, #1e40af);">
                        <i class="bi bi-folder-fill me-1"></i>
                        <span id="currentWorkspaceName">{{ active_workspace.name if active_workspace else 'Meu Workspace' }}</span>
                        <span id="workspaceNotificationBadge" class="badge bg-danger rounded-pill ms-2" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; display: none;">
                            <i class="bi bi-envelope-exclamation-fill"></i>
                        </span>
                    </span>
                    <!-- Seletor de Per√≠odo Moderno -->
                    <div class="period-selector-wrapper">
                        <button type="button" class="period-selector-btn" id="periodSelectorBtn">
                            <i class="bi bi-calendar3"></i>
                            <span id="periodSelectorText">Janeiro 2025</span>
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <div class="period-selector-dropdown" id="periodSelectorDropdown" style="display: none;">
                            <div class="period-selector-header">
                                <button type="button" class="period-nav-btn" onclick="changePeriodYear(-1)">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <span class="period-year" id="periodYearDisplay">2025</span>
                                <button type="button" class="period-nav-btn" onclick="changePeriodYear(1)">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                            <div class="period-months-grid" id="periodMonthsGrid"></div>
                            <div class="period-selector-footer">
                                <button type="button" class="period-current-btn" onclick="selectCurrentMonth()">
                                    <i class="bi bi-calendar-check"></i> M√™s Atual
                                </button>
                            </div>
                        </div>
                    </div>

<div class="modal fade" id="editScopeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar parcelas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Deseja editar somente esta parcela ou todas as parcelas?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-outline-primary" id="editScopeSingleBtn">S√≥ esta parcela</button>
                <button type="button" class="btn btn-primary" id="editScopeSeriesBtn">Todas as parcelas</button>
            </div>
        </div>
    </div>
</div>
                </div>
            </div>

            <div class="d-flex flex-column align-items-stretch align-items-md-end gap-2 mt-3 mt-md-0">
                <div class="d-none d-md-flex flex-wrap justify-content-start justify-content-md-end gap-2">
                <button class="btn btn-success" onclick="showAddTransaction('income')">
                    <i class="bi bi-plus-circle me-1"></i> Nova Entrada
                </button>
                <button class="btn btn-danger" onclick="showAddTransaction('expense')">
                    <i class="bi bi-dash-circle me-1"></i> Nova Despesa
                </button>
                <button class="btn btn-warning" onclick="showMonthlyHistory()">
                    <i class="bi bi-calendar-check me-1"></i> Hist√≥rico
                </button>
                <button class="btn btn-primary" id="chartsBtn" onclick="showChartsModal()">
                    <i class="bi bi-bar-chart-line me-1"></i> Gr√°ficos
                </button>
                <button class="btn btn-dark" onclick="showAiRecommendationsModal()">
                    <i class="bi bi-stars me-1"></i> Recomenda√ß√£o de IA
                </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aiRecommendationsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Recomenda√ß√£o de IA</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="aiRecommendationPreset" class="form-label">Tipo de recomenda√ß√£o</label>
                        <select id="aiRecommendationPreset" class="form-select">
                            <option value="general" selected>Recomenda√ß√£o geral (autom√°tica)</option>
                            <option value="vacation">Planejar f√©rias</option>
                            <option value="debt">Quitar d√≠vidas / organizar parcelas</option>
                            <option value="cut_expenses">Cortar gastos</option>
                            <option value="increase_income">Aumentar renda</option>
                            <option value="emergency_fund">Montar reserva de emerg√™ncia</option>
                        </select>
                        <div class="form-text">A IA usa automaticamente os dados do seu workspace (per√≠odo selecionado) + o tipo escolhido.</div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-12 col-md-6">
                            <label for="aiRecommendationPeriod" class="form-label">Per√≠odo</label>
                            <select id="aiRecommendationPeriod" class="form-select">
                                <option value="30" selected>√öltimos 30 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                                <option value="365">√öltimos 12 meses</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="aiRecommendationFocus" class="form-label">Foco (do sistema)</label>
                            <select id="aiRecommendationFocus" class="form-select">
                                <option value="overall" selected>Vis√£o geral</option>
                                <option value="category">Categoria espec√≠fica</option>
                            </select>
                        </div>
                        <div class="col-12" id="aiRecommendationCategoryWrap" style="display:none;">
                            <label for="aiRecommendationCategory" class="form-label">Categoria</label>
                            <select id="aiRecommendationCategory" class="form-select">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>

                    <div id="aiRecommendationError" class="alert alert-warning" style="display:none;"></div>

                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div>
                            <span id="aiRecommendationCached" class="badge bg-secondary" style="display:none;">cache</span>
                        </div>
                        <button id="aiRecommendationBtn" type="button" class="btn btn-primary" onclick="requestAiRecommendations()">
                            <span id="aiRecommendationSpinner" class="spinner-border spinner-border-sm me-2" role="status" style="display:none;"></span>
                            Gerar recomenda√ß√£o
                        </button>
                    </div>

                    <pre id="aiRecommendationOutput" class="p-3" style="background: #0b1220; color: #e5e7eb; border-radius: 12px; white-space: pre-wrap; word-break: break-word; min-height: 180px;"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerta de Convites Pendentes REMOVIDO - ser√° mostrado na aba Compartilhado -->


    <!-- Cards de Status -->
    <div class="col-12">
        <div class="row g-3 g-md-4 mb-4">
            <!-- Saldo Total -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card value-card h-100">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-1 opacity-75" style="font-size: 0.85rem;">Saldo Atual</h6>
                                <h3 class="card-title mb-1" style="font-size: 1.5rem;">R$ {{ "{:,.2f}".format(balance or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <small class="opacity-75" style="font-size: 0.75rem;">
                                    <i class="bi bi-arrow-up me-1"></i>
                                    Atualizado agora
                                </small>
                            </div>
                            <div class="opacity-50 d-none d-sm-block">
                                <i class="bi bi-wallet2" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Entradas do M√™s -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card income-card h-100" style="animation: slideInUp 0.5s ease-out 0.1s both;">
                    <div class="card-body text-white p-3 p-md-4">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="flex-grow-1" style="position: relative; z-index: 2;">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; backdrop-filter: blur(10px);">
                                        <i class="bi bi-arrow-up-circle" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-0 opacity-90 fw-semibold" style="font-size: 0.8rem; letter-spacing: 0.5px; text-transform: uppercase;">Entradas</h6>
                                </div>
                                <h3 id="totalIncome" class="card-title mb-2 fw-bold" style="font-size: 1.75rem; line-height: 1.2;">+R$ {{ "{:,.2f}".format(monthly_income or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge" style="background: rgba(255, 255, 255, 0.25); font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                        <i class="bi bi-graph-up-arrow me-1"></i>{{ income_count }} transa√ß√µes
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gastos do M√™s -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card expense-card h-100" style="animation: slideInUp 0.5s ease-out 0.2s both;">
                    <div class="card-body text-white p-3 p-md-4">
                        <div class="d-flex align-items-start justify-content-between">
                            <div class="flex-grow-1" style="position: relative; z-index: 2;">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <div class="d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; backdrop-filter: blur(10px);">
                                        <i class="bi bi-arrow-down-circle" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h6 class="card-subtitle mb-0 opacity-90 fw-semibold" style="font-size: 0.8rem; letter-spacing: 0.5px; text-transform: uppercase;">Despesas</h6>
                                </div>
                                <h3 id="totalExpense" class="card-title mb-2 fw-bold" style="font-size: 1.75rem; line-height: 1.2;">-R$ {{ "{:,.2f}".format(monthly_expense or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge" style="background: rgba(255, 255, 255, 0.25); font-size: 0.7rem; padding: 0.35rem 0.65rem; border-radius: 6px;">
                                        <i class="bi bi-graph-down-arrow me-1"></i>{{ expense_count }} transa√ß√µes
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Taxa de Economia -->
            <div class="col-12 col-md-6 col-xl-3">
                <div class="card h-100 border-info border-2">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="card-subtitle mb-1 text-info" style="font-size: 0.85rem;">Taxa de Economia</h6>
                                <h4 class="card-title mb-1 text-info" style="font-size: 1.35rem;">{{ "{:.1f}".format(savings_rate or 0) }}%</h4>
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    R$ {{ "{:,.2f}".format(savings or 0).replace(",", "X").replace(".", ",").replace("X", ".") }} economizado
                                </small>
                            </div>
                            <div class="text-info opacity-25">
                                <i class="bi bi-piggy-bank" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transa√ß√µes Recentes -->
    <div class="col-12">
        <div class="card" style="border: none; background: transparent; box-shadow: none;">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center" style="background: transparent; border: none; padding: 0 0 1rem 0;">
                <div class="mb-2 mb-md-0">
                    <h4 class="mb-1 fw-bold" style="font-size: 1.5rem;">
                        <i class="bi bi-clock-history me-2" style="color: #3b82f6;"></i>Transa√ß√µes
                    </h4>
                </div>
            </div>
            
            <!-- Abas modernas: Entradas e Sa√≠das -->
            <div class="d-flex align-items-center gap-2 mb-3" style="border-bottom: 2px solid var(--border-color); padding-bottom: 0;">
                <button class="btn px-4 py-2 fw-semibold transactions-tab active" 
                        id="tabEntradas" 
                        onclick="filterTransactionsByType('income')"
                        style="border: none; border-bottom: 3px solid #10b981; border-radius: 0; background: transparent; color: #10b981; margin-bottom: -2px;">
                    <i class="bi bi-arrow-up-circle me-1"></i>Entradas
                </button>
                <button class="btn px-4 py-2 fw-semibold transactions-tab" 
                        id="tabSaidas" 
                        onclick="filterTransactionsByType('expense')"
                        style="border: none; border-bottom: 3px solid transparent; border-radius: 0; background: transparent; color: var(--text-secondary); margin-bottom: -2px;">
                    <i class="bi bi-arrow-down-circle me-1"></i>Sa√≠das
                </button>
                <div class="ms-auto">
                    <span id="transactionsCount" class="badge bg-primary rounded-pill" style="font-size: 0.75rem;">{{ (recent_transactions|length) }} este m√™s</span>
                </div>
            </div>
            
            <div class="card-body p-3">
                
                {% if recent_transactions %}
                    <div id="recentTransactionsTbody" class="transactions-list">
                        {% for t in recent_transactions %}
                        <div data-transaction-id="{{ t.id }}" 
                             data-type="{{ t.type }}"
                             class="transaction-item {% if t.type == 'income' %}item-income{% else %}item-expense{% endif %}" 
                             onclick="showTransactionDetails({{ t.id }})">
                            
                            <div class="item-left">
                                <div class="item-icon {% if t.type == 'income' %}icon-green{% else %}icon-red{% endif %}">
                                    {% if t.subcategory and t.subcategory.icon %}
                                        {{ t.subcategory.icon }}
                                    {% elif t.category and t.category.icon %}
                                        {{ t.category.icon }}
                                    {% else %}
                                        {% if t.type == 'income' %}üí∞{% else %}üí∏{% endif %}
                                    {% endif %}
                                </div>
                                
                                <div class="item-details">
                                    <div class="item-name">{{ t.description }}</div>
                                    <div class="item-info">
                                        <span class="info-date">{{ t.transaction_date.strftime('%d/%m/%Y') }}</span>
                                        {% if t.category %}
                                            <span class="info-sep">‚Ä¢</span>
                                            <span class="info-cat">{{ t.category.name }}</span>
                                        {% endif %}
                                        {% if t.subcategory %}
                                            <span class="info-sep">‚Ä¢</span>
                                            <span class="info-subcat">{{ t.subcategory.name }}</span>
                                        {% endif %}
                                        {% if t.notes %}
                                            <span class="info-sep">‚Ä¢</span>
                                            <span class="info-note">{{ t.notes }}</span>
                                        {% endif %}
                                    </div>
                                    {% if t.is_fixed or t.is_recurring %}
                                    <div class="item-tags">
                                        {% if t.is_fixed %}
                                            <span class="tag tag-fixed">üìå Fixo</span>
                                        {% endif %}
                                        {% if t.is_recurring %}
                                            <span class="tag tag-recurring">üîÑ Recorrente</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="item-right">
                                <div class="item-value {% if t.type == 'income' %}value-green{% else %}value-red{% endif %}">
                                    {{ '+' if t.type == 'income' else '-' }}R$ {{ "{:,.2f}".format(t.amount).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                </div>
                                <div class="item-actions">
                                    <button class="btn-action" onclick="editTransaction({{ t.id }}); event.stopPropagation();" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn-action btn-delete" onclick="deleteTransaction({{ t.id }}); event.stopPropagation();" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="card" style="border-radius: 16px; border: 2px dashed var(--border-color);">
                        <div class="card-body text-center py-5">
                            <div class="mb-3" style="font-size: 4rem; opacity: 0.3;">
                                <i class="bi bi-inbox"></i>
                            </div>
                            <h5 class="mb-2">Nenhuma transa√ß√£o registrada</h5>
                            <p class="text-muted mb-4">Comece adicionando sua primeira transa√ß√£o e acompanhe suas finan√ßas</p>
                            <button class="btn btn-primary" onclick="showAddTransaction('income')" style="border-radius: 10px; padding: 0.6rem 1.5rem;">
                                <i class="bi bi-plus-circle me-2"></i>Primeira Transa√ß√£o
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Mobile -->
<div class="d-none" style="border-color: var(--border-color) !important; padding: 12px; z-index: 1000;">
    <div class="d-flex gap-2">
        <button class="btn btn-success flex-grow-1" onclick="showAddTransaction('income')">
            <i class="bi bi-plus-circle me-1"></i>Entrada
        </button>
        <button class="btn btn-danger flex-grow-1" onclick="showAddTransaction('expense')">
            <i class="bi bi-dash-circle me-1"></i>Despesa
        </button>
        <div class="position-relative">
            <button class="btn btn-secondary" id="mobileMenuBtn" onclick="toggleMobileMenu()">
                <i class="bi bi-list me-1"></i>Menu
            </button>
            <div class="mobile-menu-dropdown" id="mobileMenuDropdown" style="display: none;">
                <button class="mobile-menu-item" onclick="showMonthlyHistory(); closeMobileMenu();">
                    <i class="bi bi-calendar-check me-2"></i>Hist√≥rico
                </button>
                <button class="mobile-menu-item" onclick="showChartsModal(); closeMobileMenu();">
                    <i class="bi bi-bar-chart-line me-2"></i>Gr√°ficos
                </button>
                <button class="mobile-menu-item" onclick="showAiRecommendationsModal(); closeMobileMenu();">
                    <i class="bi bi-stars me-2"></i>IA
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Transa√ß√£o -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTransactionTitle">Nova Transa√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addTransactionForm">
                <div class="modal-body">
                    <input type="hidden" id="transactionType">
                    
                    <div class="mb-3">
                        <label for="category" class="form-label">Categoria *</label>
                        <div class="input-group">
                            <select class="form-select" id="category" required>
                                <option value="">Selecione uma categoria</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="openCategoriesManager({ typeElId: 'transactionType', selectElId: 'category' });">
                                <i class="bi bi-plus"></i>
                                Nova categoria
                            </button>
                        </div>
                    </div>

                    <div class="mb-3" id="subcategoryField" style="display: none;">
                        <label for="subcategory" class="form-label">Subcategoria</label>
                        <div class="input-group">
                            <select class="form-select" id="subcategory">
                                <option value="">Selecione uma subcategoria</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="openSubcategoriesManager({ categorySelectId: 'category', subcategorySelectId: 'subcategory' });">
                                <i class="bi bi-plus"></i>
                                Nova subcategoria
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="descriptionField" style="display: none;">
                        <label for="description" class="form-label">Nome da Despesa *</label>
                        <input type="text" class="form-control" id="description" placeholder="Ex: Almo√ßo, Gasolina, Conta de √°gua...">
                    </div>

                    <div class="mb-3" id="notesField">
                        <label for="notes" class="form-label">Observa√ß√£o</label>
                        <input type="text" class="form-control" id="notes" placeholder="Ex: Sal√°rio do Jo√£o, gasto da Maria... (opcional)">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Valor (R$) *</label>
                                <input type="text" class="form-control" id="amount" inputmode="decimal" required placeholder="0,00" autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="transactionDate" class="form-label" id="dateLabel">Data *</label>
                                <div id="transactionDateContainer">
                                    <input type="date" class="form-control" id="transactionDate" required>
                                </div>
                                <div id="incomeDayContainer" style="display: none;">
                                    <input type="number" class="form-control" id="incomeDay" min="1" max="31" placeholder="Ex: 5" required>
                                    <small class="text-muted d-block mt-1">Informe apenas o dia do m√™s. A data completa ser√° gerada automaticamente.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isFixed" onchange="toggleFixedOptions()">
                        <label class="form-check-label" for="isFixed">
                            <strong>Marcar como fixo/recorrente</strong>
                        </label>
                    </div>
                    
                    <div class="mb-3" id="fixedOptionsContainer" style="display: none;">
                        <label class="form-label">Tipo de despesa fixa:</label>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="fixedType" id="fixedWithoutInstallments" value="without" checked onchange="toggleInstallmentsField()">
                                <label class="form-check-label" for="fixedWithoutInstallments">
                                    <strong>Fixo sem parcelas</strong>
                                    <small class="d-block text-muted">Ex: √Ågua, Luz, Internet (valor fixo todo m√™s)</small>
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="fixedType" id="fixedWithInstallments" value="with" onchange="toggleInstallmentsField()">
                                <label class="form-check-label" for="fixedWithInstallments">
                                    <strong>Fixo com parcelas</strong>
                                    <small class="d-block text-muted">Ex: Compra parcelada, financiamento</small>
                                </label>
                            </div>
                        </div>
                        
                        <div id="installmentsFieldContainer" style="display: none;">
                            <label class="form-label">Quantas parcelas? *</label>
                            <div class="d-flex gap-2 align-items-center flex-wrap">
                                <div class="input-group" style="width: 180px;">
                                    <button class="btn btn-outline-secondary" type="button" onclick="stepFixedMonths(-1)">-</button>
                                    <input type="number" class="form-control text-center" id="fixedMonths" min="1" max="120" value="12">
                                    <button class="btn btn-outline-secondary" type="button" onclick="stepFixedMonths(1)">+</button>
                                </div>

                                <div class="d-flex gap-1 flex-wrap">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="setFixedMonths(6)">6</button>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="setFixedMonths(12)">12</button>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="setFixedMonths(24)">24</button>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="setFixedMonths(36)">36</button>
                                </div>
                            </div>

                            <small class="text-muted d-block mt-2">Ser√° criada uma parcela para cada m√™s.</small>
                            
                            <!-- Preview de Parcelas -->
                            <div id="installmentsPreview" class="mt-3 p-3 rounded" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.05)); border: 1px solid rgba(59, 130, 246, 0.2); display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong class="text-primary"><i class="bi bi-eye me-1"></i>Preview das Parcelas</strong>
                                    <span class="badge bg-primary" id="previewTotalBadge">Total: R$ 0,00</span>
                                </div>
                                <div id="previewInstallmentsList" style="max-height: 150px; overflow-y: auto; font-size: 0.85rem;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveButton">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        Salvar Transa√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Hist√≥rico Mensal -->
<div class="modal fade" id="monthlyHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-check me-2"></i>Hist√≥rico de Transa√ß√µes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="historyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions-pane" type="button" role="tab">
                            <i class="bi bi-list-ul me-1"></i>Transa√ß√µes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts-pane" type="button" role="tab" onclick="loadCharts()">
                            <i class="bi bi-bar-chart-line me-1"></i>Gr√°ficos
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="historyTabContent">
                    <!-- Aba Transa√ß√µes -->
                    <div class="tab-pane fade show active" id="transactions-pane" role="tabpanel">
                        <!-- Filtros -->
                        <div class="card mb-3" style="border-radius: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(99, 102, 241, 0.03));">
                            <div class="card-body p-3">
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label small mb-1">M√™s</label>
                                        <select class="form-select" id="historyFilterMonth" onchange="loadMonthlyHistory()">
                                            <option value="">Todos os meses</option>
                                            <option value="1">Janeiro</option>
                                            <option value="2">Fevereiro</option>
                                            <option value="3">Mar√ßo</option>
                                            <option value="4">Abril</option>
                                            <option value="5">Maio</option>
                                            <option value="6">Junho</option>
                                            <option value="7">Julho</option>
                                            <option value="8">Agosto</option>
                                            <option value="9">Setembro</option>
                                            <option value="10">Outubro</option>
                                            <option value="11">Novembro</option>
                                            <option value="12">Dezembro</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small mb-1">Ano</label>
                                        <select class="form-select" id="historyFilterYear" onchange="loadMonthlyHistory()">
                                            <option value="">Todos os anos</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-outline-primary w-100" onclick="document.getElementById('historyFilterMonth').value=''; document.getElementById('historyFilterYear').value=''; loadMonthlyHistory();">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Limpar Filtros
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sub-abas: Entradas e Sa√≠das -->
                        <ul class="nav nav-pills mb-3" id="transactionTypeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="income-transactions-tab" data-bs-toggle="pill" data-bs-target="#income-transactions-pane" type="button" role="tab" onclick="filterHistoryByType('income')" style="color: #10b981;">
                                    <i class="bi bi-arrow-up-circle me-1"></i>Entradas
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="expense-transactions-tab" data-bs-toggle="pill" data-bs-target="#expense-transactions-pane" type="button" role="tab" onclick="filterHistoryByType('expense')" style="color: #ef4444;">
                                    <i class="bi bi-arrow-down-circle me-1"></i>Sa√≠das
                                </button>
                            </li>
                        </ul>

                        <!-- Conte√∫do das sub-abas -->
                        <div class="tab-content" id="transactionTypeTabContent">
                            <!-- Entradas -->
                            <div class="tab-pane fade show active" id="income-transactions-pane" role="tabpanel">
                                <div id="historyContentIncome" style="max-height: 500px; overflow-y: auto;">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Sa√≠das -->
                            <div class="tab-pane fade" id="expense-transactions-pane" role="tabpanel">
                                <div id="historyContentExpense" style="max-height: 500px; overflow-y: auto;">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Gr√°ficos -->
                    <div class="tab-pane fade" id="charts-pane" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Despesas por Categoria</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="categoryChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Evolu√ß√£o Mensal</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="monthlyChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card" style="border-radius: 12px;">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Comparativo Entradas vs Despesas</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="comparisonChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gr√°ficos -->
<div class="modal fade" id="chartsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-bar-chart-line me-2"></i>Gr√°ficos Financeiros
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Despesas por Categoria</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="categoryChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Evolu√ß√£o Mensal</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="monthlyChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card" style="border-radius: 12px;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Comparativo Entradas vs Despesas</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="comparisonChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal Boas-vindas (Primeiro Acesso) -->
<div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-hand-wave me-2"></i>Bem-vindo ao Sistema Financeiro!
                </h5>
            </div>
            <div class="modal-body">
                <div id="welcomeContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Workspaces -->
<div class="modal fade" id="workspacesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-folder me-2"></i>Workspaces</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="workspaceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="workspaces-tab" data-bs-toggle="tab" data-bs-target="#workspaces-pane" type="button" role="tab">
                            <i class="bi bi-folder me-1"></i>Meus Workspaces
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="new-workspace-tab" data-bs-toggle="tab" data-bs-target="#new-workspace-pane" type="button" role="tab">
                            <i class="bi bi-plus-circle me-1"></i>Novo Workspace
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="shared-tab" data-bs-toggle="tab" data-bs-target="#shared-pane" type="button" role="tab">
                            <i class="bi bi-share me-1"></i>Compartilhado
                            <span id="sharedTabBadge" class="badge bg-danger rounded-pill ms-2" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; display: none;"></span>
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="workspaceTabContent">
                    <!-- Aba Meus Workspaces -->
                    <div class="tab-pane fade show active" id="workspaces-pane" role="tabpanel">
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-primary btn-sm" onclick="showCreateWorkspaceModal()">
                                <i class="bi bi-plus me-1"></i>Novo Workspace
                            </button>
                        </div>
                        <div id="workspacesListContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aba Novo Workspace -->
                    <div class="tab-pane fade" id="new-workspace-pane" role="tabpanel">
                        <div class="mb-3">
                            <label for="newWsName" class="form-label">Nome do Workspace *</label>
                            <input type="text" class="form-control" id="newWsName" placeholder="Ex: Fam√≠lia, Neg√≥cio...">
                        </div>
                        <div class="mb-3">
                            <label for="newWsDesc" class="form-label">Descri√ß√£o (opcional)</label>
                            <input type="text" class="form-control" id="newWsDesc" placeholder="Descri√ß√£o do workspace">
                        </div>
                        <div class="mb-3">
                            <label for="newWsColor" class="form-label">Cor</label>
                            <div class="d-flex gap-2">
                                <input type="color" class="form-control" id="newWsColor" value="#3b82f6" style="width: 60px;">
                                <input type="text" class="form-control" id="newWsColorText" value="#3b82f6" readonly>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="createWorkspaceFromModal()">
                            <i class="bi bi-check me-1"></i>Criar Workspace
                        </button>
                    </div>

                    <!-- Aba Compartilhado -->
                    <div class="tab-pane fade" id="shared-pane" role="tabpanel">
                        <div id="sharedContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando convites...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Compartilhar Workspace -->
<div class="modal fade" id="shareWorkspaceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-share me-2"></i>Compartilhar Workspace
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareWorkspaceSelect" class="form-label">Workspace a compartilhar *</label>
                    <select class="form-select" id="shareWorkspaceSelect">
                        <option value="">Carregando workspaces...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="inviteEmail" class="form-label">Email do usu√°rio *</label>
                    <input type="email" class="form-control" id="inviteEmail" placeholder="usuario@exemplo.com">
                </div>
                
                <div class="mb-3">
                    <label for="inviteRole" class="form-label">Fun√ß√£o no Workspace *</label>
                    <select class="form-select" id="inviteRole">
                        <option value="viewer">üëÅÔ∏è Visualizador - Apenas visualiza transa√ß√µes</option>
                        <option value="editor" selected>‚úèÔ∏è Editor - Pode criar e editar transa√ß√µes</option>
                        <option value="owner">üëë Co-propriet√°rio - Controle total</option>
                    </select>
                    <div class="form-text">
                        A pessoa receber√° um email com o convite e poder√° aceitar ou recusar.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="sendInvite()">
                    <i class="bi bi-send me-1"></i>Enviar Convite
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Convites Pendentes -->
<div class="modal fade" id="pendingInvitesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-envelope-open me-2"></i>Convites Pendentes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pendingInvitesList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_styles %}
<style>
    /* Hover effect para cards de workspace */
    .hover-card {
        transition: all 0.3s ease !important;
    }
    
    .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* ========== LISTA LIMPA DE TRANSA√á√ïES ========== */
    .transactions-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        border-left: 4px solid;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .item-income {
        border-left-color: #10b981;
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, var(--bg-secondary) 20%);
    }
    
    .item-expense {
        border-left-color: #ef4444;
        background: linear-gradient(90deg, rgba(239, 68, 68, 0.05) 0%, var(--bg-secondary) 20%);
    }
    
    .transaction-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .item-income:hover {
        border-left-color: #059669;
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.08) 0%, var(--bg-secondary) 20%);
    }
    
    .item-expense:hover {
        border-left-color: #dc2626;
        background: linear-gradient(90deg, rgba(239, 68, 68, 0.08) 0%, var(--bg-secondary) 20%);
    }
    
    /* Lado esquerdo */
    .item-left {
        display: flex;
        align-items: center;
        gap: 14px;
        flex: 1;
        min-width: 0;
    }
    
    .item-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .icon-green {
        background: rgba(16, 185, 129, 0.15);
        border: 2px solid rgba(16, 185, 129, 0.3);
    }
    
    .icon-red {
        background: rgba(239, 68, 68, 0.15);
        border: 2px solid rgba(239, 68, 68, 0.3);
    }
    
    .item-details {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
        flex: 1;
    }
    
    .item-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.3;
    }
    
    .item-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .info-date {
        font-weight: 500;
    }
    
    .info-sep {
        opacity: 0.5;
    }
    
    .info-cat, .info-subcat {
        opacity: 0.85;
    }
    
    .info-note {
        opacity: 0.7;
        font-style: italic;
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .item-tags {
        display: flex;
        gap: 6px;
        margin-top: 4px;
    }
    
    .tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    .tag-fixed {
        background: rgba(245, 158, 11, 0.15);
        color: #d97706;
    }
    
    .tag-recurring {
        background: rgba(59, 130, 246, 0.15);
        color: #2563eb;
    }
    
    /* Lado direito */
    .item-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
    }
    
    .item-value {
        font-size: 1.25rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .value-green {
        color: #10b981;
    }
    
    .value-red {
        color: #ef4444;
    }
    
    .item-actions {
        display: flex;
        gap: 6px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .transaction-item:hover .item-actions {
        opacity: 1;
    }
    
    .btn-action {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-secondary);
    }
    
    .btn-action:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
        transform: scale(1.05);
    }
    
    .btn-delete:hover {
        background: #ef4444;
        border-color: #ef4444;
    }
    
    /* Responsividade mobile */
    @media (max-width: 768px) {
        .hover-card .btn-group {
            flex-direction: column;
        }
        
        .hover-card .btn-group .btn {
            margin-bottom: 0.25rem;
        }
        
        .transaction-item {
            flex-direction: column;
            align-items: stretch;
            padding: 12px;
        }
        
        .item-left {
            gap: 12px;
        }
        
        .item-icon {
            width: 42px;
            height: 42px;
            font-size: 1.3rem;
        }
        
        .item-name {
            font-size: 0.95rem;
        }
        
        .item-info {
            font-size: 0.75rem;
        }
        
        .info-note {
            max-width: 120px;
        }
        
        .item-right {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .item-value {
            font-size: 1.15rem;
        }
        
        .item-actions {
            opacity: 1;
        }
    }
    
    /* Anima√ß√£o de entrada */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Period Selector Styles */
    .period-selector-wrapper {
        position: relative;
        display: inline-block;
    }

    .period-selector-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.08));
        border: 1px solid rgba(59, 130, 246, 0.25);
        border-radius: 10px;
        color: #3b82f6;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.25s ease;
        white-space: nowrap;
    }

    .period-selector-btn:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.18), rgba(99, 102, 241, 0.12));
        border-color: rgba(59, 130, 246, 0.4);
        transform: translateY(-1px);
    }

    .period-selector-btn i:last-child {
        font-size: 0.8rem;
        transition: transform 0.25s ease;
    }

    .period-selector-btn.active i:last-child {
        transform: rotate(180deg);
    }

    .period-selector-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 14px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
        padding: 16px;
        min-width: 320px;
        z-index: 1050;
        animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .period-selector-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
    }

    .period-nav-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .period-nav-btn:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.3);
        color: #3b82f6;
    }

    .period-year {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .period-months-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 12px;
    }

    .period-month-btn {
        padding: 10px 8px;
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .period-month-btn:hover {
        background: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.3);
        color: #3b82f6;
    }

    .period-month-btn.active {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        border-color: #3b82f6;
        color: white;
    }

    .period-selector-footer {
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
    }

    .period-current-btn {
        width: 100%;
        padding: 10px 12px;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.08));
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 10px;
        color: #10b981;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .period-current-btn:hover {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(5, 150, 105, 0.15));
        border-color: rgba(16, 185, 129, 0.5);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }

    /* Mobile Menu Styles */
    .mobile-menu-dropdown {
        position: absolute;
        top: auto;
        bottom: calc(100% + 8px);
        right: 0;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        min-width: 180px;
        z-index: 1050;
        overflow: hidden;
        animation: slideDown 0.2s ease;
    }

    .mobile-menu-item {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 12px 16px;
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-weight: 500;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
    }

    .mobile-menu-item:hover {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .mobile-menu-item:not(:last-child) {
        border-bottom: 1px solid var(--border-color);
    }
</style>
{% endblock %}

{% block scripts %}
<script defer>
let __editScopeResolve = null;
let currentEditScope = 'single';

document.addEventListener('DOMContentLoaded', () => {
    const scopeEl = document.getElementById('editScopeModal');
    const singleBtn = document.getElementById('editScopeSingleBtn');
    const seriesBtn = document.getElementById('editScopeSeriesBtn');
    if (scopeEl && singleBtn && seriesBtn) {
        singleBtn.addEventListener('click', () => {
            if (__editScopeResolve) __editScopeResolve('single');
            __editScopeResolve = null;
            try { bootstrap.Modal.getInstance(scopeEl)?.hide(); } catch (e) {}
        });
        seriesBtn.addEventListener('click', () => {
            if (__editScopeResolve) __editScopeResolve('series');
            __editScopeResolve = null;
            try { bootstrap.Modal.getInstance(scopeEl)?.hide(); } catch (e) {}
        });
        scopeEl.addEventListener('hidden.bs.modal', () => {
            if (__editScopeResolve) {
                __editScopeResolve(null);
                __editScopeResolve = null;
            }
        });
    }
});

function _chooseEditScope() {
    const scopeEl = document.getElementById('editScopeModal');
    if (!scopeEl) return Promise.resolve('single');
    const modal = bootstrap.Modal.getOrCreateInstance(scopeEl);
    return new Promise((resolve) => {
        __editScopeResolve = resolve;
        modal.show();
    });
}

function _parseBRL(value) {
    const s = String(value ?? '').trim();
    if (!s) return 0;
    const cleaned = s.replace(/[^0-9,.-]/g, '');
    if (!cleaned) return 0;
    if (cleaned.includes(',')) {
        const parts = cleaned.split(',');
        const dec = (parts.pop() || '').replace(/\./g, '').replace(/[^0-9]/g, '');
        const intPart = parts.join('').replace(/\./g, '').replace(/[^0-9-]/g, '');
        const numStr = `${intPart || '0'}.${dec}`;
        const n = parseFloat(numStr);
        return Number.isFinite(n) ? n : 0;
    }
    const numStr = cleaned.replace(/\./g, '');
    const n = parseFloat(numStr);
    return Number.isFinite(n) ? n : 0;
}

function _formatBRLInputFromDigits(digits) {
    const d = String(digits || '').replace(/\D/g, '');
    if (!d) return '';
    const n = Number(d) / 100;
    if (!Number.isFinite(n)) return '';
    return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function _setupAmountMask() {
    const el = document.getElementById('amount');
    if (!el) return;
    if (el.dataset.masked === '1') return;
    el.dataset.masked = '1';

    const handler = () => {
        const digits = el.value.replace(/\D/g, '');
        const formatted = _formatBRLInputFromDigits(digits);
        el.value = formatted;
        try { el.setSelectionRange(el.value.length, el.value.length); } catch (e) {}
    };

    el.addEventListener('input', handler);
    el.addEventListener('blur', handler);
}

window.showAiRecommendationsModal = function() {
    const modalEl = document.getElementById('aiRecommendationsModal');
    if (!modalEl) return;
    const output = document.getElementById('aiRecommendationOutput');
    if (output) output.textContent = '';
    const cached = document.getElementById('aiRecommendationCached');
    if (cached) cached.style.display = 'none';
    const err = document.getElementById('aiRecommendationError');
    if (err) {
        err.style.display = 'none';
        err.textContent = '';
    }
    const preset = document.getElementById('aiRecommendationPreset');
    if (preset) preset.value = 'general';

    const period = document.getElementById('aiRecommendationPeriod');
    if (period) period.value = '30';

    const focus = document.getElementById('aiRecommendationFocus');
    if (focus) focus.value = 'overall';

    const focusWrap = document.getElementById('aiRecommendationCategoryWrap');
    if (focusWrap) focusWrap.style.display = 'none';

    try {
        if (focus && !focus.__ai_bound) {
            focus.__ai_bound = true;
            focus.addEventListener('change', () => {
                const wrap = document.getElementById('aiRecommendationCategoryWrap');
                const category = document.getElementById('aiRecommendationCategory');
                if (!wrap) return;
                if (focus.value === 'category') {
                    wrap.style.display = '';
                    if (category && (!category.options || category.options.length <= 1)) {
                        window._aiLoadCategories && window._aiLoadCategories();
                    }
                } else {
                    wrap.style.display = 'none';
                }
            });
        }
    } catch (e) {}

    if (window._aiLoadCategories) {
        window._aiLoadCategories();
    }
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
};

window._aiLoadCategories = async function() {
    const select = document.getElementById('aiRecommendationCategory');
    if (!select) return;

    select.innerHTML = '<option value="">Carregando...</option>';

    try {
        const all = [];
        for (const t of ['expense', 'income']) {
            const r = await fetch(`{{ url_for('gerenciamento_financeiro.api_categories') }}?type=${t}`);
            const d = await r.json().catch(() => ({}));
            if (d && d.categories && Array.isArray(d.categories)) {
                d.categories.forEach(c => {
                    all.push({
                        id: c.id,
                        name: c.name,
                        type: t,
                        icon: c.icon || ''
                    });
                });
            }
        }

        all.sort((a, b) => (a.name || '').localeCompare((b.name || ''), 'pt-BR'));

        select.innerHTML = '<option value="">Selecione...</option>';
        all.forEach(c => {
            const opt = document.createElement('option');
            opt.value = String(c.id);
            opt.textContent = `${c.icon ? c.icon + ' ' : ''}${c.name} (${c.type === 'expense' ? 'despesa' : 'entrada'})`;
            opt.setAttribute('data-name', c.name || '');
            opt.setAttribute('data-type', c.type || '');
            select.appendChild(opt);
        });
    } catch (e) {
        select.innerHTML = '<option value="">Falha ao carregar categorias</option>';
    }
};

window.requestAiRecommendations = async function() {
    const btn = document.getElementById('aiRecommendationBtn');
    const spinner = document.getElementById('aiRecommendationSpinner');
    const output = document.getElementById('aiRecommendationOutput');
    const cached = document.getElementById('aiRecommendationCached');
    const err = document.getElementById('aiRecommendationError');

    if (output) output.textContent = '';
    if (cached) cached.style.display = 'none';
    if (err) {
        err.style.display = 'none';
        err.textContent = '';
    }

    const presetEl = document.getElementById('aiRecommendationPreset');
    const preset = presetEl ? (presetEl.value || 'general') : 'general';

    const periodEl = document.getElementById('aiRecommendationPeriod');
    const periodDays = periodEl ? (periodEl.value || '90') : '90';

    const focusEl = document.getElementById('aiRecommendationFocus');
    const focus = focusEl ? (focusEl.value || 'overall') : 'overall';

    const categoryEl = document.getElementById('aiRecommendationCategory');
    const selectedCategoryOpt = (categoryEl && categoryEl.selectedOptions && categoryEl.selectedOptions[0]) ? categoryEl.selectedOptions[0] : null;
    const selectedCategoryName = selectedCategoryOpt ? (selectedCategoryOpt.getAttribute('data-name') || '') : '';
    const selectedCategoryType = selectedCategoryOpt ? (selectedCategoryOpt.getAttribute('data-type') || '') : '';

    const presetContextMap = {
        general: 'Gere uma recomenda√ß√£o completa e autom√°tica para melhorar a sa√∫de financeira com base nos dados do workspace.',
        vacation: 'Gere um plano para preparar e organizar finan√ßas para f√©rias (antecipar despesas, metas, cortes e cronograma).',
        debt: 'Gere um plano para quitar d√≠vidas/parcelas e organizar pagamentos, priorizando juros e fluxo de caixa.',
        cut_expenses: 'Gere um plano para cortar gastos: identificar categorias que mais pesam e sugerir cortes pr√°ticos.',
        increase_income: 'Gere um plano para aumentar renda: ideias, metas e como reinvestir/organizar o or√ßamento.',
        emergency_fund: 'Gere um plano para montar reserva de emerg√™ncia com metas, prazos e percentual da renda.'
    };

    let ctx = presetContextMap[preset] || presetContextMap.general;
    ctx += `\n\nPer√≠odo selecionado: √∫ltimos ${periodDays} dias.`;
    if (focus === 'category') {
        if (!selectedCategoryName) {
            ctx += '\nFoco: categoria espec√≠fica (n√£o selecionada). Sugira quais categorias seriam mais relevantes e pe√ßa para selecionar uma.';
        } else {
            ctx += `\nFoco: categoria ${selectedCategoryName} (${selectedCategoryType === 'expense' ? 'despesa' : 'entrada'}).`;
            ctx += '\nAnalise essa categoria e sugira a√ß√µes espec√≠ficas.';
        }
    } else {
        ctx += '\nFoco: vis√£o geral do workspace.';
    }

    try {
        if (btn) btn.disabled = true;
        if (spinner) spinner.style.display = 'inline-block';

        const resp = await fetch('{{ url_for("gerenciamento_financeiro.api_ai_recommendations") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                workspace_id: {{ active_workspace.id if active_workspace else 'null' }},
                period_days: Number(periodDays),
                focus: focus,
                category_id: (focus === 'category' && categoryEl && categoryEl.value) ? Number(categoryEl.value) : null,
                context: ctx
            })
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
            let msg = (data && data.error) ? data.error : 'Erro ao gerar recomenda√ß√£o.';
            if (data && data.details) {
                try {
                    const detailsStr = (typeof data.details === 'string') ? data.details : JSON.stringify(data.details);
                    msg = msg + ' - ' + detailsStr;
                } catch (e) {}
            }
            if (err) {
                err.style.display = 'block';
                err.textContent = msg;
            }
            window.showToast(msg, 'warning');
            return;
        }

        if (cached && data && data.cached) {
            cached.style.display = 'inline-block';
        }
        if (output) {
            output.textContent = data && data.recommendation ? data.recommendation : '';
        }
    } catch (e) {
        const msg = 'Falha ao gerar recomenda√ß√£o de IA.';
        if (err) {
            err.style.display = 'block';
            err.textContent = msg;
        }
        window.showToast(msg, 'error');
    } finally {
        if (btn) btn.disabled = false;
        if (spinner) spinner.style.display = 'none';
    }
};

let currentEditingId = null;

document.addEventListener('DOMContentLoaded', () => {
    const d = document.getElementById('transactionDate');
    if (d) d.value = new Date().toISOString().split('T')[0];
    const f = document.getElementById('addTransactionForm');
    if (f) f.addEventListener('submit', saveTransaction);
    setupPreviewListeners();
});

// Vari√°veis para controle das abas de transa√ß√µes
let currentTransactionsTab = 'mesAtual';
let allTransactionsCache = null;

// Vari√°veis para filtro global de m√™s/ano
let globalFilterMonth = ({{ selected_month|default(None)|tojson }}) || (new Date().getMonth() + 1);
let globalFilterYear = ({{ selected_year|default(None)|tojson }}) || (new Date().getFullYear());

// Inst√¢ncia do Flatpickr
let calendarPicker = null;

// Inicializar filtro de m√™s/ano
function initGlobalFilter() {
    updateSelectedPeriodText();
    initPeriodSelector();
}

// Atualizar texto do per√≠odo selecionado
function updateSelectedPeriodText() {
    const monthNames = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    const textEl = document.getElementById('periodSelectorText');
    if (textEl) {
        textEl.textContent = `${monthNames[globalFilterMonth - 1]} ${globalFilterYear}`;
    }
}

// Inicializar seletor de per√≠odo
function initPeriodSelector() {
    const btn = document.getElementById('periodSelectorBtn');
    const dropdown = document.getElementById('periodSelectorDropdown');
    const monthsGrid = document.getElementById('periodMonthsGrid');
    const yearDisplay = document.getElementById('periodYearDisplay');

    if (!btn || !dropdown || !monthsGrid) return;

    // Renderizar meses
    function renderMonths(year) {
        const monthNames = [
            'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
            'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
        ];
        monthsGrid.innerHTML = '';
        monthNames.forEach((name, idx) => {
            const monthBtn = document.createElement('button');
            monthBtn.type = 'button';
            monthBtn.className = 'period-month-btn';
            if (year === globalFilterYear && idx + 1 === globalFilterMonth) {
                monthBtn.classList.add('active');
            }
            monthBtn.textContent = name;
            monthBtn.onclick = () => selectMonth(idx + 1, year);
            monthsGrid.appendChild(monthBtn);
        });
    }

    // Atualizar ano exibido
    function updateYearDisplay(year) {
        yearDisplay.textContent = year;
        renderMonths(year);
    }

    // Abrir/fechar dropdown
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = dropdown.style.display !== 'none';
        dropdown.style.display = isOpen ? 'none' : 'block';
        btn.classList.toggle('active', !isOpen);
        if (!isOpen) {
            updateYearDisplay(globalFilterYear);
        }
    });

    // Fechar ao clicar fora
    document.addEventListener('click', (e) => {
        if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
            btn.classList.remove('active');
        }
    });

    // Renderizar inicial
    renderMonths(globalFilterYear);
}

// Mudar ano no seletor
function changePeriodYear(delta) {
    const yearDisplay = document.getElementById('periodYearDisplay');
    const monthsGrid = document.getElementById('periodMonthsGrid');
    const currentYear = parseInt(yearDisplay.textContent);
    const newYear = currentYear + delta;

    // Limitar a um range razo√°vel
    if (newYear < 2020 || newYear > new Date().getFullYear() + 2) return;

    yearDisplay.textContent = newYear;
    const monthNames = [
        'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
        'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
    ];
    monthsGrid.innerHTML = '';
    monthNames.forEach((name, idx) => {
        const monthBtn = document.createElement('button');
        monthBtn.type = 'button';
        monthBtn.className = 'period-month-btn';
        if (newYear === globalFilterYear && idx + 1 === globalFilterMonth) {
            monthBtn.classList.add('active');
        }
        monthBtn.textContent = name;
        monthBtn.onclick = () => selectMonth(idx + 1, newYear);
        monthsGrid.appendChild(monthBtn);
    });
}

// Selecionar m√™s
function selectMonth(month, year) {
    globalFilterMonth = month;
    globalFilterYear = year;
    updateSelectedPeriodText();
    closePeriodSelector();
    applyGlobalFilter();
}

// Selecionar m√™s atual
function selectCurrentMonth() {
    const now = new Date();
    selectMonth(now.getMonth() + 1, now.getFullYear());
}

// Fechar seletor
function closePeriodSelector() {
    const btn = document.getElementById('periodSelectorBtn');
    const dropdown = document.getElementById('periodSelectorDropdown');
    if (dropdown) dropdown.style.display = 'none';
    if (btn) btn.classList.remove('active');
}

// Toggle mobile menu
function toggleMobileMenu() {
    const dropdown = document.getElementById('mobileMenuDropdown');
    if (dropdown) {
        const isOpen = dropdown.style.display !== 'none';
        dropdown.style.display = isOpen ? 'none' : 'block';
    }
}

// Fechar mobile menu
function closeMobileMenu() {
    const dropdown = document.getElementById('mobileMenuDropdown');
    if (dropdown) dropdown.style.display = 'none';
}

// Fechar mobile menu ao clicar fora
document.addEventListener('click', function(e) {
    const btn = document.getElementById('mobileMenuBtn');
    const dropdown = document.getElementById('mobileMenuDropdown');
    if (btn && dropdown && !btn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
    }
});

// Aplicar filtro global (server-driven: recarrega a p√°gina)
function applyGlobalFilter() {
    const baseUrl = '{{ url_for("gerenciamento_financeiro.home") }}';
    window.location.href = `${baseUrl}?month=${encodeURIComponent(globalFilterMonth)}&year=${encodeURIComponent(globalFilterYear)}`;
}

// Inicializar mobile menu ao carregar p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Fechar mobile menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
        if (window.innerWidth >= 768) {
            const dropdown = document.getElementById('mobileMenuDropdown');
            if (dropdown) dropdown.style.display = 'none';
        }
    });
});

// Carregar cards de resumo (saldo, entradas, despesas) - API otimizada
async function loadSummaryCards() {
    try {
        const url = `/gerenciamento-financeiro/api/summary-cards?year=${globalFilterYear}&month=${globalFilterMonth}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) {
            console.error('Erro ao carregar cards:', data.error);
            return;
        }
        
        // Atualizar cards com os dados recebidos
        updateCardsDisplay(data);
        
    } catch (error) {
        console.error('Erro ao carregar resumo:', error);
    }
}

// Fun√ß√£o auxiliar para atualizar a exibi√ß√£o dos cards
function updateCardsDisplay(data) {
    // Formata√ß√£o de moeda
    const formatBRL = (v) => {
        const val = typeof v === 'number' ? v : parseFloat(v || 0);
        return val.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    };
    
    // Atualizar saldo total
    const balanceEl = document.getElementById('totalBalance');
    if (balanceEl) {
        const balance = data.balance || 0;
        balanceEl.textContent = `${balance >= 0 ? '+' : '-'}R$ ${formatBRL(Math.abs(balance))}`;
        balanceEl.style.color = balance >= 0 ? '#11998e' : '#ee0979';
    }
    
    // Atualizar entradas do m√™s
    const incomeEl = document.getElementById('totalIncome');
    if (incomeEl) {
        incomeEl.textContent = `+R$ ${formatBRL(data.monthly_income || 0)}`;
    }
    
    // Atualizar gastos do m√™s
    const expenseEl = document.getElementById('totalExpense');
    if (expenseEl) {
        expenseEl.textContent = `-R$ ${formatBRL(data.monthly_expense || 0)}`;
    }
    
    // Atualizar taxa de economia
    const savingsRateEl = document.querySelector('.card-title.text-info');
    if (savingsRateEl) {
        savingsRateEl.textContent = `${(data.savings_rate || 0).toFixed(1)}%`;
    }
    
    const savingsEl = document.querySelector('.text-muted small');
    if (savingsEl && savingsEl.textContent.includes('economizado')) {
        savingsEl.innerHTML = `R$ ${formatBRL(data.savings || 0)} economizado`;
    }
}

// Inicializar filtro ao carregar p√°gina
document.addEventListener('DOMContentLoaded', () => {
    initGlobalFilter();
    // Aplicar filtro padr√£o de entradas ao carregar a p√°gina
    filterTransactionsByType('income');

    fetchCategories('income');
    fetchCategories('expense');
    
    // Verificar convites pendentes para atualizar √≠cone de notifica√ß√£o no menu do usu√°rio
    checkPendingInvites();

    // Add event listener for shared tab
    const sharedTab = document.getElementById('shared-tab');
    if (sharedTab) {
        sharedTab.addEventListener('click', loadSharedTab);
    }

    // Fechar mobile menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
        if (window.innerWidth >= 768) {
            const dropdown = document.getElementById('mobileMenuDropdown');
            if (dropdown) dropdown.style.display = 'none';
        }
    });
});

// Filtro de tipo de transa√ß√£o (Entradas, Sa√≠das)
function filterTransactionsByType(type) {
    const items = document.querySelectorAll('#recentTransactionsTbody .transaction-item');
    const tabEntradas = document.getElementById('tabEntradas');
    const tabSaidas = document.getElementById('tabSaidas');
    
    // Atualizar estilos das abas
    if (tabEntradas && tabSaidas) {
        if (type === 'income') {
            tabEntradas.style.borderBottomColor = '#10b981';
            tabEntradas.style.color = '#10b981';
            tabSaidas.style.borderBottomColor = 'transparent';
            tabSaidas.style.color = 'var(--text-secondary)';
        } else if (type === 'expense') {
            tabSaidas.style.borderBottomColor = '#ef4444';
            tabSaidas.style.color = '#ef4444';
            tabEntradas.style.borderBottomColor = 'transparent';
            tabEntradas.style.color = 'var(--text-secondary)';
        }
    }
    
    // Filtrar itens
    items.forEach(item => {
        const itemType = item.getAttribute('data-type');
        if (itemType === type) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Atualizar contador
    const visibleCount = Array.from(items).filter(i => i.style.display !== 'none').length;
    const countBadge = document.getElementById('transactionsCount');
    if (countBadge) {
        const label = type === 'income' ? 'entradas' : 'sa√≠das';
        countBadge.textContent = `${visibleCount} ${label}`;
    }
}


function toggleFixedOptions() {
    const isFixed = document.getElementById('isFixed').checked;
    const container = document.getElementById('fixedOptionsContainer');
    const txType = document.getElementById('transactionType')?.value;
    const incomeDayContainer = document.getElementById('incomeDayContainer');
    const transactionDateContainer = document.getElementById('transactionDateContainer');
    const incomeDayEl = document.getElementById('incomeDay');
    const transactionDateEl = document.getElementById('transactionDate');
    const dateLabel = document.getElementById('dateLabel');
    
    if (container) {
        container.style.display = isFixed ? 'block' : 'none';
    }

    if (isFixed) {
        toggleInstallmentsField();
        updateFixedDurationUI();
        
        // Para despesas fixas, mudar para input de dia apenas
        if (txType === 'expense') {
            if (dateLabel) dateLabel.textContent = 'Dia do vencimento *';
            if (transactionDateContainer) transactionDateContainer.style.display = 'none';
            if (incomeDayContainer) incomeDayContainer.style.display = 'block';
            if (transactionDateEl) transactionDateEl.required = false;
            if (incomeDayEl) {
                incomeDayEl.required = true;
                if (!incomeDayEl.value) incomeDayEl.value = String(new Date().getDate());
                if (transactionDateEl) transactionDateEl.value = _computeIncomeDateFromDay(incomeDayEl.value, globalFilterYear, globalFilterMonth);
            }
        }
    } else {
        // Se desmarcar fixo em despesa, voltar para data completa
        if (txType === 'expense') {
            if (dateLabel) dateLabel.textContent = 'Data de vencimento *';
            if (incomeDayContainer) incomeDayContainer.style.display = 'none';
            if (transactionDateContainer) transactionDateContainer.style.display = 'block';
            if (transactionDateEl) transactionDateEl.required = true;
            if (incomeDayEl) incomeDayEl.required = false;
        }
    }
}

function toggleInstallmentsField() {
    const withInstallments = document.getElementById('fixedWithInstallments');
    const installmentsContainer = document.getElementById('installmentsFieldContainer');
    
    if (withInstallments && installmentsContainer) {
        installmentsContainer.style.display = withInstallments.checked ? 'block' : 'none';
        
        if (withInstallments.checked) {
            updateFixedDurationUI();
        }
    }
}

function _normalizeFixedMonths(value) {
    const input = document.getElementById('fixedMonths');
    const min = Number(input?.min || 1);
    const max = Number(input?.max || 120);
    const n = parseInt(value, 10);
    if (Number.isNaN(n)) return Math.max(min, Math.min(12, max));
    return Math.max(min, Math.min(n, max));
}

function setFixedMonths(value) {
    const input = document.getElementById('fixedMonths');
    if (!input) return;
    input.value = _normalizeFixedMonths(value);
}

function stepFixedMonths(delta) {
    const input = document.getElementById('fixedMonths');
    if (!input) return;
    const current = _normalizeFixedMonths(input.value);
    setFixedMonths(current + delta);
}

function updateFixedDurationUI() {
    const type = document.getElementById('transactionType')?.value;
    const label = document.getElementById('fixedDurationLabel');
    const hint = document.getElementById('fixedDurationHint');

    if (type === 'expense') {
        if (label) label.textContent = 'Qtd de parcelas *';
        if (hint) hint.textContent = 'Ser√° criada uma despesa para cada parcela (m√™s).';
    } else {
        if (label) label.textContent = 'Por quantos meses? *';
        if (hint) hint.textContent = 'Ser√° criada uma transa√ß√£o para cada m√™s.';
    }
    
    updateInstallmentsPreview();
}

function updateInstallmentsPreview() {
    const isFixed = document.getElementById('isFixed')?.checked;
    const preview = document.getElementById('installmentsPreview');
    const list = document.getElementById('previewInstallmentsList');
    const totalBadge = document.getElementById('previewTotalBadge');
    
    if (!preview || !list || !totalBadge) return;
    
    if (!isFixed) {
        preview.style.display = 'none';
        return;
    }
    
    const amount = _parseBRL(document.getElementById('amount')?.value || '0');
    const months = Math.min(120, Math.max(1, parseInt(document.getElementById('fixedMonths')?.value) || 12));
    const startDate = document.getElementById('transactionDate')?.value;
    const categorySelect = document.getElementById('category');
    const categoryName = categorySelect?.selectedIndex > 0 ? categorySelect.options[categorySelect.selectedIndex].text.replace(/^[^\s]+\s/, '') : '';
    const description = document.getElementById('description')?.value || categoryName || 'Despesa';
    
    if (!amount || amount <= 0) {
        preview.style.display = 'none';
        return;
    }
    
    preview.style.display = 'block';
    
    const total = amount * months;
    totalBadge.textContent = `Total: R$ ${_formatBRL(total)}`;
    
    let html = '<div class="row g-1">';
    const baseDate = startDate ? new Date(startDate + 'T12:00:00') : new Date();
    
    const maxShow = Math.min(months, 6);
    for (let i = 0; i < maxShow; i++) {
        const installmentDate = new Date(baseDate);
        installmentDate.setMonth(installmentDate.getMonth() + i);
        const dateStr = installmentDate.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
        const installmentDesc = `${description} ${i + 1}/${months}`;
        
        html += `
            <div class="col-6 col-md-4">
                <div class="d-flex align-items-center gap-1 p-1 rounded" style="background: rgba(255,255,255,0.5);">
                    <span class="badge bg-secondary" style="font-size: 0.7rem;">${i + 1}</span>
                    <div class="flex-grow-1 text-truncate" style="font-size: 0.75rem;">
                        <div class="text-truncate fw-medium">${installmentDesc}</div>
                        <small class="text-muted">${dateStr} ¬∑ R$ ${_formatBRL(amount)}</small>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (months > maxShow) {
        html += `
            <div class="col-12 text-center text-muted" style="font-size: 0.75rem;">
                <i class="bi bi-three-dots"></i> e mais ${months - maxShow} parcelas
            </div>
        `;
    }
    
    html += '</div>';
    list.innerHTML = html;
}

function setupPreviewListeners() {
    const amountEl = document.getElementById('amount');
    const monthsEl = document.getElementById('fixedMonths');
    const dateEl = document.getElementById('transactionDate');
    const incomeDayEl = document.getElementById('incomeDay');
    const categoryEl = document.getElementById('category');
    const descEl = document.getElementById('description');
    
    const update = () => updateInstallmentsPreview();
    
    if (amountEl) amountEl.addEventListener('input', update);
    if (monthsEl) monthsEl.addEventListener('input', update);
    if (dateEl) dateEl.addEventListener('change', update);
    if (incomeDayEl) incomeDayEl.addEventListener('input', () => {
        const d = document.getElementById('transactionDate');
        if (d) d.value = _computeIncomeDateFromDay(incomeDayEl.value, globalFilterYear, globalFilterMonth);
        update();
    });
    if (categoryEl) categoryEl.addEventListener('change', update);
    if (descEl) descEl.addEventListener('input', update);
}

function showAddTransaction(type) {
    const m = new bootstrap.Modal(document.getElementById('addTransactionModal'));
    const t = document.getElementById('addTransactionTitle');
    const ti = document.getElementById('transactionType');
    const sb = document.getElementById('saveButton');
    const dateLabel = document.getElementById('dateLabel');
    const notesField = document.getElementById('notesField');
    const incomeDayContainer = document.getElementById('incomeDayContainer');
    const transactionDateContainer = document.getElementById('transactionDateContainer');
    const incomeDayEl = document.getElementById('incomeDay');
    const transactionDateEl = document.getElementById('transactionDate');
    
    document.getElementById('addTransactionForm').reset();
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    _setupAmountMask();
    
    // Reset fixed options fields and preview
    const fixedOptionsContainer = document.getElementById('fixedOptionsContainer');
    if (fixedOptionsContainer) fixedOptionsContainer.style.display = 'none';
    const installmentsContainer = document.getElementById('installmentsFieldContainer');
    if (installmentsContainer) installmentsContainer.style.display = 'none';
    const preview = document.getElementById('installmentsPreview');
    if (preview) preview.style.display = 'none';
    
    // Reset radio buttons to default
    const withoutInstallments = document.getElementById('fixedWithoutInstallments');
    if (withoutInstallments) withoutInstallments.checked = true;
    
    currentEditingId = null;
    ti.value = type;
    
    if (type === 'income') {
        t.innerHTML = '<i class="bi bi-plus-circle text-success me-2"></i>Nova Entrada';
        sb.className = 'btn btn-success';
        sb.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Entrada';
        if (dateLabel) dateLabel.textContent = 'Dia que entra na conta *';
        if (transactionDateContainer) transactionDateContainer.style.display = 'none';
        if (incomeDayContainer) incomeDayContainer.style.display = 'block';
        if (transactionDateEl) transactionDateEl.required = false;
        if (incomeDayEl) {
            incomeDayEl.required = true;
            incomeDayEl.value = String(new Date().getDate());
            if (transactionDateEl) transactionDateEl.value = _computeIncomeDateFromDay(incomeDayEl.value, globalFilterYear, globalFilterMonth);
        }
        // Mostrar campo de observa√ß√£o para entradas
        if (notesField) notesField.style.display = 'block';
    } else {
        t.innerHTML = '<i class="bi bi-dash-circle text-danger me-2"></i>Nova Despesa';
        sb.className = 'btn btn-danger';
        sb.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Salvar Despesa';
        if (dateLabel) dateLabel.textContent = 'Data de vencimento *';
        if (incomeDayContainer) incomeDayContainer.style.display = 'none';
        if (transactionDateContainer) transactionDateContainer.style.display = 'block';
        if (transactionDateEl) transactionDateEl.required = true;
        if (incomeDayEl) incomeDayEl.required = false;
        // Ocultar campo de observa√ß√£o para despesas
        if (notesField) notesField.style.display = 'none';
    }

    updateFixedDurationUI();
    loadCategories(type);
    setupSubcategoryListener();
    m.show();
}

async function loadCategories(type) {
    const select = document.getElementById('category');
    if (select) {
        select.disabled = true;
        select.innerHTML = '<option value="">Carregando...</option>';
    }

    try {
        const categories = await fetchCategories(type);
        const s = document.getElementById('category');
        if (!s) return;
        s.innerHTML = '<option value="">Selecione uma categoria</option>';
        categories.forEach(c => {
            const o = document.createElement('option');
            o.value = c.id;
            o.textContent = `${c.icon || 'üí∞'} ${c.name}`;
            s.appendChild(o);
        });
        s.disabled = false;
        s.dispatchEvent(new Event('change', { bubbles: true }));
    } catch (e) {
        console.error('Erro:', e);
        const s = document.getElementById('category');
        if (s) {
            s.disabled = false;
            s.innerHTML = '<option value="">Selecione uma categoria</option>';
        }
    }
}

const _categoriesCache = { income: null, expense: null };
const _categoriesFetchedAt = { income: 0, expense: 0 };
const _categoriesInFlight = { income: null, expense: null };

const _subcategoriesCache = {};
const _subcategoriesFetchedAt = {};
const _subcategoriesInFlight = {};
let _subcategoriesReqSeq = 0;

async function fetchSubcategories(categoryId, force = false) {
    const ttlMs = 5 * 60 * 1000;
    const key = String(categoryId);
    const last = _subcategoriesFetchedAt[key] || 0;
    if (!force && _subcategoriesCache[key] && (Date.now() - last) < ttlMs) {
        return _subcategoriesCache[key];
    }
    if (!force && _subcategoriesInFlight[key]) {
        return _subcategoriesInFlight[key];
    }

    _subcategoriesInFlight[key] = (async () => {
        const r = await fetch(`{{ url_for('gerenciamento_financeiro.api_subcategories') }}?category_id=${encodeURIComponent(key)}`);
        const d = await r.json();
        if (!r.ok) throw new Error(d?.error || 'Erro ao carregar subcategorias');
        const subs = Array.isArray(d.subcategories) ? d.subcategories : [];
        _subcategoriesCache[key] = subs;
        _subcategoriesFetchedAt[key] = Date.now();
        return subs;
    })();

    try {
        return await _subcategoriesInFlight[key];
    } finally {
        _subcategoriesInFlight[key] = null;
    }
}

async function fetchCategories(type, force = false) {
    const ttlMs = 5 * 60 * 1000;
    if (!force && _categoriesCache[type] && (Date.now() - (_categoriesFetchedAt[type] || 0)) < ttlMs) {
        return _categoriesCache[type];
    }
    if (!force && _categoriesInFlight[type]) {
        return _categoriesInFlight[type];
    }

    _categoriesInFlight[type] = (async () => {
        const r = await fetch(`{{ url_for('gerenciamento_financeiro.api_categories') }}?type=${type}`);
        const d = await r.json();
        if (!r.ok) throw new Error(d?.error || 'Erro ao carregar categorias');
        const cats = Array.isArray(d.categories) ? d.categories : [];
        _categoriesCache[type] = cats;
        _categoriesFetchedAt[type] = Date.now();
        return cats;
    })();

    try {
        return await _categoriesInFlight[type];
    } finally {
        _categoriesInFlight[type] = null;
    }
}

async function loadSubcategories(categoryId) {
    const subField = document.getElementById('subcategoryField');
    const subSelect = document.getElementById('subcategory');
    if (!categoryId) {
        subField.style.display = 'none';
        subSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        return;
    }

    const reqId = ++_subcategoriesReqSeq;

    try {
        subField.style.display = 'block';
        subSelect.disabled = true;
        subSelect.innerHTML = '<option value="">Carregando...</option>';

        const subs = await fetchSubcategories(categoryId);
        if (reqId !== _subcategoriesReqSeq) return;

        if (!subs || subs.length === 0) {
            subField.style.display = 'none';
            subSelect.disabled = false;
            subSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
            return;
        }

        subField.style.display = 'block';
        subSelect.disabled = false;
        subSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
        subs.forEach(s => {
            const o = document.createElement('option');
            o.value = s.id;
            o.textContent = `${s.icon || 'üìå'} ${s.name}`;
            subSelect.appendChild(o);
        });
    } catch (e) {
        console.error('Erro ao carregar subcategorias:', e);
        if (reqId !== _subcategoriesReqSeq) return;
        subField.style.display = 'none';
        subSelect.disabled = false;
        subSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
    }
}

function setupSubcategoryListener() {
    const catSelect = document.getElementById('category');
    if (catSelect) {
        catSelect.removeEventListener('change', handleCategoryChange);
        catSelect.addEventListener('change', handleCategoryChange);
    }
}

function handleCategoryChange(e) {
    loadSubcategories(e.target.value);
}

document.addEventListener('DOMContentLoaded', () => {
    setupSubcategoryListener();
});

function _computeIncomeDateFromDay(day, baseYear = null, baseMonth = null) {
    const n = parseInt(day, 10);
    const today = new Date();

    const y = Number.isFinite(Number(baseYear)) ? Number(baseYear) : today.getFullYear();
    const mIndex = Number.isFinite(Number(baseMonth)) ? (Number(baseMonth) - 1) : today.getMonth();

    const lastDay = new Date(y, mIndex + 1, 0).getDate();
    const safeDay = Math.min(Math.max(1, n || 1), lastDay);
    const d = new Date(y, mIndex, safeDay);
    return d.toISOString().split('T')[0];
}

async function saveTransaction(e) {
    e.preventDefault();
    const btn = document.getElementById('saveButton');
    const sp = btn.querySelector('.spinner-border');
    btn.disabled = true;
    sp.classList.remove('d-none');
    
    const txType = document.getElementById('transactionType').value;
    const isFixed = document.getElementById('isFixed').checked;
    const fixedMonths = Math.min(120, Math.max(1, parseInt(document.getElementById('fixedMonths')?.value) || 12));

    const fixedWithoutInstallments = document.getElementById('fixedWithoutInstallments');
    const fixedWithInstallments = document.getElementById('fixedWithInstallments');

    let fixedDurationType = null;
    if (isFixed) {
        if (txType === 'income') {
            fixedDurationType = 'infinite';
        } else {
            fixedDurationType = (fixedWithInstallments && fixedWithInstallments.checked) ? 'months' : 'infinite';
        }
    }
    
    let txDate = document.getElementById('transactionDate').value;
    if (txType === 'income' || (txType === 'expense' && isFixed)) {
        const incomeDay = document.getElementById('incomeDay')?.value;
        if (incomeDay) {
            txDate = _computeIncomeDateFromDay(incomeDay, globalFilterYear, globalFilterMonth);
        }
    }
    
    const categorySelect = document.getElementById('category');
    const categoryText = categorySelect.selectedIndex > 0 
        ? categorySelect.options[categorySelect.selectedIndex].text.replace(/^[^\s]+\s/, '').trim()
        : '';
    const descriptionValue = document.getElementById('description').value.trim();
    const finalDescription = descriptionValue || categoryText || 'Transa√ß√£o';
    
    const fd = {
        type: txType,
        description: finalDescription,
        notes: document.getElementById('notes') ? (document.getElementById('notes').value || null) : null,
        amount: _parseBRL(document.getElementById('amount').value),
        transaction_date: txDate,
        category_id: document.getElementById('category').value,
        subcategory_id: document.getElementById('subcategory').value || null,
        frequency: 'once',
        is_recurring: isFixed,
        is_fixed: isFixed,
        fixed_duration_type: fixedDurationType,
        fixed_months: (isFixed && fixedDurationType === 'months') ? fixedMonths : null,
        apply_scope: currentEditScope
    };
    
    try {
        let url = '/gerenciamento-financeiro/api/transactions';
        const editingId = currentEditingId;
        if (editingId) url += `/${editingId}`;
        
        const r = await fetch(url, {
            method: editingId ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fd)
        });
        
        const res = await r.json();
        if (r.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
            document.getElementById('addTransactionForm').reset();
            currentEditingId = null;
            
            // Se foi cria√ß√£o de transa√ß√µes recorrentes, recarregar p√°gina
            if (res.created && res.created > 1) {
                showToast(res.message || `${res.created} transa√ß√µes criadas!`, 'success');
                setTimeout(() => location.reload(), 800);
            } else if (editingId) {
                if (currentEditScope === 'series' && res.updated_count && res.updated_count > 1) {
                    showToast(res.message || 'Atualizado!', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    showToast('Atualizado!', 'success');
                    upsertTransactionRow(res);
                    // Atualizar cards de resumo automaticamente
                    loadSummaryCards();
                }
            } else {
                showToast('Salvo!', 'success');
                addTransactionToTable(res);
                // Atualizar cards de resumo automaticamente
                loadSummaryCards();
            }
        } else {
            showToast(res.error || 'Erro', 'error');
        }
    } catch (e) {
        showToast('Erro', 'error');
    } finally {
        btn.disabled = false;
        sp.classList.add('d-none');
    }
}

function _formatBRL(value) {
    const n = Number(value || 0);
    return n.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function _getRecentContainer() {
    return document.getElementById('recentTransactionsTbody');
}

function _buildTransactionCard(t) {
    const date = new Date(t.transaction_date);
    const formattedDate = date.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric'});
    
    const categoryIcon = t.subcategory?.icon || t.category?.icon || (t.type === 'income' ? 'üí∞' : 'üí∏');
    const categoryName = t.category?.name || 'Sem categoria';
    const subcategoryName = t.subcategory?.name || '';
    
    const amount = parseFloat(t.amount || 0);
    const formattedAmount = amount.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    let tags = '';
    if (t.is_fixed || t.is_recurring) {
        tags = '<div class="item-tags">';
        if (t.is_fixed) {
            tags += '<span class="tag tag-fixed">üìå Fixo</span>';
        }
        if (t.is_recurring) {
            tags += '<span class="tag tag-recurring">üîÑ Recorrente</span>';
        }
        tags += '</div>';
    }
    
    return `
        <div class="item-left">
            <div class="item-icon ${t.type === 'income' ? 'icon-green' : 'icon-red'}">
                ${categoryIcon}
            </div>
            
            <div class="item-details">
                <div class="item-name">${t.description || 'Sem descri√ß√£o'}</div>
                <div class="item-info">
                    <span class="info-date">${formattedDate}</span>
                    ${categoryName ? '<span class="info-sep">‚Ä¢</span><span class="info-cat">' + categoryName + '</span>' : ''}
                    ${subcategoryName ? '<span class="info-sep">‚Ä¢</span><span class="info-subcat">' + subcategoryName + '</span>' : ''}
                    ${t.notes ? '<span class="info-sep">‚Ä¢</span><span class="info-note">' + t.notes + '</span>' : ''}
                </div>
                ${tags}
            </div>
        </div>
        
        <div class="item-right">
            <div class="item-value ${t.type === 'income' ? 'value-green' : 'value-red'}">
                ${t.type === 'income' ? '+' : '-'}R$ ${formattedAmount}
            </div>
            <div class="item-actions">
                <button class="btn-action" onclick="editTransaction(${t.id}); event.stopPropagation();" title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn-action btn-delete" onclick="deleteTransaction(${t.id}); event.stopPropagation();" title="Excluir">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
}

function upsertTransactionRow(t) {
    const existing = document.querySelector(`[data-transaction-id="${t.id}"]`);
    if (!existing) {
        addTransactionToTable(t);
        return;
    }

    existing.setAttribute('onclick', `showTransactionDetails(${t.id})`);
    existing.innerHTML = _buildTransactionCard(t);
}

function addTransactionToTable(t) {
    const container = _getRecentContainer();
    if (!container) return;

    const cardWrapper = document.createElement('div');
    cardWrapper.setAttribute('data-transaction-id', t.id);
    cardWrapper.setAttribute('data-type', t.type);
    cardWrapper.className = `transaction-item ${t.type === 'income' ? 'item-income' : 'item-expense'}`;
    cardWrapper.setAttribute('onclick', `showTransactionDetails(${t.id})`);
    cardWrapper.style.animation = 'slideInUp 0.4s ease-out both';
    cardWrapper.innerHTML = _buildTransactionCard(t);
    
    container.insertBefore(cardWrapper, container.firstChild);
}

async function editTransaction(id) {
    try {
        showLoading('Carregando transa√ß√£o...');
        const r = await fetch(`/gerenciamento-financeiro/api/transactions/${id}`);
        const d = await r.json();
        const t = d.transaction;
        if (!t) {
            hideLoading();
            return;
        }
        
        // Esconder loading antes de mostrar modal de escolha
        hideLoading();
        
        const isInstallment = t.is_fixed || t.is_recurring;
        if (isInstallment) {
            const scope = await _chooseEditScope();
            if (!scope) return;
            currentEditScope = scope;
        } else {
            currentEditScope = 'single';
        }

        // Set editing mode FIRST
        currentEditingId = id;
        
        // Get modal elements
        const modalEl = document.getElementById('addTransactionModal');
        const title = document.getElementById('addTransactionTitle');
        const typeInput = document.getElementById('transactionType');
        const saveButton = document.getElementById('saveButton');
        
        // Configure modal for EDIT mode (not "Nova")
        typeInput.value = t.type;
        title.innerHTML = `<i class="bi bi-pencil me-2"></i>Editar ${t.type === 'income' ? 'Entrada' : 'Despesa'}`;
        
        if (t.type === 'income') {
            saveButton.className = 'btn btn-success';
        } else {
            saveButton.className = 'btn btn-danger';
        }
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm d-none me-2"></span>Atualizar Transa√ß√£o';
        
        // Fill form fields
        _setupAmountMask();
        document.getElementById('description').value = t.description || '';
        document.getElementById('amount').value = (typeof t.amount === 'number') 
            ? t.amount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) 
            : String(t.amount || '');
        document.getElementById('transactionDate').value = t.transaction_date;
        const notesEl = document.getElementById('notes');
        if (notesEl) notesEl.value = t.notes || '';
        
        // Load categories and set current one
        await loadCategories(t.type);
        document.getElementById('category').value = t.category?.id || '';
        
        // Hide fixed duration section when editing
        const fixedSection = document.getElementById('fixedDurationSection');
        if (fixedSection) fixedSection.classList.add('d-none');
        
        // Hide loading and show modal
        hideLoading();
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        
    } catch (e) {
        console.error('Erro:', e);
        hideLoading();
    }
}

async function deleteTransaction(id) {
    const ok = await window._openConfirmModal({
        title: 'Excluir transa√ß√£o',
        body: 'Tem certeza que deseja excluir esta transa√ß√£o?',
        confirmText: 'Excluir',
        confirmClass: 'btn-danger'
    });
    if (!ok) return;
    try {
        showLoading('Excluindo...');
        const r = await fetch(`/gerenciamento-financeiro/api/transactions/${id}`, { method: 'DELETE' });
        hideLoading();
        if (r.ok) {
            showToast('Exclu√≠do!', 'success');
            const row = document.querySelector(`[data-transaction-id="${id}"]`);
            if (row) {
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            // Atualizar cards de resumo automaticamente
            loadSummaryCards();
        }
    } catch (e) {
        console.error('Erro:', e);
        hideLoading();
    }
}

async function showMonthlyHistory() {
    const modal = new bootstrap.Modal(document.getElementById('monthlyHistoryModal'));
    modal.show();
    await loadMonthlyHistory();
}

let _allTransactionsCache = [];

async function loadMonthlyHistory() {
    const containerAll = document.getElementById('historyContentAll');
    const containerIncome = document.getElementById('historyContentIncome');
    const containerExpense = document.getElementById('historyContentExpense');
    const filterMonth = document.getElementById('historyFilterMonth')?.value;
    const filterYear = document.getElementById('historyFilterYear')?.value;
    
    const loadingHtml = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
    containerAll.innerHTML = loadingHtml;
    containerIncome.innerHTML = loadingHtml;
    containerExpense.innerHTML = loadingHtml;
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/transactions?limit=5000');
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data?.error || 'Erro ao carregar hist√≥rico');
        }
        
        let transactions = data.transactions || [];
        
        // Filtrar por m√™s/ano se especificado
        if (filterMonth || filterYear) {
            transactions = transactions.filter(t => {
                const date = new Date(t.transaction_date);
                const matchMonth = !filterMonth || (date.getMonth() + 1) == filterMonth;
                const matchYear = !filterYear || date.getFullYear() == filterYear;
                return matchMonth && matchYear;
            });
        }
        
        _allTransactionsCache = transactions;
        
        // Renderizar as tr√™s abas
        renderTransactionsList(containerAll, transactions, 'all');
        renderTransactionsList(containerIncome, transactions.filter(t => t.type === 'income'), 'income');
        renderTransactionsList(containerExpense, transactions.filter(t => t.type === 'expense'), 'expense');
        
    } catch (error) {
        const errorHtml = '<div class="alert alert-danger">Erro ao carregar hist√≥rico</div>';
        containerAll.innerHTML = errorHtml;
        containerIncome.innerHTML = errorHtml;
        containerExpense.innerHTML = errorHtml;
    }
}

function renderTransactionsList(container, transactions, type) {
    if (!transactions.length) {
        const emptyMsg = type === 'income' ? 'Nenhuma entrada encontrada' : 
                         type === 'expense' ? 'Nenhuma sa√≠da encontrada' : 
                         'Nenhuma transa√ß√£o encontrada';
        container.innerHTML = `<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p class="mt-3">${emptyMsg}</p></div>`;
        return;
    }
    
    // Agrupar por m√™s
    const grouped = {};
    transactions.forEach(t => {
        const date = new Date(t.transaction_date);
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
    });
    
    let html = '';
    Object.keys(grouped).sort().reverse().forEach(key => {
        const [year, month] = key.split('-');
        const monthName = new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        const items = grouped[key];
        
        const totalIncome = items.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const totalExpense = items.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const balance = totalIncome - totalExpense;
        
        // Cor do header baseada no tipo
        let headerBg = 'linear-gradient(135deg, #3b82f6, #2563eb)';
        if (type === 'income') headerBg = 'linear-gradient(135deg, #10b981, #059669)';
        if (type === 'expense') headerBg = 'linear-gradient(135deg, #ef4444, #dc2626)';
        
        html += `
            <div class="card mb-3" style="border-radius: 12px;">
                <div class="card-header" style="background: ${headerBg}; color: white; border-radius: 12px 12px 0 0;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-capitalize"><i class="bi bi-calendar-month me-2"></i>${monthName}</h6>
                        <span class="badge bg-light text-dark">${items.length} ${type === 'income' ? 'entradas' : type === 'expense' ? 'sa√≠das' : 'transa√ß√µes'}</span>
                    </div>
                    <div class="row mt-2 text-center">
                        ${type === 'all' ? `
                            <div class="col-4">
                                <small class="d-block opacity-75">Entradas</small>
                                <strong>+R$ ${_formatBRL(totalIncome)}</strong>
                            </div>
                            <div class="col-4">
                                <small class="d-block opacity-75">Sa√≠das</small>
                                <strong>-R$ ${_formatBRL(totalExpense)}</strong>
                            </div>
                            <div class="col-4">
                                <small class="d-block opacity-75">Saldo</small>
                                <strong class="${balance >= 0 ? '' : 'text-warning'}">R$ ${_formatBRL(Math.abs(balance))}</strong>
                            </div>
                        ` : type === 'income' ? `
                            <div class="col-12">
                                <small class="d-block opacity-75">Total de Entradas</small>
                                <strong style="font-size: 1.2rem;">+R$ ${_formatBRL(totalIncome)}</strong>
                            </div>
                        ` : `
                            <div class="col-12">
                                <small class="d-block opacity-75">Total de Sa√≠das</small>
                                <strong style="font-size: 1.2rem;">-R$ ${_formatBRL(totalExpense)}</strong>
                            </div>
                        `}
                    </div>
                </div>
                <div class="card-body p-2">
                    ${items.map(t => {
                        const date = new Date(t.transaction_date);
                        const categoryIcon = t.category?.icon || (t.type === 'income' ? 'üíµ' : 'üí∏');
                        const subcategoryBadge = t.subcategory ? `<span class="badge" style="background: #8b5cf6; color: white; font-size: 0.65rem;">${t.subcategory.icon || 'üìå'} ${t.subcategory.name}</span>` : '';
                        const amountColor = t.type === 'income' ? '#11998e' : '#ee0979';
                        const amountSign = t.type === 'income' ? '+' : '-';
                        return `
                            <div class="d-flex align-items-center justify-content-between p-2 border-bottom" style="cursor: pointer;" onclick="showTransactionDetails(${t.id})">
                                <div class="d-flex align-items-center gap-2">
                                    <span style="font-size: 1.5rem;">${categoryIcon}</span>
                                    <div>
                                        <div class="fw-semibold">${t.description}</div>
                                        <div class="d-flex align-items-center gap-1">
                                            <small class="text-muted">${date.toLocaleDateString('pt-BR')}</small>
                                            ${subcategoryBadge}
                                        </div>
                                    </div>
                                </div>
                                <div class="fw-bold" style="color: ${amountColor};">${amountSign}R$ ${_formatBRL(t.amount)}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function filterHistoryByType(type) {
    // As abas j√° est√£o carregadas, n√£o precisa fazer nada
    // O Bootstrap Pills j√° cuida da troca de abas
}


// Abrir modal de gr√°ficos
async function showChartsModal() {
    const modal = new bootstrap.Modal(document.getElementById('chartsModal'));
    modal.show();
    await loadCharts();
}

// Carregar gr√°ficos
let categoryChartInstance = null;
let monthlyChartInstance = null;
let comparisonChartInstance = null;

async function loadCharts() {
    try {
        const response = await fetch('/gerenciamento-financeiro/api/transactions?page=1&per_page=1000');
        const data = await response.json();
        const transactions = data.transactions || [];
        
        // Destruir gr√°ficos existentes
        if (categoryChartInstance) categoryChartInstance.destroy();
        if (monthlyChartInstance) monthlyChartInstance.destroy();
        if (comparisonChartInstance) comparisonChartInstance.destroy();
        
        // 1. Gr√°fico de Pizza - Despesas por Categoria
        const expensesByCategory = {};
        transactions.filter(t => t.type === 'expense').forEach(t => {
            const catName = t.category?.name || 'Sem categoria';
            expensesByCategory[catName] = (expensesByCategory[catName] || 0) + t.amount;
        });
        
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            categoryChartInstance = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{
                        data: Object.values(expensesByCategory),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6',
                            '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#6366f1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = _formatBRL(context.parsed);
                                    return `${label}: R$ ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 2. Gr√°fico de Linha - Evolu√ß√£o Mensal
        const monthlyData = {};
        transactions.forEach(t => {
            const date = new Date(t.transaction_date);
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!monthlyData[key]) {
                monthlyData[key] = { income: 0, expense: 0 };
            }
            if (t.type === 'income') {
                monthlyData[key].income += t.amount;
            } else {
                monthlyData[key].expense += t.amount;
            }
        });
        
        const sortedMonths = Object.keys(monthlyData).sort();
        const monthlyCtx = document.getElementById('monthlyChart');
        if (monthlyCtx) {
            monthlyChartInstance = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [
                        {
                            label: 'Entradas',
                            data: sortedMonths.map(m => monthlyData[m].income),
                            borderColor: '#11998e',
                            backgroundColor: 'rgba(17, 153, 142, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Despesas',
                            data: sortedMonths.map(m => monthlyData[m].expense),
                            borderColor: '#ee0979',
                            backgroundColor: 'rgba(238, 9, 121, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: R$ ${_formatBRL(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + _formatBRL(value)
                            }
                        }
                    }
                }
            });
        }
        
        // 3. Gr√°fico de Barras - Comparativo
        const comparisonCtx = document.getElementById('comparisonChart');
        if (comparisonCtx) {
            comparisonChartInstance = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [
                        {
                            label: 'Entradas',
                            data: sortedMonths.map(m => monthlyData[m].income),
                            backgroundColor: '#11998e'
                        },
                        {
                            label: 'Despesas',
                            data: sortedMonths.map(m => monthlyData[m].expense),
                            backgroundColor: '#ee0979'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: R$ ${_formatBRL(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => 'R$ ' + _formatBRL(value)
                            }
                        }
                    }
                }
            });
        }
        
    } catch (error) {
        console.error('Erro ao carregar gr√°ficos:', error);
        showToast('Erro ao carregar gr√°ficos', 'error');
    }
}

// Verificar convites pendentes ao carregar p√°gina
document.addEventListener('DOMContentLoaded', async function() {
    checkPendingInvites();
});

// ============================================================================
// LIMPAR WORKSPACE
// ============================================================================

async function clearCurrentWorkspace() {
    const ok = await window._openConfirmModal({
        title: 'Limpar Workspace',
        body: '‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° remover TODAS as transa√ß√µes do workspace atual.\n\nEsta a√ß√£o N√ÉO pode ser desfeita!\n\nDeseja realmente continuar?',
        confirmText: 'Sim, limpar tudo',
        confirmClass: 'btn-danger',
    });
    
    if (!ok) return;
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/workspace/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Workspace limpo com sucesso! Recarregando...', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(result.error || 'Erro ao limpar workspace', 'error');
        }
    } catch (error) {
        console.error('Erro ao limpar workspace:', error);
        showToast('Erro ao limpar workspace', 'error');
    }
}

// ============================================================================
// SISTEMA DE CONVITES
// ============================================================================

async function checkPendingInvites() {
    try {
        const response = await fetch('/gerenciamento-financeiro/api/invites/pending');
        if (!response.ok) {
            console.warn('Failed to check pending invites:', response.status);
            return;
        }
        
        const data = await response.json();
        const badge = document.getElementById('userNotificationBadge');
        const tabBadge = document.getElementById('sharedTabBadge');
        
        if (data.count > 0) {
            // Show notification badge on user email button
            if (badge) {
                badge.style.display = 'inline-flex';
            }
            // Show notification badge on shared tab
            if (tabBadge) {
                tabBadge.style.display = 'inline-flex';
                tabBadge.textContent = data.count;
            }
        } else {
            // Hide notification badge when no invites
            if (badge) {
                badge.style.display = 'none';
            }
            if (tabBadge) {
                tabBadge.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error checking pending invites:', error);
        // On error, hide badge to avoid false positives
        const badge = document.getElementById('userNotificationBadge');
        const tabBadge = document.getElementById('sharedTabBadge');
        if (badge) badge.style.display = 'none';
        if (tabBadge) tabBadge.style.display = 'none';
    }
}

function loadSharedTab() {
    const sharedContent = document.getElementById('sharedContent');
    if (!sharedContent) return;

    sharedContent.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando convites...</span>
            </div>
        </div>
    `;

    // Load pending invites for shared tab
    loadPendingInvitesForSharedTab();
}

async function loadPendingInvitesForSharedTab() {
    const container = document.getElementById('sharedContent');
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/invites/pending');
        const data = await response.json();
        
        if (!response.ok) {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        if (!data.invites || data.invites.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-share fs-1 text-muted d-block mb-3"></i>
                    <h6 class="text-muted">Nenhum convite pendente</h6>
                    <p class="text-muted small">Convites para compartilhar workspaces aparecer√£o aqui</p>
                </div>
            `;
            return;
        }
        
        let html = '<div class="mb-3"><h6 class="fw-semibold">Convites Pendentes</h6></div>';
        data.invites.forEach(invite => {
            const roleLabel = invite.role === 'owner' ? 'Co-propriet√°rio' : 
                             invite.role === 'editor' ? 'Editor' : 'Visualizador';
            html += `
                <div class="card mb-3" style="border-left: 4px solid ${invite.workspace_color || '#3b82f6'};">
                    <div class="card-body">
                        <h6 class="card-title mb-1">
                            <i class="bi bi-folder-fill me-2" style="color: ${invite.workspace_color || '#3b82f6'}"></i>
                            ${invite.workspace_name}
                        </h6>
                        <p class="text-muted small mb-2">
                            <strong>${invite.invited_by.split('@')[0]}</strong> convidou voc√™ como <strong>${roleLabel}</strong>
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm flex-grow-1" onclick="acceptInvite(${invite.id}); loadSharedTab();">
                                <i class="bi bi-check-lg me-1"></i>Aceitar
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="rejectInvite(${invite.id}); loadSharedTab();">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar convites</div>';
        console.error(error);
    }
}

async function showShareModal() {
    const modal = new bootstrap.Modal(document.getElementById('shareWorkspaceModal'));
    modal.show();
    
    // Carregar workspaces do usu√°rio
    const select = document.getElementById('shareWorkspaceSelect');
    select.innerHTML = '<option value="">Carregando...</option>';
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/workspaces');
        const data = await response.json();
        
        let options = '<option value="">Selecione um workspace</option>';
        
        if (data.owned && data.owned.length > 0) {
            data.owned.forEach(ws => {
                options += `<option value="${ws.id}">${ws.name}</option>`;
            });
        }
        
        select.innerHTML = options;
        
        if (!data.owned || data.owned.length === 0) {
            select.innerHTML = '<option value="">Voc√™ n√£o possui workspaces</option>';
        }
    } catch (error) {
        select.innerHTML = '<option value="">Erro ao carregar</option>';
        console.error(error);
    }
}

async function sendInvite() {
    const workspaceId = document.getElementById('shareWorkspaceSelect').value;
    const email = document.getElementById('inviteEmail').value.trim();
    const role = document.getElementById('inviteRole').value;
    
    if (!workspaceId) {
        showToast('Selecione um workspace', 'warning');
        return;
    }
    
    if (!email) {
        showToast('Digite o email do usu√°rio', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/gerenciamento-financeiro/api/workspaces/${workspaceId}/invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, role })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(result.message, 'success');
            document.getElementById('inviteEmail').value = '';
            bootstrap.Modal.getInstance(document.getElementById('shareWorkspaceModal')).hide();
        } else {
            showToast(result.error || 'Erro ao enviar convite', 'error');
        }
    } catch (error) {
        showToast('Erro ao enviar convite', 'error');
        console.error(error);
    }
}

function showPendingInvitesModal() {
    const modal = new bootstrap.Modal(document.getElementById('pendingInvitesModal'));
    modal.show();
    loadPendingInvitesList();
}

async function loadPendingInvitesList() {
    const container = document.getElementById('pendingInvitesList');
    
    try {
        const response = await fetch('/gerenciamento-financeiro/api/invites/pending');
        const data = await response.json();
        
        if (!response.ok) {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        if (!data.invites || data.invites.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-envelope-open fs-1 text-muted d-block mb-2"></i>
                    <p class="text-muted">Nenhum convite pendente</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        data.invites.forEach(invite => {
            const roleLabel = invite.role === 'owner' ? 'Co-propriet√°rio' : 
                             invite.role === 'editor' ? 'Editor' : 'Visualizador';
            html += `
                <div class="card mb-3" style="border-left: 4px solid ${invite.workspace_color || '#3b82f6'};">
                    <div class="card-body">
                        <h6 class="card-title mb-1">
                            <i class="bi bi-folder-fill me-2" style="color: ${invite.workspace_color || '#3b82f6'}"></i>
                            ${invite.workspace_name}
                        </h6>
                        <p class="text-muted small mb-2">
                            <strong>${invite.invited_by.split('@')[0]}</strong> convidou voc√™ como <strong>${roleLabel}</strong>
                        </p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm flex-grow-1" onclick="acceptInvite(${invite.id})">
                                <i class="bi bi-check-lg me-1"></i>Aceitar
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="rejectInvite(${invite.id})">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Erro ao carregar convites</div>';
        console.error(error);
    }
}

async function acceptInvite(inviteId) {
    try {
        const response = await fetch(`/gerenciamento-financeiro/api/invites/${inviteId}/accept`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(result.message, 'success');
            // Fechar modal e recarregar p√°gina para mostrar novo workspace
            bootstrap.Modal.getInstance(document.getElementById('pendingInvitesModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(result.error || 'Erro ao aceitar convite', 'error');
        }
    } catch (error) {
        showToast('Erro ao aceitar convite', 'error');
        console.error(error);
    }
}

async function rejectInvite(inviteId) {
    const ok = await window._openConfirmModal({
        title: 'Recusar convite',
        body: 'Tem certeza que deseja recusar este convite?'
        ,confirmText: 'Recusar'
        ,confirmClass: 'btn-danger'
    });
    if (!ok) return;
    
    try {
        const response = await fetch(`/gerenciamento-financeiro/api/invites/${inviteId}/reject`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Convite recusado', 'info');
            loadPendingInvitesList();
            checkPendingInvites();
        } else {
            showToast(result.error || 'Erro ao recusar convite', 'error');
        }
    } catch (error) {
        showToast('Erro ao recusar convite', 'error');
    }
}

// Fun√ß√µes stub para compatibilidade
function loadPendingInvites() { loadPendingInvitesList(); }
function loadShares() {}
function updateShareTypeOptions() {}
function executeShare() { sendInvite(); }
function acceptInviteAndClose() {}
function createOwnWorkspaceAndClose() {}
function checkFirstAccess() {}
</script>
{% endblock %}
