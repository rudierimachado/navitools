{% extends "base.html" %}

{% block title %}Conversor de Imagens - Grátis{% endblock %}

{% block styles %}
<style>
    .conversor-wrapper {
        padding: 1rem;
        width: 100%;
        margin: 0;
        min-height: calc(100vh - var(--header-height));
    }

    /* Header Compacto */
    .conversor-header {
        background: linear-gradient(135deg, #0ea5e9, #6366f1);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        color: white;
    }

    .conversor-header-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .conversor-icon {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        flex-shrink: 0;
    }

    .conversor-header-text h1 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .conversor-header-text p {
        margin: 0;
        opacity: 0.9;
        font-size: 1rem;
        line-height: 1.4;
    }

    /* Layout Principal */
    .conversor-main-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        align-items: start;
    }

    /* Seção da Ferramenta */
    .conversor-tool-section {
        background: var(--bg-elevated);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--shadow-elevated);
        border: 1px solid var(--border-color);
    }

    /* Seção de Informações */
    .conversor-info-section {
        background: var(--bg-elevated);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--shadow-elevated);
        border: 1px solid var(--border-color);
        height: fit-content;
        position: sticky;
        top: 1rem;
    }

    /* Upload Area */
    .upload-area {
        border: 3px dashed var(--border-color);
        border-radius: 16px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: var(--transition-base);
        background: var(--bg-base);
        margin-bottom: 2rem;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .upload-area:hover {
        border-color: var(--primary);
        background: var(--primary-alpha);
    }

    .upload-area.dragover {
        border-color: var(--primary);
        background: var(--primary-alpha);
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 3rem;
        color: var(--primary);
        margin-bottom: 1rem;
    }

    .upload-text h4 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .upload-text p {
        color: var(--text-secondary);
        margin: 0;
        margin-bottom: 0.5rem;
    }

    /* Formatos */
    .format-selection {
        margin-bottom: 2rem;
    }

    .format-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .format-option {
        background: var(--bg-base);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: var(--transition-base);
        min-height: 44px; /* Touch target */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .format-option:hover {
        border-color: var(--primary);
        background: var(--primary-alpha);
    }

    .format-option.active {
        border-color: var(--primary);
        background: var(--primary-alpha);
    }

    .format-option i {
        font-size: 1.5rem;
        color: var(--primary);
    }

    .format-option span {
        font-weight: 600;
        color: var(--text-primary);
        text-transform: uppercase;
    }

    /* Arquivos Carregados */
    .files-list {
        margin-bottom: 2rem;
        display: none;
    }

    .files-list.show {
        display: block;
    }

    .file-item {
        background: var(--bg-base);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        min-height: 80px;
    }

    .file-preview {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        background: var(--bg-muted);
        flex-shrink: 0;
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        word-break: break-word;
    }

    .file-size {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .file-status {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .file-status.ready {
        background: var(--warning-alpha);
        color: var(--warning);
    }

    .file-status.converting {
        background: var(--primary-alpha);
        color: var(--primary);
    }

    .file-status.completed {
        background: var(--success-alpha);
        color: var(--success);
    }

    /* Botões */
    .btn-convert {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        border-radius: 12px;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-base);
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        min-height: 48px; /* Touch target */
        touch-action: manipulation;
    }

    .btn-convert:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4);
    }

    .btn-convert:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-download-all {
        background: var(--success);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 1rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-base);
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        display: none;
        min-height: 48px; /* Touch target */
        touch-action: manipulation;
    }

    .btn-download-all.show {
        display: flex;
    }

    .btn-download-all:hover {
        background: var(--success-dark);
        transform: translateY(-1px);
    }

    /* Info Section */
    .info-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .info-list li {
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--text-secondary);
    }

    .info-list li:last-child {
        border-bottom: none;
    }

    .info-list i {
        color: var(--primary);
        width: 20px;
        text-align: center;
        flex-shrink: 0;
    }

    /* Progress Bar */
    .progress-container {
        margin: 1rem 0;
        display: none;
    }

    .progress-container.show {
        display: block;
    }

    .progress-bar {
        width: 100%;
        height: 12px;
        background: var(--bg-muted);
        border-radius: 6px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* ========================================
       RESPONSIVE DESIGN - MELHORADO
    ======================================== */
    
    /* Tablet portrait */
    @media (max-width: 968px) {
        .conversor-main-layout {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .conversor-tool-section {
            order: 1;
        }

        .conversor-info-section {
            order: 2;
            position: static;
        }
    }
    
    /* Tablet */
    @media (max-width: 768px) {
        .conversor-wrapper {
            padding: 0.75rem;
        }

        .conversor-header {
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .conversor-header-content {
            gap: 0.75rem;
        }

        .conversor-icon {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }

        .conversor-header-text h1 {
            font-size: 1.5rem;
        }

        .conversor-header-text p {
            font-size: 0.9rem;
        }

        .conversor-tool-section,
        .conversor-info-section {
            padding: 1.5rem;
        }

        .format-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .format-option {
            padding: 0.875rem;
        }

        .upload-area {
            padding: 2.5rem 1.5rem;
            min-height: 140px;
        }

        .upload-icon {
            font-size: 2.5rem;
        }

        .upload-text h4 {
            font-size: 1.1rem;
        }

        .upload-text p {
            font-size: 0.9rem;
        }

        .file-item {
            padding: 0.875rem;
        }

        .file-preview {
            width: 50px;
            height: 50px;
        }
    }
    
    /* Mobile landscape */
    @media (max-width: 640px) {
        .conversor-wrapper {
            padding: 0.5rem;
        }

        .conversor-header {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 12px;
        }

        .conversor-header-text h1 {
            font-size: 1.4rem;
        }

        .conversor-header-text p {
            font-size: 0.85rem;
        }

        .conversor-tool-section,
        .conversor-info-section {
            padding: 1.25rem;
            border-radius: 12px;
        }
        
        .format-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        
        .format-option {
            padding: 0.75rem 0.5rem;
            font-size: 0.9rem;
            min-height: 60px;
        }
        
        .format-option i {
            font-size: 1.25rem;
        }
        
        .upload-area {
            padding: 2rem 1rem;
            min-height: 120px;
            margin-bottom: 1.5rem;
        }
        
        .upload-icon {
            font-size: 2.25rem;
            margin-bottom: 0.75rem;
        }
        
        .upload-text h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .upload-text p {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .upload-text small {
            font-size: 0.75rem;
        }
        
        .file-item {
            padding: 0.75rem;
            min-height: 70px;
        }
        
        .file-preview {
            width: 45px;
            height: 45px;
        }
        
        .file-name {
            font-size: 0.9rem;
        }
        
        .file-size {
            font-size: 0.8rem;
        }
        
        .file-status {
            padding: 0.375rem 0.75rem;
            font-size: 0.7rem;
        }
        
        .btn-convert, .btn-download-all {
            padding: 1rem 1.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
            min-height: 50px;
        }

        .progress-bar {
            height: 10px;
        }

        .progress-text {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    }
    
    /* Mobile portrait */
    @media (max-width: 480px) {
        .conversor-wrapper {
            padding: 0.25rem;
        }

        .conversor-header {
            padding: 0.875rem;
            margin-bottom: 1rem;
        }

        .conversor-header-content {
            gap: 0.5rem;
        }

        .conversor-icon {
            width: 40px;
            height: 40px;
            font-size: 1.25rem;
        }
        
        .conversor-header-text h1 {
            font-size: 1.25rem;
        }
        
        .conversor-header-text p {
            font-size: 0.8rem;
        }

        .conversor-tool-section,
        .conversor-info-section {
            padding: 1rem;
        }
        
        .format-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .format-option {
            padding: 0.625rem 0.375rem;
            font-size: 0.85rem;
            min-height: 55px;
        }
        
        .format-option i {
            font-size: 1.1rem;
        }
        
        .upload-area {
            padding: 1.5rem 0.75rem;
            min-height: 100px;
            margin-bottom: 1.25rem;
        }
        
        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .upload-text h4 {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }
        
        .upload-text p {
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        
        .upload-text small {
            font-size: 0.7rem;
        }
        
        .file-item {
            padding: 0.625rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
            min-height: auto;
        }

        .file-preview {
            width: 50px;
            height: 50px;
            align-self: flex-start;
        }
        
        .file-info {
            width: 100%;
        }
        
        .file-name {
            font-size: 0.9rem;
        }
        
        .file-size {
            font-size: 0.8rem;
        }
        
        .file-status {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
            align-self: flex-start;
        }
        
        .btn-convert, .btn-download-all {
            padding: 0.875rem 1.25rem;
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            min-height: 48px;
        }
        
        .progress-bar {
            height: 8px;
        }
        
        .progress-text {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .info-title {
            font-size: 1.1rem;
        }
        
        .info-list li {
            padding: 0.625rem 0;
            font-size: 0.9rem;
        }

        .info-list i {
            width: 18px;
        }
    }
    
    /* Small mobile */
    @media (max-width: 360px) {
        .conversor-wrapper {
            padding: 0.125rem;
        }

        .conversor-header {
            padding: 0.75rem;
        }

        .conversor-icon {
            width: 35px;
            height: 35px;
            font-size: 1.1rem;
        }
        
        .conversor-header-text h1 {
            font-size: 1.125rem;
        }
        
        .conversor-header-text p {
            font-size: 0.75rem;
        }

        .conversor-tool-section,
        .conversor-info-section {
            padding: 0.875rem;
        }
        
        .format-option {
            padding: 0.5rem 0.25rem;
            font-size: 0.8rem;
            min-height: 50px;
        }
        
        .format-option i {
            font-size: 1rem;
        }
        
        .upload-area {
            padding: 1.25rem 0.5rem;
            min-height: 90px;
        }
        
        .upload-icon {
            font-size: 1.75rem;
        }
        
        .upload-text h4 {
            font-size: 0.875rem;
        }
        
        .upload-text p {
            font-size: 0.75rem;
        }
        
        .upload-text small {
            font-size: 0.65rem;
        }
        
        .file-item {
            padding: 0.5rem;
            gap: 0.5rem;
        }

        .file-preview {
            width: 40px;
            height: 40px;
        }
        
        .file-name {
            font-size: 0.85rem;
        }
        
        .file-size {
            font-size: 0.75rem;
        }
        
        .btn-convert, .btn-download-all {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            min-height: 44px;
        }

        .info-title {
            font-size: 1rem;
        }

        .info-list li {
            padding: 0.5rem 0;
            font-size: 0.85rem;
        }
    }

    /* Touch improvements */
    @media (hover: none) and (pointer: coarse) {
        .format-option:hover,
        .btn-convert:hover,
        .btn-download-all:hover,
        .upload-area:hover {
            transform: none;
        }

        .format-option:active,
        .btn-convert:active,
        .btn-download-all:active {
            transform: scale(0.98);
        }

        .upload-area:active {
            transform: scale(1.01);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="conversor-wrapper">
    <!-- Header Compacto -->
    <div class="conversor-header">
        <div class="conversor-header-content">
            <div class="conversor-icon">
                <i class="fas fa-images"></i>
            </div>
            <div class="conversor-header-text">
                <h1>Conversor de Imagens</h1>
                <p>Converta suas imagens para qualquer formato com alta qualidade</p>
            </div>
        </div>
    </div>

    <!-- Layout Principal: Ferramenta + Informações -->
    <div class="conversor-main-layout">
        <!-- Ferramenta (Lado Esquerdo/Principal) -->
        <div class="conversor-tool-section">
            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary); font-weight: 700;">
                <i class="fas fa-magic" style="color: var(--primary); margin-right: 0.5rem;"></i>
                Converter Imagens
            </h3>

            <!-- Upload Area -->
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    <h4>Arraste suas imagens aqui</h4>
                    <p>ou toque para selecionar arquivos</p>
                    <small style="color: var(--text-muted);">Suporta: JPG, PNG, GIF, BMP, WEBP, TIFF</small>
                </div>
                <input type="file" id="file-input" multiple accept="image/*" style="display: none;">
            </div>

            <!-- Seleção de Formato -->
            <div class="format-selection">
                <label style="font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: block;">
                    <i class="fas fa-file-image" style="color: var(--primary); margin-right: 0.5rem;"></i>
                    Converter para:
                </label>
                <div class="format-grid">
                    <div class="format-option active" data-format="jpg">
                        <i class="fas fa-image"></i>
                        <span>JPG</span>
                    </div>
                    <div class="format-option" data-format="png">
                        <i class="fas fa-image"></i>
                        <span>PNG</span>
                    </div>
                    <div class="format-option" data-format="webp">
                        <i class="fas fa-image"></i>
                        <span>WEBP</span>
                    </div>
                    <div class="format-option" data-format="gif">
                        <i class="fas fa-image"></i>
                        <span>GIF</span>
                    </div>
                    <div class="format-option" data-format="bmp">
                        <i class="fas fa-image"></i>
                        <span>BMP</span>
                    </div>
                    <div class="format-option" data-format="tiff">
                        <i class="fas fa-image"></i>
                        <span>TIFF</span>
                    </div>
                    <div class="format-option" data-format="pdf">
                        <i class="fas fa-file-pdf"></i>
                        <span>PDF</span>
                    </div>
                </div>
            </div>

            <!-- Lista de Arquivos -->
            <div class="files-list" id="files-list">
                <h4 style="color: var(--text-primary); margin-bottom: 1rem;">
                    <i class="fas fa-list" style="color: var(--primary); margin-right: 0.5rem;"></i>
                    Arquivos Selecionados
                </h4>
                <div id="files-container"></div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" id="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Convertendo... 0%</div>
            </div>

            <!-- Botões -->
            <button class="btn-convert" id="convert-btn" disabled>
                <i class="fas fa-magic"></i>
                Converter Imagens
            </button>

            <button class="btn-download-all" id="download-all-btn">
                <i class="fas fa-download"></i>
                Baixar Todas as Imagens
            </button>
        </div>

        <!-- Informações (Lado Direito) -->
        <div class="conversor-info-section">
            <h4 class="info-title">
                <i class="fas fa-info-circle"></i>
                Sobre o Conversor
            </h4>
            <ul class="info-list">
                <li>
                    <i class="fas fa-bolt"></i>
                    Conversão instantânea e automática
                </li>
                <li>
                    <i class="fas fa-palette"></i>
                    Suporte a todos os formatos modernos
                </li>
                <li>
                    <i class="fas fa-compress"></i>
                    Otimização automática de tamanho
                </li>
                <li>
                    <i class="fas fa-shield-alt"></i>
                    Processamento seguro no navegador
                </li>
                <li>
                    <i class="fas fa-cloud"></i>
                    Sem upload para servidores (exceto PDF)
                </li>
                <li>
                    <i class="fas fa-download"></i>
                    Download individual ou em lote
                </li>
            </ul>

            <div style="margin-top: 2rem; padding: 1rem; background: var(--primary-alpha); border-radius: 8px;">
                <h6 style="color: var(--primary); margin-bottom: 0.5rem; font-weight: 600;">
                    <i class="fas fa-lightbulb"></i>
                    Dica
                </h6>
                <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                    Para melhor qualidade, use PNG para imagens com transparência e JPG para fotos. WEBP oferece o melhor equilíbrio entre qualidade e tamanho! Para documentos, use PDF.
                </p>
            </div>
        </div>
    </div>
</div>

{% set tool_key = 'images' %}
{% include 'tool_sections.html' %}

<script>
    // Variáveis globais
    let selectedFiles = [];
    let currentFormat = 'jpg';
    let convertedFiles = [];

    // Elementos DOM
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const filesList = document.getElementById('files-list');
    const filesContainer = document.getElementById('files-container');
    const formatOptions = document.querySelectorAll('.format-option');
    const convertBtn = document.getElementById('convert-btn');
    const downloadAllBtn = document.getElementById('download-all-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');

    // Event listeners
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);
    convertBtn.addEventListener('click', convertImages);
    downloadAllBtn.addEventListener('click', downloadAll);

    // Touch events for mobile
    uploadArea.addEventListener('touchstart', (e) => {
        e.preventDefault();
        fileInput.click();
    }, { passive: false });

    // Seleção de formato
    formatOptions.forEach(option => {
        option.addEventListener('click', () => {
            formatOptions.forEach(opt => opt.classList.remove('active'));
            option.classList.add('active');
            currentFormat = option.dataset.format;
        });
    });

    // Drag and drop handlers
    function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
        addFiles(files);
    }

    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        addFiles(files);
    }

    // Add files to the list
    function addFiles(files) {
        selectedFiles = [...selectedFiles, ...files];
        updateFilesList();
        updateConvertButton();
    }

    // Update files list display
    function updateFilesList() {
        if (selectedFiles.length === 0) {
            filesList.classList.remove('show');
            return;
        }

        filesList.classList.add('show');
        filesContainer.innerHTML = '';

        selectedFiles.forEach((file) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const preview = document.createElement('img');
            preview.className = 'file-preview';
            preview.src = URL.createObjectURL(file);
            preview.onerror = () => {
                preview.style.display = 'none';
            };
            
            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            
            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            fileName.textContent = file.name;
            
            const fileSize = document.createElement('div');
            fileSize.className = 'file-size';
            fileSize.textContent = formatFileSize(file.size);
            
            const fileStatus = document.createElement('div');
            fileStatus.className = 'file-status ready';
            fileStatus.textContent = 'Pronto';
            
            fileInfo.appendChild(fileName);
            fileInfo.appendChild(fileSize);
            
            fileItem.appendChild(preview);
            fileItem.appendChild(fileInfo);
            fileItem.appendChild(fileStatus);
            
            filesContainer.appendChild(fileItem);
        });
    }

    // Update convert button state
    function updateConvertButton() {
        convertBtn.disabled = selectedFiles.length === 0;
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Convert images
    async function convertImages() {
        if (selectedFiles.length === 0) return;
        
        convertBtn.disabled = true;
        convertBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Convertendo...';
        progressContainer.classList.add('show');
        convertedFiles = [];

        const statusElements = document.querySelectorAll('.file-status');

        // Para PDF usamos o backend (Flask), pois o navegador não gera PDF nativamente
        if (currentFormat === 'pdf') {
            try {
                statusElements.forEach(el => {
                    el.className = 'file-status converting';
                    el.textContent = 'Convertendo...';
                });

                await convertImagesServerSide('pdf');

                statusElements.forEach(el => {
                    el.className = 'file-status completed';
                    el.textContent = 'Concluído';
                });

                progressFill.style.width = '100%';
                progressText.textContent = 'Conversão concluída!';
                downloadAllBtn.classList.add('show');
            } catch (error) {
                console.error('Erro na conversão para PDF:', error);
                statusElements.forEach(el => {
                    el.className = 'file-status error';
                    el.textContent = 'Erro';
                });
                progressText.textContent = 'Erro na conversão.';
            }

            convertBtn.innerHTML = '<i class="fas fa-check"></i> Conversão Finalizada';
            setTimeout(() => {
                convertBtn.disabled = false;
                convertBtn.innerHTML = '<i class="fas fa-magic"></i> Converter Imagens';
            }, 2000);

            return;
        }

        // Fluxo original para formatos de imagem (canvas no navegador)
        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            const statusElement = statusElements[i];

            statusElement.className = 'file-status converting';
            statusElement.textContent = 'Convertendo...';

            try {
                const convertedFile = await convertFile(file, currentFormat);
                convertedFiles.push(convertedFile);

                statusElement.className = 'file-status completed';
                statusElement.textContent = 'Concluído';
            } catch (error) {
                console.error('Erro na conversão:', error);
                statusElement.className = 'file-status error';
                statusElement.textContent = 'Erro';
            }

            const progress = ((i + 1) / selectedFiles.length) * 100;
            progressFill.style.width = progress + '%';
            progressText.textContent = `Convertendo... ${Math.round(progress)}%`;
        }

        convertBtn.innerHTML = '<i class="fas fa-check"></i> Conversão Concluída!';
        progressText.textContent = 'Conversão concluída!';
        downloadAllBtn.classList.add('show');

        setTimeout(() => {
            convertBtn.disabled = false;
            convertBtn.innerHTML = '<i class="fas fa-magic"></i> Converter Imagens';
        }, 2000);
    }

    // Conversão via backend (usado para PDF)
    async function convertImagesServerSide(format) {
        const formData = new FormData();

        selectedFiles.forEach(file => {
            formData.append('files[]', file);
        });

        formData.append('format', format || currentFormat);
        formData.append('quality', '85');

        const response = await fetch('/conversor-imagens/upload', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('Falha na requisição ao servidor');
        }

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Erro ao converter no servidor');
        }

        return data;
    }

    // Convert single file (canvas)
    function convertFile(file, format) {
        return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const mimeType = `image/${format === 'jpg' ? 'jpeg' : format}`;
                const quality = format === 'jpg' ? 0.9 : undefined;
                
                canvas.toBlob((blob) => {
                    if (blob) {
                        const fileName = file.name.replace(/\.[^/.]+$/, `.${format}`);
                        resolve({
                            blob: blob,
                            name: fileName,
                            originalName: file.name
                        });
                    } else {
                        reject(new Error('Falha na conversão'));
                    }
                }, mimeType, quality);
            };
            
            img.onerror = () => reject(new Error('Falha ao carregar imagem'));
            img.src = URL.createObjectURL(file);
        });
    }

    // Download all files
    function downloadAll() {
        // Para PDF usamos o ZIP gerado no servidor
        if (currentFormat === 'pdf') {
            window.location.href = '/conversor-imagens/download-all';
            return;
        }

        if (convertedFiles.length === 0) return;

        convertedFiles.forEach((file, index) => {
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(file.blob);
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }, index * 100);
        });
    }

    // Prevent zoom on double tap for iOS
    document.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    }, { passive: false });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
</script>
{% endblock %}